# Ride Booking Flow - Uber/Rapido (HLD)

## Table of Contents
1. [Problem Statement & Requirements](#1-problem-statement--requirements)
2. [High-Level Architecture](#2-high-level-architecture)
3. [Component Architecture](#3-component-architecture)
4. [Data Flow](#4-data-flow)
5. [API Design & Communication Protocols](#5-api-design--communication-protocols)
6. [Database Design](#6-database-design)
7. [Caching Strategy](#7-caching-strategy)
8. [State Management](#8-state-management)
9. [Performance Optimization](#9-performance-optimization)
10. [Error Handling & Edge Cases](#10-error-handling--edge-cases)
11. [Interview Cross-Questions](#11-interview-cross-questions)
12. [Accessibility (a11y)](#12-accessibility-a11y)
13. [Security & Safety Features](#13-security--safety-features)
14. [Mobile & Touch Interactions](#14-mobile--touch-interactions)
15. [Testing Strategy](#15-testing-strategy)
16. [Offline/PWA Capabilities](#16-offlinepwa-capabilities)
17. [Maps Deep Dive](#17-maps-deep-dive)
18. [Internationalization (i18n)](#18-internationalization-i18n)
19. [Analytics & Monitoring](#19-analytics--monitoring)
20. [Notification System](#20-notification-system)
21. [Payment Integration Deep Dive](#21-payment-integration-deep-dive)

---

## 1. Problem Statement & Requirements

### Functional Requirements
- Location input (pickup & drop) with autocomplete
- Real-time map with driver locations
- Ride type selection (Auto, Bike, Car, Premium)
- Fare estimation before booking
- Real-time driver matching
- Driver tracking during ride
- Payment integration
- Ride history
- Ratings and reviews
- Cancel/modify ride

### Non-Functional Requirements
- **Latency**: Fare estimate < 500ms, driver match < 5s
- **Availability**: 99.99% uptime
- **Scalability**: Handle 10M concurrent requests
- **Real-time**: Driver location updates every 3-5 seconds
- **Consistency**: Payment must be strongly consistent

### Capacity Estimation
```
Daily Active Users: 50 million
Rides per day: 20 million
Peak concurrent ride requests: 500,000
Driver location updates: 50 updates/driver/min
Total drivers online: 5 million
Location updates per second: 4 million
WebSocket connections: 10 million (users + drivers)
```

---

## 2. High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Rider App     â”‚  â”‚   Driver App    â”‚  â”‚     Web App     â”‚             â”‚
â”‚  â”‚   (Mobile)      â”‚  â”‚   (Mobile)      â”‚  â”‚   (React)       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                    â”‚                    â”‚                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â”‚ WebSocket â”‚ HTTPS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚           â”‚
                          â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EDGE LAYER                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Load Balancer (L7)                                â”‚   â”‚
â”‚  â”‚   â€¢ SSL Termination  â€¢ Geographic Routing  â€¢ Rate Limiting          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   REST API      â”‚      â”‚   WebSocket     â”‚      â”‚   Location      â”‚
â”‚   Gateway       â”‚      â”‚   Gateway       â”‚      â”‚   Service       â”‚
â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚
â”‚ â€¢ Auth          â”‚      â”‚ â€¢ Real-time     â”‚      â”‚ â€¢ Driver pos    â”‚
â”‚ â€¢ Booking       â”‚      â”‚   tracking      â”‚      â”‚ â€¢ ETA calc      â”‚
â”‚ â€¢ Payments      â”‚      â”‚ â€¢ Notifications â”‚      â”‚ â€¢ Geo queries   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CORE SERVICES                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Matching      â”‚   Pricing       â”‚   Trip          â”‚   Payment             â”‚
â”‚   Service       â”‚   Service       â”‚   Service       â”‚   Service             â”‚
â”‚                 â”‚                 â”‚                 â”‚                       â”‚
â”‚ â€¢ Find nearby   â”‚ â€¢ Fare calc     â”‚ â€¢ Trip CRUD     â”‚ â€¢ Charge user         â”‚
â”‚   drivers       â”‚ â€¢ Surge pricing â”‚ â€¢ Status mgmt   â”‚ â€¢ Pay driver          â”‚
â”‚ â€¢ Optimal match â”‚ â€¢ Promo codes   â”‚ â€¢ History       â”‚ â€¢ Refunds             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA LAYER                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚     Redis       â”‚  â”‚   Kafka         â”‚             â”‚
â”‚  â”‚   (Trips, Users)â”‚  â”‚   (Geo, Cache)  â”‚  â”‚   (Events)      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Cassandra     â”‚  â”‚   Elasticsearch â”‚  â”‚    S3           â”‚             â”‚
â”‚  â”‚   (Location     â”‚  â”‚   (Search)      â”‚  â”‚   (Receipts)    â”‚             â”‚
â”‚  â”‚    History)     â”‚  â”‚                 â”‚  â”‚                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ride Booking State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RIDE STATE MACHINE                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    request    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚   â”‚   IDLE   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  SEARCHING    â”‚                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  FOR DRIVER   â”‚                             â”‚
â”‚        â–²                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚        â”‚                             â”‚                                       â”‚
â”‚        â”‚ cancel                      â”‚ driver_found                         â”‚
â”‚        â”‚                             â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    timeout    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚   â”‚ CANCELLEDâ”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   MATCHED     â”‚                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚               â”‚                             â”‚
â”‚        â–²                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚        â”‚                             â”‚                                       â”‚
â”‚        â”‚ cancel                      â”‚ driver_arrives                       â”‚
â”‚        â”‚                             â–¼                                       â”‚
â”‚        â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  DRIVER EN    â”‚                             â”‚
â”‚        â”‚                     â”‚  ROUTE TO     â”‚                             â”‚
â”‚        â”‚                     â”‚  PICKUP       â”‚                             â”‚
â”‚        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚        â”‚                             â”‚                                       â”‚
â”‚        â”‚ no_show                     â”‚ picked_up                            â”‚
â”‚        â”‚                             â–¼                                       â”‚
â”‚        â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â”‚                     â”‚  IN PROGRESS  â”‚                             â”‚
â”‚        â”‚                     â”‚  (RIDING)     â”‚                             â”‚
â”‚        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚        â”‚                             â”‚                                       â”‚
â”‚        â”‚                             â”‚ dropped_off                          â”‚
â”‚        â”‚                             â–¼                                       â”‚
â”‚        â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    payment    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚        â”‚                     â”‚  AWAITING     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ COMPLETED â”‚ â”‚
â”‚        â”‚                     â”‚  PAYMENT      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚        â”‚                             â”‚                                       â”‚
â”‚        â”‚                             â”‚ payment_failed                       â”‚
â”‚        â”‚                             â–¼                                       â”‚
â”‚        â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   DISPUTED    â”‚                             â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Component Architecture

### Frontend Component Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              RideApp                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                            MapView                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ ğŸš—  â”‚  Driver markers (real-time)             â”‚ ğŸš— ğŸï¸ ğŸ›º â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”˜                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                    ğŸ“ Pickup Pin                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚ Route line                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                    ğŸ¯ Drop Pin                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚                 CurrentLocationButton                     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚                        ğŸ“                                 â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      BottomSheet (Draggable)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE: LOCATION_INPUT                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ“ Pickup: [Current Location            ]  ğŸ¤              â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ¯ Drop:   [Search destination...       ]  ğŸ¤              â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Recent Searches / Saved Places                             â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ  Home    ğŸ¢ Work    â˜… Saved                               â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE: RIDE_SELECTION                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ RideOptionCard (Selected)                                  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚ ğŸ›º     â”‚  UberAuto   â”‚  â‚¹85-95   â”‚  3 min away        â”‚â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ RideOptionCard                                              â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚ ğŸï¸     â”‚  UberMoto   â”‚  â‚¹45-55   â”‚  2 min away        â”‚â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ RideOptionCard                                              â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚ ğŸš—     â”‚  UberGo     â”‚  â‚¹120-140 â”‚  5 min away        â”‚â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚        ğŸ’³  Payment: Paytm â–¼      [Book UberAuto]          â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE: SEARCHING_DRIVER                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                    ğŸ”„ Finding your ride...                 â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                    â”â”â”â”â”â”â”â”â”â” 45%                          â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                    [Cancel Request]                        â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE: DRIVER_MATCHED                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ DriverCard                                                  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚ ğŸ‘¤     â”‚  Rajesh K.  â”‚  â­ 4.8   â”‚  KA-01-AB-1234     â”‚â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚ Avatar â”‚  Honda Activa (White)  â”‚  Arriving in 3 min  â”‚â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ OTP: 4 5 2 1                                               â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ [ğŸ“ Call]  [ğŸ’¬ Chat]  [âŒ Cancel]                          â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE: RIDE_IN_PROGRESS                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  ğŸ“ â†’ ğŸ¯   ETA: 15 min   â”‚   Distance: 5.2 km            â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Share Trip  â”‚  Emergency SOS  â”‚  Reroute                 â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Component Responsibilities

| Component | Responsibility |
|-----------|---------------|
| `MapView` | Google Maps integration, driver markers, route display |
| `LocationInput` | Autocomplete, recent searches, saved places |
| `RideOptionCard` | Display ride type, price estimate, ETA |
| `DriverCard` | Driver info, vehicle details, OTP display |
| `TripTracker` | Real-time location updates, ETA countdown |
| `BottomSheet` | State-based UI container (draggable) |

---

## 4. Data Flow

### Ride Booking Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rider   â”‚     â”‚    UI    â”‚     â”‚   API    â”‚     â”‚ Matching â”‚     â”‚  Driver  â”‚
â”‚          â”‚     â”‚          â”‚     â”‚  Gateway â”‚     â”‚ Service  â”‚     â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 1. Enter       â”‚                â”‚                â”‚                â”‚
     â”‚    locations   â”‚                â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 2. Fetch fare  â”‚                â”‚                â”‚
     â”‚                â”‚    estimates   â”‚                â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚  (Fare options)â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 3. See options â”‚                â”‚                â”‚                â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 4. Select &    â”‚                â”‚                â”‚                â”‚
     â”‚    Book        â”‚                â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 5. POST        â”‚                â”‚                â”‚
     â”‚                â”‚    /rides      â”‚                â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 6. Find nearby â”‚                â”‚
     â”‚                â”‚                â”‚    drivers     â”‚                â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 7. Query Redis â”‚
     â”‚                â”‚                â”‚                â”‚    GEORADIUS   â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 8. Notify      â”‚
     â”‚                â”‚                â”‚                â”‚    drivers     â”‚
     â”‚                â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                â”‚                â”‚    (WebSocket) â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚                â”‚ 9. Driver      â”‚
     â”‚                â”‚                â”‚                â”‚    accepts     â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                â”‚ 10. Match      â”‚                â”‚
     â”‚                â”‚                â”‚     confirmed  â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚ 11. WS: driver â”‚                â”‚                â”‚
     â”‚                â”‚     assigned   â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 12. See driver â”‚                â”‚                â”‚                â”‚
     â”‚     details    â”‚                â”‚                â”‚                â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
```

### Real-Time Driver Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DRIVER LOCATION UPDATE FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Driver App                  Location Service              Rider App       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚        â”‚                            â”‚                           â”‚           â”‚
â”‚   Every 3-5 sec                     â”‚                           â”‚           â”‚
â”‚        â”‚                            â”‚                           â”‚           â”‚
â”‚   â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ WS: location_update â”€â”€>â”‚                           â”‚           â”‚
â”‚        â”‚    { lat, lng, heading,    â”‚                           â”‚           â”‚
â”‚        â”‚      speed, timestamp }    â”‚                           â”‚           â”‚
â”‚        â”‚                            â”‚                           â”‚           â”‚
â”‚        â”‚                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Update Redis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚   GEOADD drivers:active   â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚   {lng} {lat} {driver_id} â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚                           â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚   If driver has active    â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚   ride, publish to rider  â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚                           â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚â”€â”€â”€â”€ WS: driver_location â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚        â”‚                   â”‚        â”‚    { lat, lng, eta }      â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚                           â”‚           â”‚
â”‚        â”‚                   â”‚        â”‚                    Update map marker  â”‚
â”‚        â”‚                   â”‚        â”‚                    Recalculate ETA    â”‚
â”‚        â”‚                   â”‚        â”‚                           â”‚           â”‚
â”‚                                                                              â”‚
â”‚   Batching Strategy:                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   â€¢ Collect updates for 1 second                                            â”‚
â”‚   â€¢ Batch write to Redis                                                    â”‚
â”‚   â€¢ Publish to subscribers                                                  â”‚
â”‚   â€¢ Reduces write load by 3-5x                                              â”‚
â”‚                                                                              â”‚
â”‚   Compression:                                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚   â€¢ Send delta from last position (not full coordinates)                   â”‚
â”‚   â€¢ Binary protocol for mobile (Protocol Buffers)                          â”‚
â”‚   â€¢ Reduce bandwidth by 60%                                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Driver Matching Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DRIVER MATCHING ALGORITHM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Step 1: Find Nearby Drivers                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  GEORADIUS drivers:active:{city} {pickup_lng} {pickup_lat} 3 km    â”‚  â”‚
â”‚   â”‚  WITHDIST WITHCOORD COUNT 50                                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   Returns: List of (driver_id, distance, lat, lng)                         â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Step 2: Filter Eligible Drivers                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚   â€¢ Ride type matches (Auto, Bike, Car)                                    â”‚
â”‚   â€¢ Driver is online and available                                          â”‚
â”‚   â€¢ Not already on another ride                                             â”‚
â”‚   â€¢ Rating above threshold                                                  â”‚
â”‚   â€¢ Not blocked by rider                                                    â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Step 3: Score Drivers                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  score = w1 * (1/distance)        // Closer is better              â”‚  â”‚
â”‚   â”‚        + w2 * acceptance_rate     // Higher acceptance preferred   â”‚  â”‚
â”‚   â”‚        + w3 * rating              // Higher rating preferred       â”‚  â”‚
â”‚   â”‚        + w4 * recent_trips        // Active drivers preferred      â”‚  â”‚
â”‚   â”‚        - w5 * cancellation_rate   // Lower cancellation preferred  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚  Weights: w1=0.4, w2=0.2, w3=0.2, w4=0.1, w5=0.1                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Step 4: Broadcast to Top N Drivers                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚   â€¢ Send ride request to top 5-10 drivers simultaneously                  â”‚
â”‚   â€¢ First to accept wins                                                    â”‚
â”‚   â€¢ Use distributed lock for fairness                                      â”‚
â”‚                                                                              â”‚
â”‚   Alternative: Sequential Offering                                          â”‚
â”‚   â€¢ Offer to best match first                                              â”‚
â”‚   â€¢ Timeout after 15 seconds                                               â”‚
â”‚   â€¢ Move to next driver                                                     â”‚
â”‚   â€¢ Better driver quality, longer wait                                     â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Step 5: Confirm Match                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚   â€¢ Atomic operation: SETNX ride:{id}:driver {driver_id}                  â”‚
â”‚   â€¢ Prevent double-booking                                                  â”‚
â”‚   â€¢ Notify rider via WebSocket                                              â”‚
â”‚   â€¢ Update driver status to "on_trip"                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. API Design & Communication Protocols

### Protocol Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROTOCOL COMPARISON FOR RIDE BOOKING                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Protocol     â”‚     Pros      â”‚     Cons      â”‚     Use Case              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Cacheable   â”‚ â€¢ No push     â”‚ â€¢ Fare estimates          â”‚
â”‚    REST         â”‚ â€¢ Simple      â”‚ â€¢ Polling     â”‚ â€¢ Ride history            â”‚
â”‚                 â”‚ â€¢ Stateless   â”‚   required    â”‚ â€¢ User profile            â”‚
â”‚                 â”‚               â”‚               â”‚ â€¢ Payments                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Bi-direct   â”‚ â€¢ Connection  â”‚ â€¢ âœ… Driver location      â”‚
â”‚   WebSocket     â”‚ â€¢ Real-time   â”‚   overhead    â”‚ â€¢ âœ… Ride status updates  â”‚
â”‚                 â”‚ â€¢ Low latency â”‚ â€¢ Scaling     â”‚ â€¢ âœ… Driver matching      â”‚
â”‚                 â”‚               â”‚               â”‚ â€¢ âœ… Notifications         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ One-way     â”‚ â€¢ Can't send  â”‚ â€¢ Notifications (fallback)â”‚
â”‚    SSE          â”‚   server push â”‚   to server   â”‚ â€¢ NOT for location        â”‚
â”‚                 â”‚ â€¢ Simple      â”‚               â”‚   (need bi-directional)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Works when  â”‚ â€¢ Wasteful    â”‚ â€¢ âŒ NOT for location     â”‚
â”‚  Long Polling   â”‚   WS blocked  â”‚ â€¢ High latencyâ”‚ â€¢ Fallback only           â”‚
â”‚                 â”‚               â”‚ â€¢ Server load â”‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Efficient   â”‚ â€¢ No browser  â”‚ â€¢ Driver app â†” Server    â”‚
â”‚    gRPC         â”‚ â€¢ Streaming   â”‚   support     â”‚ â€¢ Backend services        â”‚
â”‚                 â”‚ â€¢ Type-safe   â”‚               â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why WebSocket for Location Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WEBSOCKET vs POLLING FOR LOCATION TRACKING                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Scenario: Track driver during 15-minute ride                               â”‚
â”‚  Updates needed: Every 3 seconds = 300 updates                              â”‚
â”‚                                                                              â”‚
â”‚  POLLING (REST every 3 seconds):                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â€¢ 300 HTTP requests                                                        â”‚
â”‚  â€¢ Each: TCP handshake + TLS + HTTP headers                                â”‚
â”‚  â€¢ Bandwidth: ~150 KB (500 bytes Ã— 300)                                    â”‚
â”‚  â€¢ Server load: 300 request/response cycles                                â”‚
â”‚  â€¢ Latency: Up to 3 seconds delay                                          â”‚
â”‚                                                                              â”‚
â”‚  WEBSOCKET:                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  â€¢ 1 connection for entire ride                                             â”‚
â”‚  â€¢ 300 small messages (~50 bytes each)                                     â”‚
â”‚  â€¢ Bandwidth: ~15 KB                                                        â”‚
â”‚  â€¢ Server: Single connection, push model                                   â”‚
â”‚  â€¢ Latency: < 100ms                                                         â”‚
â”‚                                                                              â”‚
â”‚  Savings: 90% bandwidth, 10x lower latency                                 â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Additional Benefits of WebSocket for Ride:                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ Driver can send location (bi-directional)                               â”‚
â”‚  â€¢ Instant ride status updates                                             â”‚
â”‚  â€¢ Real-time cancellation notification                                     â”‚
â”‚  â€¢ OTP verification without polling                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### REST API Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REST API DESIGN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LOCATION & AUTOCOMPLETE                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  GET /api/v1/places/autocomplete                                            â”‚
â”‚      ?query=airport&lat=12.9&lng=77.6&sessionToken=xxx                     â”‚
â”‚      â†’ Returns: { predictions: [...] }                                     â”‚
â”‚                                                                              â”‚
â”‚  GET /api/v1/places/:placeId                                                â”‚
â”‚      â†’ Returns: { lat, lng, address, name }                                â”‚
â”‚                                                                              â”‚
â”‚  GET /api/v1/geocode/reverse                                                â”‚
â”‚      ?lat=12.9&lng=77.6                                                    â”‚
â”‚      â†’ Returns: { address, placeId }                                       â”‚
â”‚                                                                              â”‚
â”‚  FARE ESTIMATION                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  POST /api/v1/rides/estimate                                                â”‚
â”‚      Body: { pickup: {lat, lng}, drop: {lat, lng} }                        â”‚
â”‚      â†’ Returns:                                                             â”‚
â”‚        {                                                                     â”‚
â”‚          "options": [                                                       â”‚
â”‚            {                                                                 â”‚
â”‚              "type": "auto",                                                â”‚
â”‚              "fareRange": { "min": 85, "max": 95 },                        â”‚
â”‚              "eta": 3,    // minutes to pickup                             â”‚
â”‚              "duration": 15,  // trip duration                             â”‚
â”‚              "distance": 5.2, // km                                        â”‚
â”‚              "surge": 1.2     // multiplier                                â”‚
â”‚            }                                                                 â”‚
â”‚          ]                                                                   â”‚
â”‚        }                                                                     â”‚
â”‚                                                                              â”‚
â”‚  RIDE BOOKING                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  POST /api/v1/rides                                                         â”‚
â”‚      Body: {                                                                 â”‚
â”‚        pickup: { lat, lng, address },                                      â”‚
â”‚        drop: { lat, lng, address },                                        â”‚
â”‚        rideType: "auto",                                                   â”‚
â”‚        paymentMethod: "wallet"                                             â”‚
â”‚      }                                                                       â”‚
â”‚      â†’ Returns: { rideId, status: "searching" }                            â”‚
â”‚                                                                              â”‚
â”‚  GET /api/v1/rides/:rideId                                                  â”‚
â”‚      â†’ Returns: Full ride details with driver info                         â”‚
â”‚                                                                              â”‚
â”‚  POST /api/v1/rides/:rideId/cancel                                          â”‚
â”‚      Body: { reason: "..." }                                               â”‚
â”‚                                                                              â”‚
â”‚  POST /api/v1/rides/:rideId/rate                                            â”‚
â”‚      Body: { rating: 5, feedback: "..." }                                  â”‚
â”‚                                                                              â”‚
â”‚  RIDE HISTORY                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  GET /api/v1/rides?status=completed&cursor=xxx&limit=20                    â”‚
â”‚                                                                              â”‚
â”‚  PAYMENTS                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                                    â”‚
â”‚  GET  /api/v1/payment-methods                                               â”‚
â”‚  POST /api/v1/payment-methods                                               â”‚
â”‚  POST /api/v1/rides/:rideId/pay                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket Events

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WEBSOCKET EVENT SCHEMA                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Connection:                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚  wss://api.ride.com/ws?token=JWT&role=rider                                â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  RIDER â† SERVER EVENTS:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                              â”‚
â”‚  // Driver found                                                            â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "driver_matched",                                                â”‚
â”‚    "rideId": "ride_123",                                                    â”‚
â”‚    "driver": {                                                              â”‚
â”‚      "id": "driver_456",                                                    â”‚
â”‚      "name": "Rajesh K.",                                                   â”‚
â”‚      "phone": "+91XXXXXX1234",                                              â”‚
â”‚      "rating": 4.8,                                                         â”‚
â”‚      "vehicle": {                                                           â”‚
â”‚        "model": "Honda Activa",                                             â”‚
â”‚        "color": "White",                                                    â”‚
â”‚        "plate": "KA-01-AB-1234"                                             â”‚
â”‚      },                                                                      â”‚
â”‚      "location": { "lat": 12.9, "lng": 77.6 }                              â”‚
â”‚    },                                                                        â”‚
â”‚    "otp": "4521",                                                           â”‚
â”‚    "eta": 3                                                                 â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Driver location update (every 3s during approach/trip)                 â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "driver_location",                                               â”‚
â”‚    "rideId": "ride_123",                                                    â”‚
â”‚    "location": { "lat": 12.91, "lng": 77.61, "heading": 45 },              â”‚
â”‚    "eta": 2,                                                                â”‚
â”‚    "distanceRemaining": 0.5  // km                                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Ride status updates                                                     â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "ride_status",                                                   â”‚
â”‚    "rideId": "ride_123",                                                    â”‚
â”‚    "status": "driver_arrived" | "trip_started" | "trip_completed",         â”‚
â”‚    "timestamp": "2024-12-22T10:30:00Z"                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Cancellation                                                            â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "ride_cancelled",                                                â”‚
â”‚    "rideId": "ride_123",                                                    â”‚
â”‚    "cancelledBy": "driver",                                                 â”‚
â”‚    "reason": "Vehicle breakdown"                                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  DRIVER â† SERVER EVENTS:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                              â”‚
â”‚  // New ride request                                                        â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "ride_request",                                                  â”‚
â”‚    "rideId": "ride_123",                                                    â”‚
â”‚    "pickup": { "lat": 12.9, "lng": 77.6, "address": "..." },               â”‚
â”‚    "drop": { "lat": 12.95, "lng": 77.65, "address": "..." },               â”‚
â”‚    "fareEstimate": 85,                                                      â”‚
â”‚    "distance": 5.2,                                                         â”‚
â”‚    "timeout": 15  // seconds to respond                                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  DRIVER â†’ SERVER EVENTS:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                              â”‚
â”‚  // Accept ride                                                             â”‚
â”‚  { "type": "accept_ride", "rideId": "ride_123" }                           â”‚
â”‚                                                                              â”‚
â”‚  // Decline ride                                                            â”‚
â”‚  { "type": "decline_ride", "rideId": "ride_123" }                          â”‚
â”‚                                                                              â”‚
â”‚  // Location update                                                         â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "location_update",                                               â”‚
â”‚    "lat": 12.91,                                                            â”‚
â”‚    "lng": 77.61,                                                            â”‚
â”‚    "heading": 45,                                                           â”‚
â”‚    "speed": 30  // km/h                                                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Status updates                                                          â”‚
â”‚  { "type": "arrived_pickup", "rideId": "ride_123" }                        â”‚
â”‚  { "type": "start_trip", "rideId": "ride_123", "otp": "4521" }             â”‚
â”‚  { "type": "end_trip", "rideId": "ride_123" }                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Database Design

### SQL vs NoSQL Decision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE CHOICE RATIONALE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     PostgreSQL (Transactional Data)                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Users (riders, drivers)                                          â”‚   â”‚
â”‚  â”‚  â€¢ Rides (booking records)                                          â”‚   â”‚
â”‚  â”‚  â€¢ Payments (ACID required)                                         â”‚   â”‚
â”‚  â”‚  â€¢ Ratings & reviews                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Vehicles                                                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  WHY SQL:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ ACID for payments (can't double-charge)                          â”‚   â”‚
â”‚  â”‚  â€¢ Complex queries (ride history, analytics)                        â”‚   â”‚
â”‚  â”‚  â€¢ Strong consistency for bookings                                  â”‚   â”‚
â”‚  â”‚  â€¢ Relational data (rider â†” rides â†” driver)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Redis (Real-time + Geo)                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Driver locations (GEOADD, GEORADIUS)                             â”‚   â”‚
â”‚  â”‚  â€¢ Driver availability status                                       â”‚   â”‚
â”‚  â”‚  â€¢ Session management                                                â”‚   â”‚
â”‚  â”‚  â€¢ Rate limiting                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Distributed locks (ride matching)                                â”‚   â”‚
â”‚  â”‚  â€¢ Pub/Sub for real-time updates                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Data Structures:                                                    â”‚   â”‚
â”‚  â”‚  â€¢ GEO: drivers:active:{city}                                       â”‚   â”‚
â”‚  â”‚  â€¢ HASH: driver:{id}:status                                         â”‚   â”‚
â”‚  â”‚  â€¢ STRING: ride:{id}:driver (distributed lock)                      â”‚   â”‚
â”‚  â”‚  â€¢ PUBSUB: ride:{id} (status updates)                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  WHY Redis for Geo:                                                  â”‚   â”‚
â”‚  â”‚  â€¢ Built-in GEORADIUS for nearby queries                           â”‚   â”‚
â”‚  â”‚  â€¢ In-memory = sub-millisecond latency                              â”‚   â”‚
â”‚  â”‚  â€¢ Can't use SQL for 4M location updates/second                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Cassandra (Location History)                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Driver location history (audit trail)                            â”‚   â”‚
â”‚  â”‚  â€¢ Trip route tracking points                                       â”‚   â”‚
â”‚  â”‚  â€¢ Analytics data                                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  WHY Cassandra:                                                      â”‚   â”‚
â”‚  â”‚  â€¢ 4M writes/second (location updates)                              â”‚   â”‚
â”‚  â”‚  â€¢ Time-series data (natural fit)                                   â”‚   â”‚
â”‚  â”‚  â€¢ Horizontal scaling                                               â”‚   â”‚
â”‚  â”‚  â€¢ TTL for automatic cleanup                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Elasticsearch (Search)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Place search (autocomplete)                                      â”‚   â”‚
â”‚  â”‚  â€¢ Driver search by area                                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Alternative: Google Places API (simpler, but costly)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PostgreSQL Schema                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  users                                                                       â”‚
â”‚  â”œâ”€â”€ id (UUID, PK)                                                          â”‚
â”‚  â”œâ”€â”€ phone (VARCHAR, UNIQUE)                                                â”‚
â”‚  â”œâ”€â”€ email (VARCHAR)                                                        â”‚
â”‚  â”œâ”€â”€ name (VARCHAR)                                                         â”‚
â”‚  â”œâ”€â”€ role (ENUM: rider, driver, both)                                       â”‚
â”‚  â”œâ”€â”€ rating (DECIMAL)                                                       â”‚
â”‚  â”œâ”€â”€ total_trips (INT)                                                      â”‚
â”‚  â”œâ”€â”€ created_at (TIMESTAMP)                                                 â”‚
â”‚  â””â”€â”€ updated_at (TIMESTAMP)                                                 â”‚
â”‚                                                                              â”‚
â”‚  drivers (extends users)                                                    â”‚
â”‚  â”œâ”€â”€ id (UUID, PK, FK â†’ users)                                              â”‚
â”‚  â”œâ”€â”€ vehicle_id (UUID, FK â†’ vehicles)                                       â”‚
â”‚  â”œâ”€â”€ license_number (VARCHAR)                                               â”‚
â”‚  â”œâ”€â”€ is_verified (BOOLEAN)                                                  â”‚
â”‚  â”œâ”€â”€ is_online (BOOLEAN)                                                    â”‚
â”‚  â”œâ”€â”€ current_location (GEOGRAPHY) -- PostGIS                               â”‚
â”‚  â”œâ”€â”€ acceptance_rate (DECIMAL)                                              â”‚
â”‚  â””â”€â”€ cancellation_rate (DECIMAL)                                            â”‚
â”‚                                                                              â”‚
â”‚  vehicles                                                                   â”‚
â”‚  â”œâ”€â”€ id (UUID, PK)                                                          â”‚
â”‚  â”œâ”€â”€ driver_id (UUID, FK â†’ drivers)                                         â”‚
â”‚  â”œâ”€â”€ type (ENUM: bike, auto, car, premium)                                  â”‚
â”‚  â”œâ”€â”€ model (VARCHAR)                                                        â”‚
â”‚  â”œâ”€â”€ color (VARCHAR)                                                        â”‚
â”‚  â”œâ”€â”€ plate_number (VARCHAR)                                                 â”‚
â”‚  â””â”€â”€ seats (INT)                                                            â”‚
â”‚                                                                              â”‚
â”‚  rides                                                                       â”‚
â”‚  â”œâ”€â”€ id (UUID, PK)                                                          â”‚
â”‚  â”œâ”€â”€ rider_id (UUID, FK â†’ users)                                            â”‚
â”‚  â”œâ”€â”€ driver_id (UUID, FK â†’ drivers, NULLABLE)                               â”‚
â”‚  â”œâ”€â”€ vehicle_type (ENUM)                                                    â”‚
â”‚  â”œâ”€â”€ status (ENUM: searching, matched, driver_arriving,                    â”‚
â”‚  â”‚           trip_started, trip_completed, cancelled)                       â”‚
â”‚  â”œâ”€â”€ pickup_location (GEOGRAPHY)                                            â”‚
â”‚  â”œâ”€â”€ pickup_address (VARCHAR)                                               â”‚
â”‚  â”œâ”€â”€ drop_location (GEOGRAPHY)                                              â”‚
â”‚  â”œâ”€â”€ drop_address (VARCHAR)                                                 â”‚
â”‚  â”œâ”€â”€ estimated_fare (DECIMAL)                                               â”‚
â”‚  â”œâ”€â”€ actual_fare (DECIMAL)                                                  â”‚
â”‚  â”œâ”€â”€ surge_multiplier (DECIMAL)                                             â”‚
â”‚  â”œâ”€â”€ distance_km (DECIMAL)                                                  â”‚
â”‚  â”œâ”€â”€ duration_minutes (INT)                                                 â”‚
â”‚  â”œâ”€â”€ otp (VARCHAR)                                                          â”‚
â”‚  â”œâ”€â”€ requested_at (TIMESTAMP)                                               â”‚
â”‚  â”œâ”€â”€ matched_at (TIMESTAMP)                                                 â”‚
â”‚  â”œâ”€â”€ started_at (TIMESTAMP)                                                 â”‚
â”‚  â”œâ”€â”€ completed_at (TIMESTAMP)                                               â”‚
â”‚  â”œâ”€â”€ cancelled_at (TIMESTAMP)                                               â”‚
â”‚  â””â”€â”€ cancellation_reason (VARCHAR)                                          â”‚
â”‚                                                                              â”‚
â”‚  payments                                                                   â”‚
â”‚  â”œâ”€â”€ id (UUID, PK)                                                          â”‚
â”‚  â”œâ”€â”€ ride_id (UUID, FK â†’ rides)                                             â”‚
â”‚  â”œâ”€â”€ amount (DECIMAL)                                                       â”‚
â”‚  â”œâ”€â”€ method (ENUM: wallet, card, cash, upi)                                â”‚
â”‚  â”œâ”€â”€ status (ENUM: pending, success, failed)                               â”‚
â”‚  â”œâ”€â”€ transaction_id (VARCHAR)                                               â”‚
â”‚  â””â”€â”€ created_at (TIMESTAMP)                                                 â”‚
â”‚                                                                              â”‚
â”‚  Indexes:                                                                    â”‚
â”‚  â€¢ GIST on rides.pickup_location, rides.drop_location                      â”‚
â”‚  â€¢ B-tree on rides(rider_id, requested_at DESC)                            â”‚
â”‚  â€¢ B-tree on rides(driver_id, requested_at DESC)                           â”‚
â”‚  â€¢ B-tree on rides(status)                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redis Geo Commands

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REDIS GEO FOR DRIVER TRACKING                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Add/Update Driver Location:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  GEOADD drivers:active:bangalore 77.5946 12.9716 driver_123                â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Find Nearby Drivers (3km radius):                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  GEORADIUS drivers:active:bangalore 77.5946 12.9716 3 km                   â”‚
â”‚    WITHDIST    // Include distance                                         â”‚
â”‚    WITHCOORD   // Include coordinates                                      â”‚
â”‚    ASC         // Sort by distance                                         â”‚
â”‚    COUNT 50    // Limit results                                            â”‚
â”‚                                                                              â”‚
â”‚  Returns:                                                                   â”‚
â”‚  1) "driver_456"                                                            â”‚
â”‚     "0.8"  (0.8 km away)                                                   â”‚
â”‚     "77.5950" "12.9720"                                                    â”‚
â”‚  2) "driver_789"                                                            â”‚
â”‚     "1.2"                                                                   â”‚
â”‚     ...                                                                     â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Driver Status Hash:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  HSET driver:123:status                                                     â”‚
â”‚    is_online "true"                                                         â”‚
â”‚    is_available "true"                                                      â”‚
â”‚    vehicle_type "auto"                                                      â”‚
â”‚    current_ride ""                                                          â”‚
â”‚    last_updated "1703239800"                                                â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Distributed Lock for Ride Matching:                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚  SET ride:123:driver driver_456 NX EX 30                                   â”‚
â”‚  // Only first driver to accept wins                                       â”‚
â”‚  // NX = set only if not exists                                            â”‚
â”‚  // EX 30 = expire in 30 seconds (safety)                                  â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Pub/Sub for Ride Updates:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  PUBLISH ride:123 '{"type":"driver_location","lat":12.97,"lng":77.59}'    â”‚
â”‚                                                                              â”‚
â”‚  // Rider's WebSocket gateway subscribes to:                               â”‚
â”‚  SUBSCRIBE ride:123                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Caching Strategy

### Multi-Layer Cache

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHING ARCHITECTURE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LAYER 1: Client Cache (In-Memory)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Recent places (autocomplete history)                             â”‚   â”‚
â”‚  â”‚  â€¢ Saved places (home, work)                                        â”‚   â”‚
â”‚  â”‚  â€¢ Driver info during ride (avoid re-fetch)                        â”‚   â”‚
â”‚  â”‚  â€¢ Map tiles (Google Maps handles this)                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Storage: React Query + AsyncStorage (mobile)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  LAYER 2: CDN (Static Assets)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ App assets (JS, CSS, images)                                     â”‚   â”‚
â”‚  â”‚  â€¢ Map marker icons                                                  â”‚   â”‚
â”‚  â”‚  â€¢ Vehicle type icons                                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  NOT cached: API responses (too dynamic)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  LAYER 3: Redis (Backend)                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Real-time (no TTL or very short):                                  â”‚   â”‚
â”‚  â”‚  â€¢ Driver locations (constantly updated)                            â”‚   â”‚
â”‚  â”‚  â€¢ Driver availability                                              â”‚   â”‚
â”‚  â”‚  â€¢ Active ride status                                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Cached (TTL: 1-5 minutes):                                         â”‚   â”‚
â”‚  â”‚  â€¢ Fare estimates for route                                         â”‚   â”‚
â”‚  â”‚    Key: fare:{pickup_geohash}:{drop_geohash}:{vehicle_type}        â”‚   â”‚
â”‚  â”‚    TTL: 5 minutes                                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â€¢ ETA calculations                                                  â”‚   â”‚
â”‚  â”‚    Key: eta:{origin_geohash}:{dest_geohash}                         â”‚   â”‚
â”‚  â”‚    TTL: 1 minute (traffic changes)                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â€¢ Surge pricing by zone                                            â”‚   â”‚
â”‚  â”‚    Key: surge:{zone_id}                                             â”‚   â”‚
â”‚  â”‚    TTL: 5 minutes                                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â€¢ User sessions                                                     â”‚   â”‚
â”‚  â”‚    Key: session:{token}                                             â”‚   â”‚
â”‚  â”‚    TTL: 30 days                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  LAYER 4: Elasticsearch (Search Cache)                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Place autocomplete results                                       â”‚   â”‚
â”‚  â”‚  â€¢ Precomputed suggestions by location                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ETA Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ETA CACHING STRATEGY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Problem: ETA API calls are expensive (Google Maps, external)              â”‚
â”‚  Solution: Geohash-based caching                                           â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Pickup: (12.9716, 77.5946) â†’ Geohash: tdr1wc                       â”‚   â”‚
â”‚  â”‚  Drop:   (12.9352, 77.6245) â†’ Geohash: tdr1u4                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Cache Key: eta:tdr1wc:tdr1u4                                       â”‚   â”‚
â”‚  â”‚  Value: { duration: 25, distance: 8.5, updated: timestamp }        â”‚   â”‚
â”‚  â”‚  TTL: 60 seconds                                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Geohash Precision:                                                  â”‚   â”‚
â”‚  â”‚  â€¢ 6 chars â†’ ~1.2km accuracy                                        â”‚   â”‚
â”‚  â”‚  â€¢ Good enough for ETA (nearby points share cache)                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Cache Hit Rate: ~70% (significant cost savings)                           â”‚
â”‚                                                                              â”‚
â”‚  When to Invalidate:                                                        â”‚
â”‚  â€¢ Traffic conditions change significantly                                 â”‚
â”‚  â€¢ Time-based TTL (1 minute)                                               â”‚
â”‚  â€¢ Major events (accidents, road closures)                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. State Management

### State Categories

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       STATE MANAGEMENT STRATEGY                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RIDE STATE (Zustand/Redux)                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚   â”‚
â”‚  â”‚  â€¢ Current ride object                                               â”‚   â”‚
â”‚  â”‚  â€¢ Ride status (state machine)                                      â”‚   â”‚
â”‚  â”‚  â€¢ Driver details                                                    â”‚   â”‚
â”‚  â”‚  â€¢ OTP                                                               â”‚   â”‚
â”‚  â”‚  â€¢ Real-time driver location                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why global: Accessed across many screens                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LOCATION STATE (Context)                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚   â”‚
â”‚  â”‚  â€¢ User's current location                                          â”‚   â”‚
â”‚  â”‚  â€¢ Pickup location (selected)                                       â”‚   â”‚
â”‚  â”‚  â€¢ Drop location (selected)                                         â”‚   â”‚
â”‚  â”‚  â€¢ Saved places                                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why context: Shared by map and forms                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SERVER STATE (React Query)                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚  â€¢ Fare estimates                                                    â”‚   â”‚
â”‚  â”‚  â€¢ Ride history                                                      â”‚   â”‚
â”‚  â”‚  â€¢ Payment methods                                                   â”‚   â”‚
â”‚  â”‚  â€¢ User profile                                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why React Query: Caching, background refresh                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WEBSOCKET STATE (Custom Provider)                                  â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚   â”‚
â”‚  â”‚  â€¢ Connection status                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Reconnection handling                                             â”‚   â”‚
â”‚  â”‚  â€¢ Event dispatch to other stores                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Events update Ride State directly                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UI STATE (Local useState)                                          â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚  â€¢ Bottom sheet position                                            â”‚   â”‚
â”‚  â”‚  â€¢ Selected ride type                                               â”‚   â”‚
â”‚  â”‚  â€¢ Payment method modal open                                        â”‚   â”‚
â”‚  â”‚  â€¢ Loading states                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ride State Machine Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RIDE STATE MACHINE (XState / Zustand)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  States and Transitions:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚                                                                              â”‚
â”‚  {                                                                           â”‚
â”‚    state: 'idle' | 'selecting' | 'searching' | 'matched' |                 â”‚
â”‚            'driver_arriving' | 'on_trip' | 'completed' | 'cancelled',      â”‚
â”‚                                                                              â”‚
â”‚    ride: null | {                                                           â”‚
â”‚      id: string,                                                            â”‚
â”‚      pickup: Location,                                                      â”‚
â”‚      drop: Location,                                                        â”‚
â”‚      vehicleType: string,                                                   â”‚
â”‚      fare: { min, max },                                                   â”‚
â”‚      driver: null | DriverInfo,                                            â”‚
â”‚      otp: string,                                                           â”‚
â”‚      eta: number,                                                           â”‚
â”‚    },                                                                        â”‚
â”‚                                                                              â”‚
â”‚    driverLocation: null | { lat, lng, heading },                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Actions:                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                                    â”‚
â”‚  â€¢ setLocations(pickup, drop)     â†’ idle â†’ selecting                       â”‚
â”‚  â€¢ requestRide(vehicleType)       â†’ selecting â†’ searching                  â”‚
â”‚  â€¢ driverMatched(driver, otp)     â†’ searching â†’ matched                    â”‚
â”‚  â€¢ driverArrived()                â†’ matched â†’ driver_arriving              â”‚
â”‚  â€¢ tripStarted()                  â†’ driver_arriving â†’ on_trip             â”‚
â”‚  â€¢ tripCompleted(fare)            â†’ on_trip â†’ completed                   â”‚
â”‚  â€¢ rideCancelled(reason)          â†’ any â†’ cancelled                        â”‚
â”‚  â€¢ updateDriverLocation(loc)      â†’ updates driverLocation                 â”‚
â”‚  â€¢ reset()                        â†’ any â†’ idle                             â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  WebSocket Event Handler:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  onMessage(event) {                                                         â”‚
â”‚    switch(event.type) {                                                     â”‚
â”‚      case 'driver_matched':                                                 â”‚
â”‚        rideStore.driverMatched(event.driver, event.otp);                   â”‚
â”‚        break;                                                               â”‚
â”‚      case 'driver_location':                                               â”‚
â”‚        rideStore.updateDriverLocation(event.location);                     â”‚
â”‚        break;                                                               â”‚
â”‚      case 'ride_status':                                                    â”‚
â”‚        // Handle status transitions                                        â”‚
â”‚        break;                                                               â”‚
â”‚    }                                                                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Performance Optimization

### Map Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MAP OPTIMIZATION                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Marker Clustering                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  â€¢ When showing many drivers, cluster nearby markers                       â”‚
â”‚  â€¢ Show count badge on cluster                                             â”‚
â”‚  â€¢ Expand on zoom or tap                                                   â”‚
â”‚  â€¢ Reduces rendering overhead                                               â”‚
â”‚                                                                              â”‚
â”‚  2. Marker Animation                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â€¢ Interpolate between location updates                                    â”‚
â”‚  â€¢ Smooth movement instead of jumping                                      â”‚
â”‚  â€¢ Use requestAnimationFrame                                               â”‚
â”‚  â€¢ CSS transforms for rotation (heading)                                   â”‚
â”‚                                                                              â”‚
â”‚  3. Limit Driver Markers                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  â€¢ Show only nearest 20-50 drivers                                         â”‚
â”‚  â€¢ Recalculate on map move                                                 â”‚
â”‚  â€¢ Debounce map move events                                                â”‚
â”‚                                                                              â”‚
â”‚  4. Route Polyline                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚  â€¢ Fetch encoded polyline from Directions API                              â”‚
â”‚  â€¢ Decode on client                                                         â”‚
â”‚  â€¢ Cache route for session                                                 â”‚
â”‚  â€¢ Simplify polyline at lower zoom levels                                  â”‚
â”‚                                                                              â”‚
â”‚  5. Tile Caching                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚  â€¢ Google Maps SDK handles this                                            â”‚
â”‚  â€¢ Preload tiles for common areas                                          â”‚
â”‚  â€¢ Offline maps for poor connectivity                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Location Updates Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LOCATION UPDATES OPTIMIZATION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Driver App (Sending Updates):                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚                                                                              â”‚
â”‚  1. Adaptive Frequency                                                      â”‚
â”‚     â€¢ Moving: Every 3 seconds                                              â”‚
â”‚     â€¢ Stopped: Every 30 seconds                                            â”‚
â”‚     â€¢ Detect via speed/distance delta                                      â”‚
â”‚                                                                              â”‚
â”‚  2. Delta Encoding                                                          â”‚
â”‚     â€¢ Send only changes from last position                                 â”‚
â”‚     â€¢ Full update every N deltas                                           â”‚
â”‚     â€¢ Reduces payload size 60%                                             â”‚
â”‚                                                                              â”‚
â”‚  3. Battery Optimization                                                    â”‚
â”‚     â€¢ Use fused location provider                                          â”‚
â”‚     â€¢ Balance accuracy vs battery                                          â”‚
â”‚     â€¢ High accuracy only during active ride                                â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Rider App (Receiving Updates):                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                              â”‚
â”‚  1. Throttle UI Updates                                                     â”‚
â”‚     â€¢ Receive every 3 seconds                                              â”‚
â”‚     â€¢ Render at most 10 fps (100ms)                                       â”‚
â”‚     â€¢ Prevents UI jank                                                      â”‚
â”‚                                                                              â”‚
â”‚  2. ETA Calculation                                                         â”‚
â”‚     â€¢ Recalculate only when significant change                             â”‚
â”‚     â€¢ Cache ETA, update incrementally                                      â”‚
â”‚     â€¢ Countdown locally between updates                                    â”‚
â”‚                                                                              â”‚
â”‚  3. Smooth Animation                                                        â”‚
â”‚     â€¢ Interpolate position between updates                                 â”‚
â”‚     â€¢ CSS transition for marker movement                                   â”‚
â”‚     â€¢ Predictive movement using heading/speed                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Error Handling & Edge Cases

### Critical Scenarios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CRITICAL SCENARIOS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. No Drivers Available                                                    â”‚
â”‚     â€¢ Show "No drivers nearby" message                                     â”‚
â”‚     â€¢ Suggest trying again in 5 minutes                                    â”‚
â”‚     â€¢ Offer to notify when available                                       â”‚
â”‚     â€¢ Show estimated wait time based on demand                             â”‚
â”‚                                                                              â”‚
â”‚  2. Driver Cancels After Match                                              â”‚
â”‚     â€¢ Immediately restart matching                                          â”‚
â”‚     â€¢ Show "Finding another driver"                                        â”‚
â”‚     â€¢ No cancellation fee to rider                                         â”‚
â”‚     â€¢ Prioritize in matching queue                                         â”‚
â”‚                                                                              â”‚
â”‚  3. Rider Cancels After Match                                               â”‚
â”‚     â€¢ Confirm cancellation                                                  â”‚
â”‚     â€¢ Apply cancellation fee if driver en route > 2 min                   â”‚
â”‚     â€¢ Release driver back to pool                                          â”‚
â”‚                                                                              â”‚
â”‚  4. GPS Issues                                                              â”‚
â”‚     â€¢ Fallback to cell tower location                                      â”‚
â”‚     â€¢ Show accuracy indicator                                               â”‚
â”‚     â€¢ Allow manual pin adjustment                                          â”‚
â”‚     â€¢ "Having trouble finding your location" prompt                        â”‚
â”‚                                                                              â”‚
â”‚  5. Payment Failure                                                         â”‚
â”‚     â€¢ Retry with backoff                                                    â”‚
â”‚     â€¢ Offer alternate payment method                                       â”‚
â”‚     â€¢ Allow cash fallback                                                   â”‚
â”‚     â€¢ Mark ride as "pending payment"                                       â”‚
â”‚                                                                              â”‚
â”‚  6. Connection Loss During Ride                                             â”‚
â”‚     â€¢ Continue ride (driver handles)                                       â”‚
â”‚     â€¢ Store location updates locally                                       â”‚
â”‚     â€¢ Sync when reconnected                                                â”‚
â”‚     â€¢ Show "Reconnecting..." banner                                        â”‚
â”‚                                                                              â”‚
â”‚  7. App Crash/Kill                                                          â”‚
â”‚     â€¢ Persist ride state to AsyncStorage                                   â”‚
â”‚     â€¢ Restore on relaunch                                                   â”‚
â”‚     â€¢ WebSocket reconnects automatically                                   â”‚
â”‚     â€¢ Fetch current ride status from server                                â”‚
â”‚                                                                              â”‚
â”‚  8. Driver No-Show                                                          â”‚
â”‚     â€¢ Auto-cancel after 5 min wait at pickup                              â”‚
â”‚     â€¢ Full refund to rider                                                 â”‚
â”‚     â€¢ Penalty to driver                                                     â”‚
â”‚     â€¢ Auto-rebook option                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Interview Cross-Questions

### Common Questions & Answers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTERVIEW CROSS-QUESTIONS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Q: Why WebSocket instead of Polling for driver location?                  â”‚
â”‚  A: â€¢ 4M location updates/second would overwhelm REST API                  â”‚
â”‚     â€¢ WebSocket: Single connection, push model                             â”‚
â”‚     â€¢ 90% bandwidth reduction                                               â”‚
â”‚     â€¢ Sub-100ms latency vs 3s polling delay                               â”‚
â”‚     â€¢ Bi-directional (driver sends, rider receives)                        â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: Why Redis for driver locations, not PostgreSQL?                        â”‚
â”‚  A: â€¢ 4M writes/second impossible with SQL                                 â”‚
â”‚     â€¢ Redis GEOADD/GEORADIUS for spatial queries                          â”‚
â”‚     â€¢ In-memory = sub-millisecond latency                                  â”‚
â”‚     â€¢ Built-in Pub/Sub for real-time broadcasting                         â”‚
â”‚     â€¢ Horizontal scaling with Redis Cluster                               â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you prevent double-booking a driver?                            â”‚
â”‚  A: â€¢ Distributed lock: SET ride:{id}:driver {driver_id} NX EX 30         â”‚
â”‚     â€¢ Only first SET succeeds (NX = not exists)                           â”‚
â”‚     â€¢ Race condition: Multiple requests, one wins                          â”‚
â”‚     â€¢ Loser sees "Ride no longer available"                               â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How does surge pricing work?                                            â”‚
â”‚  A: â€¢ Divide city into hexagonal zones (H3)                                â”‚
â”‚     â€¢ Calculate demand/supply ratio per zone                               â”‚
â”‚     â€¢ demand = ride requests in last 5 min                                 â”‚
â”‚     â€¢ supply = available drivers in zone                                   â”‚
â”‚     â€¢ surge = max(1, demand / (supply * threshold))                       â”‚
â”‚     â€¢ Cache surge per zone in Redis (5 min TTL)                           â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you ensure ride consistency (ACID)?                             â”‚
â”‚  A: â€¢ Ride creation in PostgreSQL transaction                             â”‚
â”‚     â€¢ Payment: Stripe/Razorpay handles consistency                        â”‚
â”‚     â€¢ State machine prevents invalid transitions                          â”‚
â”‚     â€¢ Idempotency keys for retry safety                                   â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you handle high demand periods?                                 â”‚
â”‚  A: â€¢ Horizontal scaling of all services                                   â”‚
â”‚     â€¢ Pre-warm instances before predicted peaks                           â”‚
â”‚     â€¢ Degrade gracefully (longer ETAs, no surge cap)                      â”‚
â”‚     â€¢ Queue ride requests if overwhelmed                                   â”‚
â”‚     â€¢ Shed load: Reject new requests beyond capacity                      â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: What metrics would you track?                                          â”‚
â”‚  A: â€¢ Time to first ride option shown                                      â”‚
â”‚     â€¢ Driver matching time                                                  â”‚
â”‚     â€¢ Driver ETA accuracy                                                   â”‚
â”‚     â€¢ Cancellation rate (rider/driver)                                     â”‚
â”‚     â€¢ WebSocket connection success rate                                    â”‚
â”‚     â€¢ Location update latency                                              â”‚
â”‚     â€¢ Payment success rate                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. Accessibility (a11y)

### Map Accessibility

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACCESSIBLE MAP IMPLEMENTATION                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Challenge: Maps are inherently visual                                      â”‚
â”‚  Solution: Provide alternative interactions and announcements               â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  <div                                                                â”‚   â”‚
â”‚  â”‚    role="application"                                                â”‚   â”‚
â”‚  â”‚    aria-label="Interactive map for ride booking"                    â”‚   â”‚
â”‚  â”‚    aria-describedby="map-instructions"                              â”‚   â”‚
â”‚  â”‚  >                                                                   â”‚   â”‚
â”‚  â”‚    <div id="map-instructions" class="sr-only">                      â”‚   â”‚
â”‚  â”‚      Use arrow keys to pan map. Press Enter to drop pin.           â”‚   â”‚
â”‚  â”‚      Press Escape to exit map navigation.                          â”‚   â”‚
â”‚  â”‚    </div>                                                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚    <!-- Map renders here -->                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚    <div aria-live="polite" class="sr-only" id="map-announcer">     â”‚   â”‚
â”‚  â”‚      <!-- Dynamic announcements -->                                 â”‚   â”‚
â”‚  â”‚    </div>                                                            â”‚   â”‚
â”‚  â”‚  </div>                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Screen Reader Announcements:                                               â”‚
â”‚  â€¢ "Pickup location set to MG Road Metro Station"                         â”‚
â”‚  â€¢ "3 drivers nearby, closest is 2 minutes away"                          â”‚
â”‚  â€¢ "Driver location updated, now 500 meters away"                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Location Input Accessibility

```typescript
// Accessible Autocomplete Component
const LocationAutocomplete = () => {
  const [suggestions, setSuggestions] = useState([]);
  const [activeIndex, setActiveIndex] = useState(-1);
  const [isOpen, setIsOpen] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const listId = useId();

  return (
    <div className="location-input">
      <label htmlFor="pickup-input" className="sr-only">
        Enter pickup location
      </label>

      <input
        id="pickup-input"
        ref={inputRef}
        type="text"
        role="combobox"
        aria-expanded={isOpen}
        aria-controls={listId}
        aria-activedescendant={
          activeIndex >= 0 ? `suggestion-${activeIndex}` : undefined
        }
        aria-autocomplete="list"
        aria-describedby="pickup-hint"
        placeholder="Enter pickup location"
        onKeyDown={handleKeyDown}
      />

      <span id="pickup-hint" className="sr-only">
        Type to search locations. Use up and down arrows to navigate suggestions.
        Press Enter to select.
      </span>

      {isOpen && (
        <ul
          id={listId}
          role="listbox"
          aria-label="Location suggestions"
        >
          {suggestions.map((suggestion, index) => (
            <li
              key={suggestion.placeId}
              id={`suggestion-${index}`}
              role="option"
              aria-selected={index === activeIndex}
              onClick={() => selectSuggestion(suggestion)}
            >
              <span className="suggestion-name">{suggestion.name}</span>
              <span className="suggestion-address">{suggestion.address}</span>
            </li>
          ))}
        </ul>
      )}

      {/* Live region for announcements */}
      <div aria-live="polite" className="sr-only">
        {suggestions.length > 0 &&
          `${suggestions.length} suggestions available`
        }
      </div>
    </div>
  );
};
```

### Ride Status Announcements

```typescript
// useRideStatusAnnouncer.ts
const useRideStatusAnnouncer = () => {
  const announcer = useRef<HTMLDivElement>(null);
  const prevStatus = useRef<string>('');

  const announce = useCallback((message: string, priority: 'polite' | 'assertive' = 'polite') => {
    if (announcer.current) {
      announcer.current.setAttribute('aria-live', priority);
      announcer.current.textContent = message;

      // Clear after announcement
      setTimeout(() => {
        if (announcer.current) {
          announcer.current.textContent = '';
        }
      }, 1000);
    }
  }, []);

  const announceStatus = useCallback((status: RideStatus, details: RideDetails) => {
    if (status === prevStatus.current) return;
    prevStatus.current = status;

    const messages: Record<RideStatus, string> = {
      searching: 'Searching for nearby drivers. Please wait.',
      matched: `Driver found! ${details.driverName} will arrive in ${details.eta} minutes. ` +
               `Vehicle: ${details.vehicleColor} ${details.vehicleModel}, ` +
               `License plate: ${details.vehiclePlate}. Your OTP is ${details.otp}.`,
      driver_arriving: `Driver is arriving. ${details.eta} minute away.`,
      driver_arrived: 'Driver has arrived at pickup location. Please proceed to vehicle.',
      trip_started: `Trip started. Estimated arrival at destination: ${details.tripEta} minutes.`,
      trip_completed: `Trip completed. Total fare: ${details.fare}. Please rate your ride.`,
      cancelled: 'Ride has been cancelled.'
    };

    announce(messages[status], status === 'matched' ? 'assertive' : 'polite');
  }, [announce]);

  return { announce, announceStatus, announcer };
};

// Announcer component
const RideStatusAnnouncer = () => {
  const { announcer } = useRideStatusAnnouncer();

  return (
    <div
      ref={announcer}
      role="status"
      aria-live="polite"
      aria-atomic="true"
      className="sr-only"
    />
  );
};
```

### Keyboard Navigation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KEYBOARD SHORTCUTS                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Global Shortcuts:                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚  Tab / Shift+Tab    Navigate between interactive elements                  â”‚
â”‚  Enter              Activate focused element                                â”‚
â”‚  Escape             Close modals, cancel current action                    â”‚
â”‚  ?                  Show keyboard shortcuts help                           â”‚
â”‚                                                                              â”‚
â”‚  Map Navigation:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚  Arrow keys         Pan map in that direction                              â”‚
â”‚  +/-                Zoom in/out                                             â”‚
â”‚  Enter              Drop pin at map center                                 â”‚
â”‚  M                  Toggle map focus mode                                   â”‚
â”‚                                                                              â”‚
â”‚  Ride Flow:                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  P                  Focus pickup input                                      â”‚
â”‚  D                  Focus destination input                                 â”‚
â”‚  R                  Cycle through ride types                               â”‚
â”‚  B                  Book ride (when ready)                                 â”‚
â”‚  C                  Cancel ride (with confirmation)                        â”‚
â”‚  S                  Share trip                                              â”‚
â”‚  E                  Emergency SOS                                           â”‚
â”‚                                                                              â”‚
â”‚  Implementation:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  useEffect(() => {                                                          â”‚
â”‚    const handleKeyDown = (e: KeyboardEvent) => {                           â”‚
â”‚      // Don't trigger if typing in input                                   â”‚
â”‚      if (e.target instanceof HTMLInputElement) return;                     â”‚
â”‚                                                                              â”‚
â”‚      switch(e.key) {                                                        â”‚
â”‚        case 'p': focusPickupInput(); break;                                â”‚
â”‚        case 'd': focusDropInput(); break;                                  â”‚
â”‚        case 'b': if(canBook) bookRide(); break;                           â”‚
â”‚        case 'Escape': handleEscape(); break;                               â”‚
â”‚      }                                                                      â”‚
â”‚    };                                                                       â”‚
â”‚                                                                              â”‚
â”‚    window.addEventListener('keydown', handleKeyDown);                      â”‚
â”‚    return () => window.removeEventListener('keydown', handleKeyDown);      â”‚
â”‚  }, []);                                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Driver Card Accessibility

```typescript
// Accessible Driver Card
const DriverCard = ({ driver, otp, eta }: DriverCardProps) => {
  return (
    <article
      aria-labelledby="driver-name"
      aria-describedby="driver-details"
      className="driver-card"
    >
      <div className="driver-avatar">
        <img
          src={driver.photoUrl}
          alt={`Photo of driver ${driver.name}`}
          aria-hidden="false"
        />
      </div>

      <div className="driver-info">
        <h2 id="driver-name">{driver.name}</h2>

        <p id="driver-details">
          <span aria-label={`Rating: ${driver.rating} out of 5 stars`}>
            {'â˜…'.repeat(Math.floor(driver.rating))}
            {'â˜†'.repeat(5 - Math.floor(driver.rating))}
            <span className="sr-only">{driver.rating} stars</span>
          </span>

          <span aria-label={`${driver.totalTrips} trips completed`}>
            {driver.totalTrips} trips
          </span>
        </p>

        <p aria-label={`Vehicle: ${driver.vehicle.color} ${driver.vehicle.model}`}>
          {driver.vehicle.color} {driver.vehicle.model}
        </p>

        <p aria-label={`License plate: ${driver.vehicle.plate}`}>
          {driver.vehicle.plate}
        </p>
      </div>

      <div
        className="otp-display"
        role="alert"
        aria-label={`Your OTP is ${otp.split('').join(' ')}`}
      >
        <span className="otp-label">OTP</span>
        <span className="otp-digits" aria-hidden="true">{otp}</span>
      </div>

      <p
        aria-live="polite"
        aria-label={`Driver arriving in ${eta} minutes`}
      >
        Arriving in {eta} min
      </p>

      <div className="driver-actions" role="group" aria-label="Driver contact options">
        <button aria-label={`Call driver ${driver.name}`}>
          <PhoneIcon aria-hidden="true" />
          <span>Call</span>
        </button>

        <button aria-label={`Send message to ${driver.name}`}>
          <MessageIcon aria-hidden="true" />
          <span>Chat</span>
        </button>
      </div>
    </article>
  );
};
```

---

## 13. Security & Safety Features

### OTP Verification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         OTP VERIFICATION FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Purpose: Ensure rider gets into correct vehicle                           â”‚
â”‚                                                                              â”‚
â”‚   Rider App              Server                Driver App                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚  Ride Matched       â”‚   Ride Matched        â”‚                       â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
â”‚       â”‚  (shows OTP: 4521)  â”‚                       â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚         Rider tells OTP verbally            â”‚                       â”‚
â”‚       â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€>â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚                     â”‚   Verify OTP: 4521   â”‚                       â”‚
â”‚       â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚                     â”‚   âœ“ OTP Valid        â”‚                       â”‚
â”‚       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚       â”‚   Trip Started      â”‚   Trip Started        â”‚                       â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
â”‚       â”‚                     â”‚                       â”‚                       â”‚
â”‚                                                                              â”‚
â”‚  Security Measures:                                                         â”‚
â”‚  â€¢ OTP expires after 10 minutes                                            â”‚
â”‚  â€¢ OTP regenerates if driver changes                                       â”‚
â”‚  â€¢ Max 3 verification attempts                                             â”‚
â”‚  â€¢ OTP not stored in logs (masked)                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SOS Emergency Button

```typescript
// SOSButton.tsx - Emergency Safety Feature
const SOSButton = ({ rideId, riderLocation }: SOSProps) => {
  const [isPressed, setIsPressed] = useState(false);
  const [countdown, setCountdown] = useState(5);
  const pressTimer = useRef<NodeJS.Timeout>();
  const countdownTimer = useRef<NodeJS.Timeout>();

  // Long press to activate (prevent accidental triggers)
  const handlePressStart = () => {
    pressTimer.current = setTimeout(() => {
      setIsPressed(true);
      startCountdown();
    }, 3000); // 3 second hold required
  };

  const handlePressEnd = () => {
    if (pressTimer.current) {
      clearTimeout(pressTimer.current);
    }
  };

  const startCountdown = () => {
    countdownTimer.current = setInterval(() => {
      setCountdown(prev => {
        if (prev <= 1) {
          triggerSOS();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
  };

  const cancelSOS = () => {
    if (countdownTimer.current) {
      clearInterval(countdownTimer.current);
    }
    setIsPressed(false);
    setCountdown(5);
  };

  const triggerSOS = async () => {
    // Vibrate pattern for confirmation
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200, 100, 200]);
    }

    try {
      await fetch('/api/v1/sos', {
        method: 'POST',
        body: JSON.stringify({
          rideId,
          location: riderLocation,
          timestamp: new Date().toISOString(),
          batteryLevel: await getBatteryLevel(),
        }),
      });

      // Actions triggered:
      // 1. Alert emergency contacts
      // 2. Share live location with police
      // 3. Record audio (with consent)
      // 4. Flag ride for immediate support review

    } catch (error) {
      // Fallback: Direct call to emergency number
      window.location.href = 'tel:112';
    }
  };

  return (
    <div className="sos-container">
      {!isPressed ? (
        <button
          className="sos-button"
          onTouchStart={handlePressStart}
          onTouchEnd={handlePressEnd}
          onMouseDown={handlePressStart}
          onMouseUp={handlePressEnd}
          aria-label="Emergency SOS. Hold for 3 seconds to activate."
        >
          <span className="sos-icon">ğŸ†˜</span>
          <span className="sos-text">Hold for SOS</span>
        </button>
      ) : (
        <div className="sos-countdown" role="alert">
          <p>Contacting emergency services in</p>
          <span className="countdown-number">{countdown}</span>
          <button onClick={cancelSOS} className="cancel-sos">
            Cancel
          </button>
        </div>
      )}
    </div>
  );
};
```

### Trip Sharing

```typescript
// TripSharing.tsx
const TripSharing = ({ ride }: { ride: RideDetails }) => {
  const [sharedWith, setSharedWith] = useState<Contact[]>([]);
  const [shareLink, setShareLink] = useState<string>('');

  const generateShareLink = async () => {
    const response = await fetch('/api/v1/rides/share', {
      method: 'POST',
      body: JSON.stringify({
        rideId: ride.id,
        expiresAt: ride.estimatedEndTime,
      }),
    });

    const { shareToken } = await response.json();
    const link = `${window.location.origin}/track/${shareToken}`;
    setShareLink(link);
    return link;
  };

  const shareViaWhatsApp = async () => {
    const link = shareLink || await generateShareLink();
    const message = encodeURIComponent(
      `I'm on a ride with ${ride.driver.name}. ` +
      `Track my trip: ${link}\n\n` +
      `Vehicle: ${ride.driver.vehicle.plate} (${ride.driver.vehicle.model})\n` +
      `From: ${ride.pickup.address}\n` +
      `To: ${ride.drop.address}`
    );
    window.open(`https://wa.me/?text=${message}`);
  };

  const shareViaSMS = async (phoneNumber: string) => {
    const link = shareLink || await generateShareLink();
    window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(
      `Track my ride: ${link}`
    )}`;
  };

  const autoShareWithEmergencyContacts = async () => {
    // Auto-share with pre-configured emergency contacts
    const contacts = await getEmergencyContacts();
    for (const contact of contacts) {
      await sendShareNotification(contact, shareLink);
    }
    setSharedWith(contacts);
  };

  return (
    <div className="trip-sharing">
      <h3>Share Trip</h3>

      <div className="share-options">
        <button onClick={shareViaWhatsApp}>
          <WhatsAppIcon /> Share via WhatsApp
        </button>

        <button onClick={() => navigator.clipboard.writeText(shareLink)}>
          <LinkIcon /> Copy Link
        </button>

        <button onClick={autoShareWithEmergencyContacts}>
          <ContactsIcon /> Share with Emergency Contacts
        </button>
      </div>

      {sharedWith.length > 0 && (
        <div className="shared-with">
          <p>Shared with:</p>
          {sharedWith.map(contact => (
            <span key={contact.id} className="contact-chip">
              {contact.name} âœ“
            </span>
          ))}
        </div>
      )}

      {/* Shared trip viewer sees */}
      <div className="share-preview">
        <p>Recipients will see:</p>
        <ul>
          <li>Live location on map</li>
          <li>Driver details & vehicle info</li>
          <li>ETA to destination</li>
          <li>Your current status</li>
        </ul>
      </div>
    </div>
  );
};
```

### Driver Verification Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DRIVER VERIFICATION INDICATORS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Driver Card                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚   â”‚
â”‚  â”‚  â”‚  Photo   â”‚  Rajesh Kumar           â­ 4.8                       â”‚   â”‚
â”‚  â”‚  â”‚  [Live]  â”‚  âœ“ Background Verified                               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  âœ“ License Verified                                  â”‚   â”‚
â”‚  â”‚                 âœ“ 2,450 trips completed                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Vehicle: White Honda Activa                                        â”‚   â”‚
â”‚  â”‚  Plate: KA-01-AB-1234  âœ“ RC Verified                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  [Photo shows real-time selfie for face match]                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Verification Badges:                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  âœ“ Background Verified  - Criminal background check passed                 â”‚
â”‚  âœ“ License Verified     - Driving license validated with RTO              â”‚
â”‚  âœ“ RC Verified          - Vehicle registration confirmed                  â”‚
â”‚  âœ“ Face Match           - Real-time selfie matches profile photo          â”‚
â”‚  âœ“ COVID Vaccinated     - Vaccination certificate verified                â”‚
â”‚                                                                              â”‚
â”‚  Real-time Face Verification:                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  â€¢ Driver takes selfie before going online                                 â”‚
â”‚  â€¢ ML model compares with profile photo                                    â”‚
â”‚  â€¢ Prevents account sharing/fraud                                          â”‚
â”‚  â€¢ Rider sees "Photo verified today" indicator                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fraud Prevention UI

```typescript
// FraudDetection.tsx - Client-side fraud signals
const useFraudDetection = (ride: RideDetails) => {
  const [alerts, setAlerts] = useState<FraudAlert[]>([]);

  useEffect(() => {
    const checkFraudSignals = () => {
      const newAlerts: FraudAlert[] = [];

      // 1. Route deviation detection
      if (ride.status === 'on_trip') {
        const expectedRoute = ride.expectedPolyline;
        const currentLocation = ride.driverLocation;

        if (isDeviatingFromRoute(currentLocation, expectedRoute, 500)) { // 500m threshold
          newAlerts.push({
            type: 'route_deviation',
            severity: 'warning',
            message: 'Driver appears to be taking a different route',
            action: 'report_route',
          });
        }
      }

      // 2. Unusual stop detection
      if (ride.status === 'on_trip' && hasUnusualStop(ride.locationHistory)) {
        newAlerts.push({
          type: 'unusual_stop',
          severity: 'info',
          message: 'Vehicle has stopped for an extended period',
          action: 'check_status',
        });
      }

      // 3. Fare tampering indication
      if (ride.currentFare > ride.estimatedFare * 1.5) {
        newAlerts.push({
          type: 'fare_warning',
          severity: 'warning',
          message: 'Fare is significantly higher than estimate',
          action: 'view_breakdown',
        });
      }

      setAlerts(newAlerts);
    };

    const interval = setInterval(checkFraudSignals, 30000);
    return () => clearInterval(interval);
  }, [ride]);

  return alerts;
};

// Alert Display Component
const SafetyAlerts = ({ alerts }: { alerts: FraudAlert[] }) => {
  if (alerts.length === 0) return null;

  return (
    <div className="safety-alerts" role="alert">
      {alerts.map((alert, index) => (
        <div
          key={index}
          className={`alert alert-${alert.severity}`}
        >
          <AlertIcon type={alert.severity} />
          <p>{alert.message}</p>
          <button onClick={() => handleAlertAction(alert.action)}>
            {getActionLabel(alert.action)}
          </button>
        </div>
      ))}
    </div>
  );
};
```

---

## 14. Mobile & Touch Interactions

### Bottom Sheet Gestures

```typescript
// DraggableBottomSheet.tsx
import { useSpring, animated, config } from '@react-spring/web';
import { useDrag } from '@use-gesture/react';

const SNAP_POINTS = {
  collapsed: 120,   // Just the handle visible
  half: window.innerHeight * 0.5,
  full: window.innerHeight * 0.9,
};

const DraggableBottomSheet = ({ children, state }: BottomSheetProps) => {
  const [{ y }, api] = useSpring(() => ({
    y: SNAP_POINTS.half,
    config: config.stiff,
  }));

  const bind = useDrag(
    ({ movement: [, my], velocity: [, vy], direction: [, dy], cancel, active }) => {
      // Prevent dragging beyond bounds
      if (my < -SNAP_POINTS.full) cancel();

      if (active) {
        api.start({ y: SNAP_POINTS.half - my, immediate: true });
      } else {
        // Snap to nearest point based on velocity and position
        const currentY = SNAP_POINTS.half - my;

        let snapTo: number;
        if (vy > 0.5 && dy > 0) {
          // Fast swipe down
          snapTo = SNAP_POINTS.collapsed;
        } else if (vy > 0.5 && dy < 0) {
          // Fast swipe up
          snapTo = SNAP_POINTS.full;
        } else {
          // Snap to nearest
          snapTo = findNearestSnapPoint(currentY);
        }

        api.start({ y: snapTo });

        // Haptic feedback on snap
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    },
    {
      from: () => [0, SNAP_POINTS.half - y.get()],
      filterTaps: true,
      bounds: { top: -SNAP_POINTS.full, bottom: SNAP_POINTS.half },
      rubberband: true,
    }
  );

  // Auto-expand based on ride state
  useEffect(() => {
    const stateSnapPoints: Record<RideState, number> = {
      idle: SNAP_POINTS.collapsed,
      selecting: SNAP_POINTS.half,
      searching: SNAP_POINTS.half,
      matched: SNAP_POINTS.full,
      on_trip: SNAP_POINTS.half,
    };

    api.start({ y: stateSnapPoints[state] });
  }, [state]);

  return (
    <animated.div
      {...bind()}
      className="bottom-sheet"
      style={{
        height: y,
        touchAction: 'none',
      }}
    >
      <div className="drag-handle" aria-hidden="true">
        <div className="handle-bar" />
      </div>
      {children}
    </animated.div>
  );
};
```

### Map Gestures

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MAP GESTURE HANDLING                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Supported Gestures:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Gesture      â”‚                    Action                          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Single tap     â”‚  Select location / drop pin                       â”‚  â”‚
â”‚  â”‚  Double tap     â”‚  Zoom in at tap point                             â”‚  â”‚
â”‚  â”‚  Two-finger tap â”‚  Zoom out                                          â”‚  â”‚
â”‚  â”‚  Pan            â”‚  Move map                                          â”‚  â”‚
â”‚  â”‚  Pinch          â”‚  Zoom in/out                                       â”‚  â”‚
â”‚  â”‚  Long press     â”‚  Drop pickup/destination pin                      â”‚  â”‚
â”‚  â”‚  Rotate         â”‚  Rotate map (if enabled)                          â”‚  â”‚
â”‚  â”‚  Tilt           â”‚  Change map tilt (3D view)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  Drag-to-Adjust Pin:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                              â”‚
â”‚  const DraggablePin = ({ position, onPositionChange }) => {                â”‚
â”‚    const [isDragging, setIsDragging] = useState(false);                    â”‚
â”‚                                                                              â”‚
â”‚    return (                                                                  â”‚
â”‚      <Marker                                                                â”‚
â”‚        position={position}                                                  â”‚
â”‚        draggable={true}                                                     â”‚
â”‚        onDragStart={() => {                                                â”‚
â”‚          setIsDragging(true);                                              â”‚
â”‚          // Lift pin animation                                             â”‚
â”‚          // Vibrate feedback                                               â”‚
â”‚          navigator.vibrate?.(20);                                          â”‚
â”‚        }}                                                                   â”‚
â”‚        onDrag={(e) => {                                                    â”‚
â”‚          // Show address preview while dragging                            â”‚
â”‚          reverseGeocode(e.latlng);                                        â”‚
â”‚        }}                                                                   â”‚
â”‚        onDragEnd={(e) => {                                                 â”‚
â”‚          setIsDragging(false);                                             â”‚
â”‚          onPositionChange(e.latlng);                                       â”‚
â”‚          // Drop animation                                                  â”‚
â”‚          navigator.vibrate?.(30);                                          â”‚
â”‚        }}                                                                   â”‚
â”‚      >                                                                      â”‚
â”‚        <PinIcon lifted={isDragging} />                                     â”‚
â”‚      </Marker>                                                              â”‚
â”‚    );                                                                       â”‚
â”‚  };                                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Swipe Actions

```typescript
// SwipeableRideOption.tsx
import { useSwipeable } from 'react-swipeable';

const SwipeableRideCard = ({ ride, onSchedule, onShare }: SwipeableCardProps) => {
  const [swipeOffset, setSwipeOffset] = useState(0);
  const [showActions, setShowActions] = useState<'left' | 'right' | null>(null);

  const handlers = useSwipeable({
    onSwiping: (e) => {
      setSwipeOffset(e.deltaX);

      if (e.deltaX > 50) {
        setShowActions('right'); // Schedule action
      } else if (e.deltaX < -50) {
        setShowActions('left'); // Share action
      } else {
        setShowActions(null);
      }
    },
    onSwipedLeft: () => {
      if (swipeOffset < -100) {
        onShare(ride);
        navigator.vibrate?.(30);
      }
      resetSwipe();
    },
    onSwipedRight: () => {
      if (swipeOffset > 100) {
        onSchedule(ride);
        navigator.vibrate?.(30);
      }
      resetSwipe();
    },
    onTouchEndOrOnMouseUp: () => {
      resetSwipe();
    },
    trackMouse: true,
    preventScrollOnSwipe: true,
  });

  const resetSwipe = () => {
    setSwipeOffset(0);
    setShowActions(null);
  };

  return (
    <div className="swipeable-container">
      {/* Background actions */}
      <div className="swipe-actions">
        <div className={`action-left ${showActions === 'left' ? 'active' : ''}`}>
          <ShareIcon /> Share
        </div>
        <div className={`action-right ${showActions === 'right' ? 'active' : ''}`}>
          <ClockIcon /> Schedule
        </div>
      </div>

      {/* Card content */}
      <div
        {...handlers}
        className="ride-card"
        style={{
          transform: `translateX(${swipeOffset}px)`,
          transition: swipeOffset === 0 ? 'transform 0.3s ease' : 'none',
        }}
      >
        <RideOptionCard ride={ride} />
      </div>
    </div>
  );
};
```

### Haptic Feedback Patterns

```typescript
// useHaptics.ts
const useHaptics = () => {
  const vibrate = useCallback((pattern: number | number[]) => {
    if ('vibrate' in navigator) {
      navigator.vibrate(pattern);
    }
  }, []);

  return {
    // Light tap for selections
    tap: () => vibrate(10),

    // Medium for confirmations
    confirm: () => vibrate(30),

    // Success pattern
    success: () => vibrate([30, 50, 30]),

    // Error/warning pattern
    error: () => vibrate([50, 30, 50, 30, 50]),

    // Notification pattern
    notification: () => vibrate([100, 50, 100]),

    // Long press acknowledgment
    longPress: () => vibrate(50),

    // SOS pattern (urgent)
    sos: () => vibrate([200, 100, 200, 100, 200]),
  };
};

// Usage in components
const BookButton = () => {
  const haptics = useHaptics();

  const handleBook = async () => {
    haptics.tap();

    try {
      await bookRide();
      haptics.success();
    } catch (error) {
      haptics.error();
    }
  };

  return <button onClick={handleBook}>Book Ride</button>;
};
```

### Pull-to-Refresh

```typescript
// PullToRefresh.tsx
const PullToRefresh = ({ onRefresh, children }: PullToRefreshProps) => {
  const [pulling, setPulling] = useState(false);
  const [pullDistance, setPullDistance] = useState(0);
  const [refreshing, setRefreshing] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);
  const startY = useRef(0);

  const THRESHOLD = 80;

  const handleTouchStart = (e: TouchEvent) => {
    if (containerRef.current?.scrollTop === 0) {
      startY.current = e.touches[0].clientY;
      setPulling(true);
    }
  };

  const handleTouchMove = (e: TouchEvent) => {
    if (!pulling) return;

    const currentY = e.touches[0].clientY;
    const distance = Math.max(0, currentY - startY.current);

    // Apply resistance
    const resistance = 0.4;
    const adjustedDistance = distance * resistance;

    setPullDistance(Math.min(adjustedDistance, THRESHOLD * 1.5));
  };

  const handleTouchEnd = async () => {
    if (pullDistance >= THRESHOLD) {
      setRefreshing(true);
      navigator.vibrate?.(30);

      try {
        await onRefresh();
      } finally {
        setRefreshing(false);
      }
    }

    setPulling(false);
    setPullDistance(0);
  };

  return (
    <div
      ref={containerRef}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
      className="pull-to-refresh-container"
    >
      <div
        className="refresh-indicator"
        style={{
          height: pullDistance,
          opacity: pullDistance / THRESHOLD,
        }}
      >
        {refreshing ? (
          <Spinner />
        ) : (
          <ArrowDown
            style={{
              transform: `rotate(${pullDistance >= THRESHOLD ? 180 : 0}deg)`,
              transition: 'transform 0.2s',
            }}
          />
        )}
      </div>

      <div
        style={{
          transform: `translateY(${pullDistance}px)`,
          transition: pulling ? 'none' : 'transform 0.3s ease',
        }}
      >
        {children}
      </div>
    </div>
  );
};
```

### Responsive Touch Targets

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOUCH TARGET GUIDELINES                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Minimum Touch Target Sizes:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚  â€¢ Minimum: 44Ã—44px (Apple HIG) / 48Ã—48dp (Material Design)                â”‚
â”‚  â€¢ Recommended for primary actions: 56Ã—56px                                â”‚
â”‚  â€¢ Critical actions (SOS, Book): 64Ã—64px                                   â”‚
â”‚                                                                              â”‚
â”‚  CSS Implementation:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  .touch-target {                                                            â”‚
â”‚    /* Visual size can be smaller */                                        â”‚
â”‚    width: 24px;                                                             â”‚
â”‚    height: 24px;                                                            â”‚
â”‚                                                                              â”‚
â”‚    /* But hit area is larger */                                            â”‚
â”‚    position: relative;                                                      â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  .touch-target::before {                                                   â”‚
â”‚    content: '';                                                             â”‚
â”‚    position: absolute;                                                      â”‚
â”‚    top: -12px;                                                              â”‚
â”‚    left: -12px;                                                             â”‚
â”‚    right: -12px;                                                            â”‚
â”‚    bottom: -12px;                                                           â”‚
â”‚    /* Creates 48Ã—48px hit area around 24Ã—24px icon */                     â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  Spacing Between Targets:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  â€¢ Minimum 8px gap between touch targets                                   â”‚
â”‚  â€¢ Recommended 16px for related actions                                    â”‚
â”‚  â€¢ 24px+ for unrelated actions to prevent mis-taps                        â”‚
â”‚                                                                              â”‚
â”‚  Example - Action Buttons:                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    16px    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    16px   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”‚   ğŸ“ Call   â”‚   <â”€â”€>    â”‚  ğŸ’¬ Chat   â”‚   <â”€â”€>   â”‚ âŒ Cancelâ”‚ â”‚  â”‚
â”‚  â”‚   â”‚   (56Ã—48)   â”‚            â”‚   (56Ã—48)   â”‚           â”‚  (56Ã—48) â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 15. Testing Strategy

### Testing Pyramid for Ride Booking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TESTING PYRAMID                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚                          /   E2E    \          5%                          â”‚
â”‚                         /  (Cypress/ \         â€¢ Critical booking flow     â”‚
â”‚                        /  Playwright) \        â€¢ Payment completion        â”‚
â”‚                       /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-\                                    â”‚
â”‚                      /   Integration    \      20%                         â”‚
â”‚                     /   (MSW + RTL)      \     â€¢ WebSocket events          â”‚
â”‚                    /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-\    â€¢ Map interactions          â”‚
â”‚                   /        Unit Tests      \   75%                         â”‚
â”‚                  /     (Jest + RTL)         \  â€¢ State machine             â”‚
â”‚                 /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ â€¢ Fare calculations         â”‚
â”‚                                               â€¢ Components                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Unit Tests - Ride State Machine

```typescript
// rideStateMachine.test.ts
import { rideReducer, initialState, RideAction } from './rideStateMachine';

describe('Ride State Machine', () => {
  it('should transition from idle to searching on ride request', () => {
    const action: RideAction = {
      type: 'REQUEST_RIDE',
      payload: {
        pickup: { lat: 12.97, lng: 77.59, address: 'MG Road' },
        drop: { lat: 12.93, lng: 77.62, address: 'Indiranagar' },
        vehicleType: 'auto',
      },
    };

    const newState = rideReducer(initialState, action);

    expect(newState.status).toBe('searching');
    expect(newState.pickup).toEqual(action.payload.pickup);
    expect(newState.drop).toEqual(action.payload.drop);
  });

  it('should transition from searching to matched when driver found', () => {
    const searchingState = { ...initialState, status: 'searching' };

    const action: RideAction = {
      type: 'DRIVER_MATCHED',
      payload: {
        driver: {
          id: 'driver_123',
          name: 'Rajesh',
          rating: 4.8,
          vehicle: { model: 'Activa', plate: 'KA-01-1234' },
        },
        otp: '4521',
        eta: 3,
      },
    };

    const newState = rideReducer(searchingState, action);

    expect(newState.status).toBe('matched');
    expect(newState.driver).toEqual(action.payload.driver);
    expect(newState.otp).toBe('4521');
  });

  it('should allow cancellation from any active state', () => {
    const activeStates = ['searching', 'matched', 'driver_arriving'];

    activeStates.forEach(status => {
      const state = { ...initialState, status };
      const action: RideAction = {
        type: 'CANCEL_RIDE',
        payload: { reason: 'Changed plans' },
      };

      const newState = rideReducer(state, action);
      expect(newState.status).toBe('cancelled');
    });
  });

  it('should NOT allow cancellation once trip started', () => {
    const onTripState = { ...initialState, status: 'on_trip' };

    const action: RideAction = {
      type: 'CANCEL_RIDE',
      payload: { reason: 'Changed plans' },
    };

    const newState = rideReducer(onTripState, action);

    // State should not change
    expect(newState.status).toBe('on_trip');
  });

  it('should update driver location without changing ride status', () => {
    const matchedState = {
      ...initialState,
      status: 'matched',
      driverLocation: { lat: 12.97, lng: 77.59 },
    };

    const action: RideAction = {
      type: 'UPDATE_DRIVER_LOCATION',
      payload: { lat: 12.971, lng: 77.591, heading: 45 },
    };

    const newState = rideReducer(matchedState, action);

    expect(newState.status).toBe('matched'); // Unchanged
    expect(newState.driverLocation).toEqual(action.payload);
  });
});
```

### WebSocket Mocking

```typescript
// websocket.test.ts
import { render, screen, waitFor } from '@testing-library/react';
import WS from 'jest-websocket-mock';
import { RideTracker } from './RideTracker';
import { WebSocketProvider } from './WebSocketContext';

describe('WebSocket Integration', () => {
  let server: WS;

  beforeEach(() => {
    server = new WS('wss://api.ride.com/ws');
  });

  afterEach(() => {
    WS.clean();
  });

  it('should update driver location on WebSocket message', async () => {
    render(
      <WebSocketProvider>
        <RideTracker rideId="ride_123" />
      </WebSocketProvider>
    );

    await server.connected;

    // Simulate server sending driver location
    server.send(JSON.stringify({
      type: 'driver_location',
      rideId: 'ride_123',
      location: { lat: 12.97, lng: 77.59 },
      eta: 2,
    }));

    await waitFor(() => {
      expect(screen.getByText('2 min away')).toBeInTheDocument();
    });
  });

  it('should show driver matched notification', async () => {
    render(
      <WebSocketProvider>
        <RideTracker rideId="ride_123" />
      </WebSocketProvider>
    );

    await server.connected;

    server.send(JSON.stringify({
      type: 'driver_matched',
      rideId: 'ride_123',
      driver: {
        name: 'Rajesh',
        rating: 4.8,
        vehicle: { model: 'Honda Activa', plate: 'KA-01-1234' },
      },
      otp: '4521',
      eta: 3,
    }));

    await waitFor(() => {
      expect(screen.getByText('Rajesh')).toBeInTheDocument();
      expect(screen.getByText('4521')).toBeInTheDocument();
    });
  });

  it('should handle WebSocket reconnection', async () => {
    const onReconnect = jest.fn();

    render(
      <WebSocketProvider onReconnect={onReconnect}>
        <RideTracker rideId="ride_123" />
      </WebSocketProvider>
    );

    await server.connected;

    // Simulate connection drop
    server.close();

    // Create new server for reconnection
    server = new WS('wss://api.ride.com/ws');

    await waitFor(() => {
      expect(onReconnect).toHaveBeenCalled();
    });
  });

  it('should queue messages during reconnection', async () => {
    render(
      <WebSocketProvider>
        <RideTracker rideId="ride_123" />
      </WebSocketProvider>
    );

    await server.connected;

    // Close connection
    server.close();

    // Try to send location update while disconnected
    // (would be queued)

    // Reconnect
    server = new WS('wss://api.ride.com/ws');
    await server.connected;

    // Verify queued message was sent
    await expect(server).toReceiveMessage(
      expect.stringContaining('location_update')
    );
  });
});
```

### Geolocation Mocking

```typescript
// geolocation.test.ts
import { renderHook, act } from '@testing-library/react';
import { useCurrentLocation } from './useCurrentLocation';

const mockGeolocation = {
  getCurrentPosition: jest.fn(),
  watchPosition: jest.fn(),
  clearWatch: jest.fn(),
};

Object.defineProperty(global.navigator, 'geolocation', {
  value: mockGeolocation,
  writable: true,
});

describe('useCurrentLocation', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should return current location on success', async () => {
    const mockPosition = {
      coords: {
        latitude: 12.9716,
        longitude: 77.5946,
        accuracy: 10,
      },
      timestamp: Date.now(),
    };

    mockGeolocation.getCurrentPosition.mockImplementation((success) => {
      success(mockPosition);
    });

    const { result } = renderHook(() => useCurrentLocation());

    await act(async () => {
      await result.current.getLocation();
    });

    expect(result.current.location).toEqual({
      lat: 12.9716,
      lng: 77.5946,
    });
    expect(result.current.error).toBeNull();
  });

  it('should handle permission denied error', async () => {
    const permissionError = {
      code: 1,
      message: 'User denied geolocation',
      PERMISSION_DENIED: 1,
    };

    mockGeolocation.getCurrentPosition.mockImplementation((_, error) => {
      error(permissionError);
    });

    const { result } = renderHook(() => useCurrentLocation());

    await act(async () => {
      await result.current.getLocation();
    });

    expect(result.current.location).toBeNull();
    expect(result.current.error).toBe('Location permission denied');
  });

  it('should watch location updates', async () => {
    const watchId = 123;
    mockGeolocation.watchPosition.mockReturnValue(watchId);

    const { result, unmount } = renderHook(() => useCurrentLocation());

    act(() => {
      result.current.startWatching();
    });

    expect(mockGeolocation.watchPosition).toHaveBeenCalled();

    // Cleanup on unmount
    unmount();
    expect(mockGeolocation.clearWatch).toHaveBeenCalledWith(watchId);
  });
});
```

### Integration Tests - Booking Flow

```typescript
// bookingFlow.integration.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { RideBookingApp } from './RideBookingApp';

const server = setupServer(
  // Autocomplete API
  rest.get('/api/v1/places/autocomplete', (req, res, ctx) => {
    return res(ctx.json({
      predictions: [
        { placeId: 'place_1', name: 'MG Road', address: 'Bangalore' },
        { placeId: 'place_2', name: 'MG Road Metro', address: 'Bangalore' },
      ],
    }));
  }),

  // Fare estimate API
  rest.post('/api/v1/rides/estimate', (req, res, ctx) => {
    return res(ctx.json({
      options: [
        { type: 'auto', fareRange: { min: 85, max: 95 }, eta: 3 },
        { type: 'bike', fareRange: { min: 45, max: 55 }, eta: 2 },
      ],
    }));
  }),

  // Book ride API
  rest.post('/api/v1/rides', (req, res, ctx) => {
    return res(ctx.json({
      rideId: 'ride_123',
      status: 'searching',
    }));
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('Ride Booking Flow', () => {
  it('should complete full booking flow', async () => {
    const user = userEvent.setup();
    render(<RideBookingApp />);

    // Step 1: Enter pickup location
    const pickupInput = screen.getByPlaceholderText('Enter pickup location');
    await user.type(pickupInput, 'MG Road');

    await waitFor(() => {
      expect(screen.getByText('MG Road Metro')).toBeInTheDocument();
    });

    await user.click(screen.getByText('MG Road Metro'));

    // Step 2: Enter drop location
    const dropInput = screen.getByPlaceholderText('Enter destination');
    await user.type(dropInput, 'Indiranagar');

    await waitFor(() => {
      expect(screen.getByText('Indiranagar')).toBeInTheDocument();
    });

    await user.click(screen.getByText('Indiranagar'));

    // Step 3: Verify fare options shown
    await waitFor(() => {
      expect(screen.getByText('â‚¹85-95')).toBeInTheDocument();
      expect(screen.getByText('Auto')).toBeInTheDocument();
    });

    // Step 4: Select ride type and book
    await user.click(screen.getByText('Auto'));
    await user.click(screen.getByRole('button', { name: /book/i }));

    // Step 5: Verify searching state
    await waitFor(() => {
      expect(screen.getByText(/finding your ride/i)).toBeInTheDocument();
    });
  });

  it('should handle fare estimation error gracefully', async () => {
    server.use(
      rest.post('/api/v1/rides/estimate', (req, res, ctx) => {
        return res(ctx.status(500), ctx.json({ error: 'Service unavailable' }));
      })
    );

    const user = userEvent.setup();
    render(<RideBookingApp />);

    // Enter locations...
    // ...

    await waitFor(() => {
      expect(screen.getByText(/unable to get fare/i)).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument();
    });
  });
});
```

### E2E Tests - Critical Paths

```typescript
// ride-booking.e2e.spec.ts (Playwright)
import { test, expect } from '@playwright/test';

test.describe('Ride Booking E2E', () => {
  test.beforeEach(async ({ page }) => {
    // Mock geolocation
    await page.context().setGeolocation({ latitude: 12.9716, longitude: 77.5946 });
    await page.context().grantPermissions(['geolocation']);
  });

  test('complete ride booking from search to driver match', async ({ page }) => {
    await page.goto('/');

    // Enter pickup
    await page.getByPlaceholder('Enter pickup location').fill('MG Road');
    await page.getByText('MG Road Metro Station').click();

    // Enter destination
    await page.getByPlaceholder('Enter destination').fill('Indiranagar');
    await page.getByText('Indiranagar 100ft Road').click();

    // Wait for fare estimates
    await expect(page.getByText('Auto')).toBeVisible();
    await expect(page.getByText(/â‚¹\d+-\d+/)).toBeVisible();

    // Select ride type
    await page.getByText('Auto').click();

    // Click book
    await page.getByRole('button', { name: 'Book Auto' }).click();

    // Verify searching state
    await expect(page.getByText('Finding your ride')).toBeVisible();

    // Wait for driver match (mocked via WebSocket)
    await expect(page.getByText('Driver found!')).toBeVisible({ timeout: 10000 });

    // Verify driver details shown
    await expect(page.getByText('OTP')).toBeVisible();
    await expect(page.getByText(/KA-\d{2}-[A-Z]{2}-\d{4}/)).toBeVisible();
  });

  test('should handle ride cancellation', async ({ page }) => {
    await page.goto('/ride/active');

    // Assume we're in matched state
    await page.getByRole('button', { name: 'Cancel' }).click();

    // Confirm cancellation
    await page.getByRole('button', { name: 'Yes, Cancel Ride' }).click();

    // Verify cancellation
    await expect(page.getByText('Ride cancelled')).toBeVisible();

    // Should show cancellation fee if applicable
    // await expect(page.getByText(/cancellation fee/i)).toBeVisible();
  });

  test('should show SOS button during active ride', async ({ page }) => {
    await page.goto('/ride/active?status=on_trip');

    // SOS button should be visible
    const sosButton = page.getByRole('button', { name: /sos/i });
    await expect(sosButton).toBeVisible();

    // Long press to activate
    await sosButton.click({ delay: 3500 });

    // Countdown should appear
    await expect(page.getByText(/contacting emergency/i)).toBeVisible();

    // Cancel before it triggers
    await page.getByRole('button', { name: 'Cancel' }).click();
  });
});
```

---

## 16. Offline/PWA Capabilities

### Service Worker Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE WORKER CACHING STRATEGY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     Resource       â”‚              Strategy                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  App Shell         â”‚  Cache-First (precache)                         â”‚  â”‚
â”‚  â”‚  (HTML, JS, CSS)   â”‚  Update in background                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Map Tiles         â”‚  Cache-First with fallback                      â”‚  â”‚
â”‚  â”‚                    â”‚  Store frequently accessed areas                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Static Assets     â”‚  Cache-First                                     â”‚  â”‚
â”‚  â”‚  (icons, images)   â”‚  Long-lived cache                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  API: User Profile â”‚  Stale-While-Revalidate                         â”‚  â”‚
â”‚  â”‚                    â”‚  Show cached, update in background              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  API: Ride History â”‚  Network-First, Cache fallback                  â”‚  â”‚
â”‚  â”‚                    â”‚  Need fresh data, but show cached if offline   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  API: Fare/ETA     â”‚  Network-Only                                    â”‚  â”‚
â”‚  â”‚                    â”‚  Must be real-time, no caching                  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Active Ride       â”‚  Network-First + Background Sync                â”‚  â”‚
â”‚  â”‚                    â”‚  Queue actions, sync when online               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workbox Configuration

```typescript
// service-worker.ts (Workbox)
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import {
  CacheFirst,
  NetworkFirst,
  StaleWhileRevalidate,
} from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';
import { BackgroundSyncPlugin } from 'workbox-background-sync';

// Precache app shell
precacheAndRoute(self.__WB_MANIFEST);

// Map tiles - Cache first with expiration
registerRoute(
  ({ url }) => url.hostname.includes('maps.googleapis.com') ||
               url.hostname.includes('tiles.mapbox.com'),
  new CacheFirst({
    cacheName: 'map-tiles',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 500, // Limit cache size
        maxAgeSeconds: 7 * 24 * 60 * 60, // 7 days
      }),
    ],
  })
);

// User profile - Stale while revalidate
registerRoute(
  ({ url }) => url.pathname.includes('/api/v1/users/me'),
  new StaleWhileRevalidate({
    cacheName: 'user-profile',
  })
);

// Ride history - Network first with cache fallback
registerRoute(
  ({ url }) => url.pathname.includes('/api/v1/rides') &&
               url.searchParams.has('history'),
  new NetworkFirst({
    cacheName: 'ride-history',
    networkTimeoutSeconds: 5,
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 24 * 60 * 60, // 24 hours
      }),
    ],
  })
);

// Background sync for ride actions
const bgSyncPlugin = new BackgroundSyncPlugin('rideActions', {
  maxRetentionTime: 24 * 60, // 24 hours in minutes
});

registerRoute(
  ({ url }) => url.pathname.includes('/api/v1/rides') &&
               ['POST', 'PUT', 'DELETE'].includes(request.method),
  new NetworkFirst({
    plugins: [bgSyncPlugin],
  }),
  'POST'
);
```

### Offline Ride History

```typescript
// offlineRideHistory.ts
import Dexie from 'dexie';

interface RideRecord {
  id: string;
  pickup: { address: string; lat: number; lng: number };
  drop: { address: string; lat: number; lng: number };
  fare: number;
  date: Date;
  driver: { name: string; rating: number };
  status: string;
  synced: boolean;
}

class RideDatabase extends Dexie {
  rides!: Dexie.Table<RideRecord, string>;

  constructor() {
    super('RideBookingDB');
    this.version(1).stores({
      rides: 'id, date, status, synced',
    });
  }
}

const db = new RideDatabase();

// Save ride locally
export const saveRideLocally = async (ride: RideRecord) => {
  await db.rides.put({ ...ride, synced: navigator.onLine });
};

// Get ride history (offline-capable)
export const getRideHistory = async (limit = 20): Promise<RideRecord[]> => {
  return await db.rides
    .orderBy('date')
    .reverse()
    .limit(limit)
    .toArray();
};

// Sync unsynced rides when online
export const syncPendingRides = async () => {
  const unsyncedRides = await db.rides
    .where('synced')
    .equals(false)
    .toArray();

  for (const ride of unsyncedRides) {
    try {
      await fetch('/api/v1/rides/sync', {
        method: 'POST',
        body: JSON.stringify(ride),
      });
      await db.rides.update(ride.id, { synced: true });
    } catch (error) {
      console.error('Failed to sync ride:', ride.id);
    }
  }
};

// Listen for online event
window.addEventListener('online', syncPendingRides);
```

### Connection Status Handler

```typescript
// useConnectionStatus.ts
const useConnectionStatus = () => {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [connectionQuality, setConnectionQuality] = useState<'good' | 'slow' | 'offline'>('good');

  useEffect(() => {
    const handleOnline = () => {
      setIsOnline(true);
      checkConnectionQuality();
    };

    const handleOffline = () => {
      setIsOnline(false);
      setConnectionQuality('offline');
    };

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    // Check connection quality periodically
    const checkConnectionQuality = async () => {
      if (!navigator.onLine) {
        setConnectionQuality('offline');
        return;
      }

      const connection = (navigator as any).connection;
      if (connection) {
        if (connection.effectiveType === '4g') {
          setConnectionQuality('good');
        } else if (['3g', '2g'].includes(connection.effectiveType)) {
          setConnectionQuality('slow');
        }
      }
    };

    const interval = setInterval(checkConnectionQuality, 30000);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      clearInterval(interval);
    };
  }, []);

  return { isOnline, connectionQuality };
};

// ConnectionBanner.tsx
const ConnectionBanner = () => {
  const { isOnline, connectionQuality } = useConnectionStatus();

  if (isOnline && connectionQuality === 'good') return null;

  return (
    <div
      className={`connection-banner ${connectionQuality}`}
      role="alert"
      aria-live="polite"
    >
      {!isOnline ? (
        <>
          <WifiOffIcon />
          <span>You're offline. Some features may be limited.</span>
        </>
      ) : connectionQuality === 'slow' ? (
        <>
          <SlowConnectionIcon />
          <span>Slow connection detected. Updates may be delayed.</span>
        </>
      ) : null}
    </div>
  );
};
```

### Queued Actions (Cancellation, Rating)

```typescript
// queuedActions.ts
interface QueuedAction {
  id: string;
  type: 'cancel_ride' | 'rate_ride' | 'report_issue';
  payload: any;
  timestamp: number;
  retries: number;
}

const ACTION_QUEUE_KEY = 'ride_action_queue';

// Add action to queue
export const queueAction = (action: Omit<QueuedAction, 'id' | 'timestamp' | 'retries'>) => {
  const queue = getActionQueue();
  const newAction: QueuedAction = {
    ...action,
    id: generateId(),
    timestamp: Date.now(),
    retries: 0,
  };

  queue.push(newAction);
  localStorage.setItem(ACTION_QUEUE_KEY, JSON.stringify(queue));

  // Try to process immediately if online
  if (navigator.onLine) {
    processActionQueue();
  }
};

// Get queued actions
export const getActionQueue = (): QueuedAction[] => {
  const stored = localStorage.getItem(ACTION_QUEUE_KEY);
  return stored ? JSON.parse(stored) : [];
};

// Process queue when online
export const processActionQueue = async () => {
  const queue = getActionQueue();
  const remainingActions: QueuedAction[] = [];

  for (const action of queue) {
    try {
      await processAction(action);
    } catch (error) {
      if (action.retries < 3) {
        remainingActions.push({ ...action, retries: action.retries + 1 });
      } else {
        // Log failed action for manual review
        console.error('Action failed after 3 retries:', action);
      }
    }
  }

  localStorage.setItem(ACTION_QUEUE_KEY, JSON.stringify(remainingActions));
};

const processAction = async (action: QueuedAction) => {
  const endpoints: Record<string, string> = {
    cancel_ride: '/api/v1/rides/cancel',
    rate_ride: '/api/v1/rides/rate',
    report_issue: '/api/v1/support/report',
  };

  const response = await fetch(endpoints[action.type], {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(action.payload),
  });

  if (!response.ok) {
    throw new Error(`Action failed: ${response.status}`);
  }
};

// Register background sync
if ('serviceWorker' in navigator && 'SyncManager' in window) {
  navigator.serviceWorker.ready.then((registration) => {
    // Request background sync when actions are queued
    return registration.sync.register('sync-ride-actions');
  });
}
```

### PWA Install Prompt

```typescript
// usePWAInstall.ts
const usePWAInstall = () => {
  const [installPrompt, setInstallPrompt] = useState<any>(null);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    const handleBeforeInstall = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e);
    };

    const handleAppInstalled = () => {
      setIsInstalled(true);
      setInstallPrompt(null);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstall);
    window.addEventListener('appinstalled', handleAppInstalled);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
      window.removeEventListener('appinstalled', handleAppInstalled);
    };
  }, []);

  const promptInstall = async () => {
    if (!installPrompt) return false;

    installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;

    setInstallPrompt(null);
    return outcome === 'accepted';
  };

  return {
    canInstall: !!installPrompt && !isInstalled,
    isInstalled,
    promptInstall,
  };
};

// InstallBanner.tsx
const InstallBanner = () => {
  const { canInstall, promptInstall } = usePWAInstall();
  const [dismissed, setDismissed] = useState(false);

  if (!canInstall || dismissed) return null;

  return (
    <div className="install-banner">
      <div className="install-content">
        <AppIcon />
        <div>
          <p>Install RideApp for faster booking</p>
          <span>Works offline â€¢ Quick access</span>
        </div>
      </div>
      <div className="install-actions">
        <button onClick={() => setDismissed(true)}>Not now</button>
        <button onClick={promptInstall} className="primary">Install</button>
      </div>
    </div>
  );
};
```

---

## 17. Maps Deep Dive

### Map Provider Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MAP PROVIDER COMPARISON                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Feature      â”‚  Google Maps    â”‚    Mapbox       â”‚   OpenStreetMap â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Pricing        â”‚  Pay-per-use    â”‚  Subscription   â”‚  Free           â”‚ â”‚
â”‚  â”‚                 â”‚  $7/1K loads    â”‚  + pay-per-use  â”‚  (self-host)    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  India Coverage â”‚  Excellent      â”‚  Good           â”‚  Variable       â”‚ â”‚
â”‚  â”‚                 â”‚  Best POI data  â”‚                 â”‚                 â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Directions API â”‚  âœ“ Included     â”‚  âœ“ Included     â”‚  OSRM needed    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Places API     â”‚  âœ“ Best-in-classâ”‚  âœ“ Good         â”‚  Nominatim      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Customization  â”‚  Limited        â”‚  Full control   â”‚  Full control   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Offline Maps   â”‚  Limited        â”‚  âœ“ Supported    â”‚  âœ“ Supported    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Real-time      â”‚  âœ“ Traffic      â”‚  âœ“ Traffic      â”‚  âœ— Limited      â”‚ â”‚
â”‚  â”‚  Traffic        â”‚  Best in India  â”‚                 â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Recommendation for India:                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  Google Maps for: Rider-facing apps (best POI, traffic, directions)       â”‚
â”‚  Mapbox for: Custom branding, advanced visualizations                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Custom Driver Markers with Rotation

```typescript
// DriverMarker.tsx
import { useEffect, useRef, useState } from 'react';

interface DriverMarkerProps {
  position: { lat: number; lng: number };
  heading: number; // 0-360 degrees
  vehicleType: 'auto' | 'bike' | 'car';
  isSelected?: boolean;
}

const DriverMarker = ({ position, heading, vehicleType, isSelected }: DriverMarkerProps) => {
  const markerRef = useRef<google.maps.Marker | null>(null);
  const [prevPosition, setPrevPosition] = useState(position);

  // Smooth position animation
  useEffect(() => {
    if (!markerRef.current) return;

    const animate = () => {
      const startLat = prevPosition.lat;
      const startLng = prevPosition.lng;
      const endLat = position.lat;
      const endLng = position.lng;

      const duration = 1000; // 1 second animation
      const startTime = performance.now();

      const step = (currentTime: number) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Ease-out animation
        const easeProgress = 1 - Math.pow(1 - progress, 3);

        const currentLat = startLat + (endLat - startLat) * easeProgress;
        const currentLng = startLng + (endLng - startLng) * easeProgress;

        markerRef.current?.setPosition({ lat: currentLat, lng: currentLng });

        if (progress < 1) {
          requestAnimationFrame(step);
        } else {
          setPrevPosition(position);
        }
      };

      requestAnimationFrame(step);
    };

    animate();
  }, [position]);

  // Update rotation
  useEffect(() => {
    if (!markerRef.current) return;

    const icon = markerRef.current.getIcon() as google.maps.Symbol;
    markerRef.current.setIcon({
      ...icon,
      rotation: heading,
    });
  }, [heading]);

  // Create custom SVG icon
  const getVehicleIcon = (): google.maps.Symbol => {
    const icons = {
      auto: `M12 2L4 8v6l8 6 8-6V8l-8-6z`, // Auto rickshaw shape
      bike: `M12 2L6 8v4l6 6 6-6V8l-6-6z`,  // Bike shape
      car: `M5 11l2-6h10l2 6H5zm1 3a2 2 0 104 0 2 2 0 00-4 0zm8 0a2 2 0 104 0 2 2 0 00-4 0z`,
    };

    return {
      path: icons[vehicleType],
      fillColor: isSelected ? '#2196F3' : '#4CAF50',
      fillOpacity: 1,
      strokeColor: '#FFFFFF',
      strokeWeight: 2,
      scale: isSelected ? 2 : 1.5,
      rotation: heading,
      anchor: new google.maps.Point(12, 12),
    };
  };

  return (
    <Marker
      ref={markerRef}
      position={position}
      icon={getVehicleIcon()}
      zIndex={isSelected ? 1000 : 100}
    />
  );
};

// Usage with multiple drivers
const DriversOnMap = ({ drivers, selectedDriverId }: DriversOnMapProps) => {
  return (
    <>
      {drivers.map(driver => (
        <DriverMarker
          key={driver.id}
          position={driver.location}
          heading={driver.heading}
          vehicleType={driver.vehicleType}
          isSelected={driver.id === selectedDriverId}
        />
      ))}
    </>
  );
};
```

### Route Polyline with Animation

```typescript
// AnimatedRoute.tsx
const AnimatedRoute = ({ encodedPath, isActive }: AnimatedRouteProps) => {
  const [decodedPath, setDecodedPath] = useState<google.maps.LatLng[]>([]);
  const [animatedPath, setAnimatedPath] = useState<google.maps.LatLng[]>([]);

  useEffect(() => {
    // Decode polyline from Google Directions API
    const path = google.maps.geometry.encoding.decodePath(encodedPath);
    setDecodedPath(path);

    // Animate path drawing
    if (isActive) {
      animatePathDrawing(path);
    } else {
      setAnimatedPath(path);
    }
  }, [encodedPath, isActive]);

  const animatePathDrawing = (path: google.maps.LatLng[]) => {
    const totalPoints = path.length;
    const duration = 1500; // 1.5 seconds
    const startTime = performance.now();

    const step = (currentTime: number) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const pointsToShow = Math.floor(progress * totalPoints);

      setAnimatedPath(path.slice(0, pointsToShow));

      if (progress < 1) {
        requestAnimationFrame(step);
      }
    };

    requestAnimationFrame(step);
  };

  return (
    <>
      {/* Background path (gray) */}
      <Polyline
        path={decodedPath}
        options={{
          strokeColor: '#E0E0E0',
          strokeWeight: 6,
          strokeOpacity: 0.8,
        }}
      />

      {/* Animated foreground path (blue) */}
      <Polyline
        path={animatedPath}
        options={{
          strokeColor: '#2196F3',
          strokeWeight: 6,
          strokeOpacity: 1,
          icons: [{
            icon: {
              path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
              scale: 3,
              fillColor: '#2196F3',
              fillOpacity: 1,
            },
            offset: '100%',
          }],
        }}
      />
    </>
  );
};
```

### Marker Clustering

```typescript
// MarkerClusterer.tsx
import { MarkerClusterer } from '@googlemaps/markerclusterer';

const DriverClusterer = ({ map, drivers }: DriverClustererProps) => {
  const clustererRef = useRef<MarkerClusterer | null>(null);

  useEffect(() => {
    if (!map) return;

    // Create markers
    const markers = drivers.map(driver => {
      return new google.maps.Marker({
        position: driver.location,
        icon: getDriverIcon(driver.vehicleType),
        title: `${driver.vehicleType} - ${driver.eta} min`,
      });
    });

    // Create clusterer with custom renderer
    clustererRef.current = new MarkerClusterer({
      map,
      markers,
      renderer: {
        render: ({ count, position }) => {
          return new google.maps.Marker({
            position,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 20 + Math.log(count) * 5,
              fillColor: '#4CAF50',
              fillOpacity: 0.9,
              strokeColor: '#FFFFFF',
              strokeWeight: 2,
            },
            label: {
              text: String(count),
              color: '#FFFFFF',
              fontSize: '12px',
              fontWeight: 'bold',
            },
            zIndex: 1000 + count,
          });
        },
      },
      // Only cluster when zoomed out
      algorithm: new SuperClusterAlgorithm({
        maxZoom: 14, // Don't cluster above zoom 14
        radius: 100,
      }),
    });

    return () => {
      clustererRef.current?.clearMarkers();
    };
  }, [map, drivers]);

  return null;
};
```

### Geocoding & Reverse Geocoding

```typescript
// useGeocoding.ts
const useGeocoding = () => {
  const geocoder = useMemo(() => new google.maps.Geocoder(), []);
  const [cache, setCache] = useState<Map<string, string>>(new Map());

  const reverseGeocode = useCallback(async (
    lat: number,
    lng: number
  ): Promise<string> => {
    const cacheKey = `${lat.toFixed(4)},${lng.toFixed(4)}`;

    // Check cache first
    if (cache.has(cacheKey)) {
      return cache.get(cacheKey)!;
    }

    try {
      const response = await geocoder.geocode({
        location: { lat, lng },
      });

      if (response.results[0]) {
        // Get most relevant address component
        const result = response.results[0];
        const address = formatAddress(result);

        // Cache result
        setCache(prev => new Map(prev).set(cacheKey, address));

        return address;
      }

      return 'Unknown location';
    } catch (error) {
      console.error('Geocoding failed:', error);
      return 'Unknown location';
    }
  }, [geocoder, cache]);

  const formatAddress = (result: google.maps.GeocoderResult): string => {
    // Prioritize: sublocality > locality > route
    const components = result.address_components;

    const sublocality = components.find(c =>
      c.types.includes('sublocality_level_1')
    )?.long_name;

    const locality = components.find(c =>
      c.types.includes('locality')
    )?.long_name;

    const route = components.find(c =>
      c.types.includes('route')
    )?.long_name;

    return sublocality || route || locality || result.formatted_address;
  };

  // Debounced version for real-time dragging
  const debouncedReverseGeocode = useMemo(
    () => debounce(reverseGeocode, 300),
    [reverseGeocode]
  );

  return { reverseGeocode, debouncedReverseGeocode };
};

// Usage in draggable pin
const DraggablePickupPin = ({ onAddressChange }: DraggablePickupPinProps) => {
  const { debouncedReverseGeocode } = useGeocoding();

  const handleDrag = async (e: google.maps.MapMouseEvent) => {
    if (e.latLng) {
      const address = await debouncedReverseGeocode(
        e.latLng.lat(),
        e.latLng.lng()
      );
      onAddressChange(address);
    }
  };

  return (
    <Marker
      draggable
      onDrag={handleDrag}
      // ...
    />
  );
};
```

### Fit Bounds for Pickup & Drop

```typescript
// useFitBounds.ts
const useFitBounds = (
  map: google.maps.Map | null,
  pickup: LatLng | null,
  drop: LatLng | null,
  driverLocation: LatLng | null
) => {
  useEffect(() => {
    if (!map) return;

    const bounds = new google.maps.LatLngBounds();
    let hasPoints = false;

    if (pickup) {
      bounds.extend(pickup);
      hasPoints = true;
    }

    if (drop) {
      bounds.extend(drop);
      hasPoints = true;
    }

    if (driverLocation) {
      bounds.extend(driverLocation);
      hasPoints = true;
    }

    if (hasPoints) {
      // Fit with padding for bottom sheet
      map.fitBounds(bounds, {
        top: 50,
        right: 50,
        bottom: 300, // Space for bottom sheet
        left: 50,
      });

      // Don't zoom in too much for nearby points
      const listener = google.maps.event.addListenerOnce(map, 'idle', () => {
        const zoom = map.getZoom();
        if (zoom && zoom > 16) {
          map.setZoom(16);
        }
      });

      return () => {
        google.maps.event.removeListener(listener);
      };
    }
  }, [map, pickup, drop, driverLocation]);
};
```

---

## 18. Internationalization (i18n)

### Multi-Language Setup

```typescript
// i18n/config.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

const resources = {
  en: {
    translation: {
      booking: {
        whereToGo: 'Where to?',
        pickupLocation: 'Pickup location',
        destination: 'Destination',
        findingRide: 'Finding your ride...',
        driverFound: 'Driver found!',
        arrivingIn: 'Arriving in {{minutes}} min',
        tripStarted: 'Trip started',
        tripCompleted: 'Trip completed',
        yourOtp: 'Your OTP',
      },
      fare: {
        estimate: 'â‚¹{{min}}-{{max}}',
        surge: '{{multiplier}}x surge pricing',
        total: 'Total fare: â‚¹{{amount}}',
      },
      actions: {
        book: 'Book {{vehicleType}}',
        cancel: 'Cancel ride',
        call: 'Call driver',
        share: 'Share trip',
        sos: 'Emergency SOS',
      },
    },
  },
  hi: {
    translation: {
      booking: {
        whereToGo: 'à¤•à¤¹à¤¾à¤ à¤œà¤¾à¤¨à¤¾ à¤¹à¥ˆ?',
        pickupLocation: 'à¤ªà¤¿à¤•à¤…à¤ª à¤²à¥‹à¤•à¥‡à¤¶à¤¨',
        destination: 'à¤—à¤‚à¤¤à¤µà¥à¤¯',
        findingRide: 'à¤†à¤ªà¤•à¥€ à¤°à¤¾à¤‡à¤¡ à¤–à¥‹à¤œ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚...',
        driverFound: 'à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤®à¤¿à¤² à¤—à¤¯à¤¾!',
        arrivingIn: '{{minutes}} à¤®à¤¿à¤¨à¤Ÿ à¤®à¥‡à¤‚ à¤† à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚',
        tripStarted: 'à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤¶à¥à¤°à¥‚ à¤¹à¥à¤ˆ',
        tripCompleted: 'à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤ªà¥‚à¤°à¥€ à¤¹à¥à¤ˆ',
        yourOtp: 'à¤†à¤ªà¤•à¤¾ OTP',
      },
      fare: {
        estimate: 'â‚¹{{min}}-{{max}}',
        surge: '{{multiplier}}x à¤¸à¤°à¥à¤œ à¤ªà¥à¤°à¤¾à¤‡à¤¸à¤¿à¤‚à¤—',
        total: 'à¤•à¥à¤² à¤•à¤¿à¤°à¤¾à¤¯à¤¾: â‚¹{{amount}}',
      },
      actions: {
        book: '{{vehicleType}} à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚',
        cancel: 'à¤°à¤¾à¤‡à¤¡ à¤•à¥ˆà¤‚à¤¸à¤² à¤•à¤°à¥‡à¤‚',
        call: 'à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤•à¥‹ à¤•à¥‰à¤² à¤•à¤°à¥‡à¤‚',
        share: 'à¤Ÿà¥à¤°à¤¿à¤ª à¤¶à¥‡à¤¯à¤° à¤•à¤°à¥‡à¤‚',
        sos: 'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ SOS',
      },
    },
  },
  kn: { /* Kannada translations */ },
  ta: { /* Tamil translations */ },
  te: { /* Telugu translations */ },
};

i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    resources,
    fallbackLng: 'en',
    interpolation: {
      escapeValue: false,
    },
    detection: {
      order: ['localStorage', 'navigator'],
      caches: ['localStorage'],
    },
  });

export default i18n;
```

### Currency & Number Formatting

```typescript
// utils/formatters.ts
export const formatCurrency = (
  amount: number,
  currency: string = 'INR',
  locale: string = 'en-IN'
): string => {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
};

// â‚¹85 (en-IN), â‚¹ 85 (hi-IN)
formatCurrency(85, 'INR', 'en-IN'); // "â‚¹85"
formatCurrency(85, 'INR', 'hi-IN'); // "â‚¹85"

export const formatDistance = (
  meters: number,
  locale: string = 'en-IN',
  unit: 'metric' | 'imperial' = 'metric'
): string => {
  if (unit === 'imperial') {
    const miles = meters / 1609.344;
    return `${miles.toFixed(1)} mi`;
  }

  if (meters < 1000) {
    return new Intl.NumberFormat(locale, {
      style: 'unit',
      unit: 'meter',
      maximumFractionDigits: 0,
    }).format(meters);
  }

  const km = meters / 1000;
  return new Intl.NumberFormat(locale, {
    style: 'unit',
    unit: 'kilometer',
    maximumFractionDigits: 1,
  }).format(km);
};

// "5.2 km" (en-IN), "5.2 à¤•à¤¿à¤®à¥€" (hi-IN)

export const formatDuration = (
  seconds: number,
  locale: string = 'en-IN'
): string => {
  const minutes = Math.round(seconds / 60);

  if (minutes < 60) {
    return new Intl.NumberFormat(locale, {
      style: 'unit',
      unit: 'minute',
    }).format(minutes);
  }

  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;

  const hoursStr = new Intl.NumberFormat(locale, {
    style: 'unit',
    unit: 'hour',
  }).format(hours);

  if (remainingMinutes === 0) {
    return hoursStr;
  }

  const minutesStr = new Intl.NumberFormat(locale, {
    style: 'unit',
    unit: 'minute',
  }).format(remainingMinutes);

  return `${hoursStr} ${minutesStr}`;
};

// Relative time for ride history
export const formatRelativeTime = (
  date: Date,
  locale: string = 'en-IN'
): string => {
  const rtf = new Intl.RelativeTimeFormat(locale, { numeric: 'auto' });
  const now = new Date();
  const diffInSeconds = (date.getTime() - now.getTime()) / 1000;

  const units: [Intl.RelativeTimeFormatUnit, number][] = [
    ['year', 31536000],
    ['month', 2592000],
    ['week', 604800],
    ['day', 86400],
    ['hour', 3600],
    ['minute', 60],
  ];

  for (const [unit, secondsInUnit] of units) {
    if (Math.abs(diffInSeconds) >= secondsInUnit) {
      const value = Math.round(diffInSeconds / secondsInUnit);
      return rtf.format(value, unit);
    }
  }

  return rtf.format(Math.round(diffInSeconds), 'second');
};

// "2 days ago", "à¤•à¤²", "à¤…à¤—à¤²à¥‡ à¤¹à¤«à¥à¤¤à¥‡"
```

### RTL Support

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RTL (Right-to-Left) SUPPORT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Languages requiring RTL: Arabic, Urdu, Hebrew                             â”‚
â”‚                                                                              â”‚
â”‚  CSS Logical Properties:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚                                                                              â”‚
â”‚  /* Instead of physical properties */                                      â”‚
â”‚  .card {                                                                    â”‚
â”‚    margin-left: 16px;    /* âŒ Physical */                                 â”‚
â”‚    padding-right: 12px;  /* âŒ Physical */                                 â”‚
â”‚    text-align: left;     /* âŒ Physical */                                 â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  /* Use logical properties */                                              â”‚
â”‚  .card {                                                                    â”‚
â”‚    margin-inline-start: 16px;  /* âœ“ Logical */                            â”‚
â”‚    padding-inline-end: 12px;   /* âœ“ Logical */                            â”‚
â”‚    text-align: start;          /* âœ“ Logical */                            â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  Logical Property Mapping:                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  left/right       â†’ inline-start/inline-end                                â”‚
â”‚  top/bottom       â†’ block-start/block-end                                  â”‚
â”‚  margin-left      â†’ margin-inline-start                                    â”‚
â”‚  padding-right    â†’ padding-inline-end                                     â”‚
â”‚  border-left      â†’ border-inline-start                                    â”‚
â”‚  text-align: left â†’ text-align: start                                      â”‚
â”‚                                                                              â”‚
â”‚  Implementation:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  // Set dir attribute based on language                                    â”‚
â”‚  useEffect(() => {                                                          â”‚
â”‚    const rtlLanguages = ['ar', 'ur', 'he'];                                â”‚
â”‚    const isRTL = rtlLanguages.includes(i18n.language);                     â”‚
â”‚    document.documentElement.dir = isRTL ? 'rtl' : 'ltr';                   â”‚
â”‚    document.documentElement.lang = i18n.language;                          â”‚
â”‚  }, [i18n.language]);                                                       â”‚
â”‚                                                                              â”‚
â”‚  // Tailwind CSS RTL plugin                                                â”‚
â”‚  className="mr-4 rtl:ml-4 rtl:mr-0"                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Language Selector Component

```typescript
// LanguageSelector.tsx
const LANGUAGES = [
  { code: 'en', name: 'English', nativeName: 'English' },
  { code: 'hi', name: 'Hindi', nativeName: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€' },
  { code: 'kn', name: 'Kannada', nativeName: 'à²•à²¨à³à²¨à²¡' },
  { code: 'ta', name: 'Tamil', nativeName: 'à®¤à®®à®¿à®´à¯' },
  { code: 'te', name: 'Telugu', nativeName: 'à°¤à±†à°²à±à°—à±' },
  { code: 'mr', name: 'Marathi', nativeName: 'à¤®à¤°à¤¾à¤ à¥€' },
  { code: 'bn', name: 'Bengali', nativeName: 'à¦¬à¦¾à¦‚à¦²à¦¾' },
];

const LanguageSelector = () => {
  const { i18n } = useTranslation();
  const [isOpen, setIsOpen] = useState(false);

  const currentLanguage = LANGUAGES.find(l => l.code === i18n.language) || LANGUAGES[0];

  const changeLanguage = (code: string) => {
    i18n.changeLanguage(code);
    setIsOpen(false);

    // Update document direction
    const rtlLanguages = ['ar', 'ur'];
    document.documentElement.dir = rtlLanguages.includes(code) ? 'rtl' : 'ltr';
  };

  return (
    <div className="language-selector">
      <button
        onClick={() => setIsOpen(!isOpen)}
        aria-haspopup="listbox"
        aria-expanded={isOpen}
      >
        <GlobeIcon />
        <span>{currentLanguage.nativeName}</span>
        <ChevronDownIcon />
      </button>

      {isOpen && (
        <ul role="listbox" className="language-dropdown">
          {LANGUAGES.map(lang => (
            <li
              key={lang.code}
              role="option"
              aria-selected={lang.code === i18n.language}
              onClick={() => changeLanguage(lang.code)}
              className={lang.code === i18n.language ? 'selected' : ''}
            >
              <span className="native-name">{lang.nativeName}</span>
              <span className="english-name">{lang.name}</span>
              {lang.code === i18n.language && <CheckIcon />}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
};
```

### Pluralization & Grammar

```typescript
// i18n/pluralization.ts
// Handle complex pluralization rules for Indian languages

const resources = {
  en: {
    translation: {
      drivers: {
        count_zero: 'No drivers available',
        count_one: '{{count}} driver nearby',
        count_other: '{{count}} drivers nearby',
      },
      minutes: {
        arriving_one: 'Arriving in {{count}} minute',
        arriving_other: 'Arriving in {{count}} minutes',
      },
    },
  },
  hi: {
    translation: {
      drivers: {
        // Hindi uses same form for 2+
        count_zero: 'à¤•à¥‹à¤ˆ à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¨à¤¹à¥€à¤‚',
        count_one: '{{count}} à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤ªà¤¾à¤¸ à¤®à¥‡à¤‚',
        count_other: '{{count}} à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤ªà¤¾à¤¸ à¤®à¥‡à¤‚',
      },
      minutes: {
        arriving_one: '{{count}} à¤®à¤¿à¤¨à¤Ÿ à¤®à¥‡à¤‚ à¤ªà¤¹à¥à¤‚à¤š à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚',
        arriving_other: '{{count}} à¤®à¤¿à¤¨à¤Ÿ à¤®à¥‡à¤‚ à¤ªà¤¹à¥à¤‚à¤š à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚',
      },
    },
  },
};

// Usage
const { t } = useTranslation();
t('drivers.count', { count: 5 }); // "5 drivers nearby"
t('minutes.arriving', { count: 3 }); // "Arriving in 3 minutes"

// Gender agreement (important for Hindi/Marathi)
const resources_extended = {
  hi: {
    translation: {
      driver: {
        arriving_male: 'à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤† à¤°à¤¹à¤¾ à¤¹à¥ˆ',
        arriving_female: 'à¤¡à¥à¤°à¤¾à¤‡à¤µà¤° à¤† à¤°à¤¹à¥€ à¤¹à¥ˆ',
      },
    },
  },
};

// Usage with gender context
t('driver.arriving', { context: driver.gender }); // Uses correct verb form
```

---

## 19. Analytics & Monitoring

### Booking Funnel Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BOOKING FUNNEL ANALYTICS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Funnel Steps & Drop-off Points:                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚                                                                              â”‚
â”‚  App Open                    100%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                    â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Location permission denied)                                â”‚
â”‚  Location Set                85%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                       â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Destination not entered)                                   â”‚
â”‚  Destination Entered         70%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                          â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Price too high, no drivers)                               â”‚
â”‚  Fare Estimate Viewed        65%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                           â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Changed mind, switched app)                               â”‚
â”‚  Book Button Tapped          45%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                               â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: No driver found, timeout)                                 â”‚
â”‚  Driver Matched              38%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Cancellation by rider/driver)                             â”‚
â”‚  Ride Completed              32%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                  â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼  (Drop: Payment failure)                                          â”‚
â”‚  Payment Successful          31%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Event Tracking Implementation

```typescript
// analytics/events.ts
interface AnalyticsEvent {
  name: string;
  properties: Record<string, any>;
  timestamp: number;
  sessionId: string;
  userId?: string;
}

const analytics = {
  track: (name: string, properties: Record<string, any> = {}) => {
    const event: AnalyticsEvent = {
      name,
      properties: {
        ...properties,
        platform: getPlatform(),
        appVersion: APP_VERSION,
        locale: navigator.language,
      },
      timestamp: Date.now(),
      sessionId: getSessionId(),
      userId: getUserId(),
    };

    // Send to analytics backend
    sendToAnalytics(event);

    // Also log to console in dev
    if (process.env.NODE_ENV === 'development') {
      console.log('[Analytics]', name, properties);
    }
  },
};

// Booking funnel events
export const trackBookingFunnel = {
  appOpened: () => {
    analytics.track('app_opened', {
      entry_point: document.referrer || 'direct',
    });
  },

  locationSet: (method: 'gps' | 'search' | 'saved' | 'map') => {
    analytics.track('location_set', {
      method,
      has_permission: 'geolocation' in navigator,
    });
  },

  destinationEntered: (method: 'search' | 'saved' | 'map' | 'recent') => {
    analytics.track('destination_entered', { method });
  },

  fareEstimateViewed: (options: FareOption[]) => {
    analytics.track('fare_estimate_viewed', {
      options_count: options.length,
      cheapest: Math.min(...options.map(o => o.fareRange.min)),
      has_surge: options.some(o => o.surge > 1),
    });
  },

  rideTypeSelected: (vehicleType: string, fare: number) => {
    analytics.track('ride_type_selected', {
      vehicle_type: vehicleType,
      fare_estimate: fare,
    });
  },

  bookButtonTapped: (vehicleType: string, fare: number) => {
    analytics.track('book_button_tapped', {
      vehicle_type: vehicleType,
      fare_estimate: fare,
      time_since_estimate: getTimeSinceEstimate(),
    });
  },

  driverMatched: (waitTime: number, driverRating: number) => {
    analytics.track('driver_matched', {
      wait_time_seconds: waitTime,
      driver_rating: driverRating,
    });
  },

  rideCompleted: (details: RideDetails) => {
    analytics.track('ride_completed', {
      duration_minutes: details.duration,
      distance_km: details.distance,
      fare: details.fare,
      surge_applied: details.surgeFare > 0,
      rating_given: details.rating,
    });
  },

  rideCancelled: (stage: string, reason: string, cancelledBy: 'rider' | 'driver') => {
    analytics.track('ride_cancelled', {
      stage,
      reason,
      cancelled_by: cancelledBy,
    });
  },
};
```

### Core Web Vitals Monitoring

```typescript
// performance/webVitals.ts
import { getCLS, getFID, getLCP, getFCP, getTTFB } from 'web-vitals';

interface PerformanceMetric {
  name: string;
  value: number;
  rating: 'good' | 'needs-improvement' | 'poor';
}

const sendToAnalytics = (metric: PerformanceMetric) => {
  analytics.track('web_vital', {
    metric_name: metric.name,
    metric_value: metric.value,
    rating: metric.rating,
    page: window.location.pathname,
  });
};

// Initialize web vitals tracking
export const initWebVitals = () => {
  getCLS(metric => sendToAnalytics({
    name: 'CLS',
    value: metric.value,
    rating: metric.rating,
  }));

  getFID(metric => sendToAnalytics({
    name: 'FID',
    value: metric.value,
    rating: metric.rating,
  }));

  getLCP(metric => sendToAnalytics({
    name: 'LCP',
    value: metric.value,
    rating: metric.rating,
  }));

  getFCP(metric => sendToAnalytics({
    name: 'FCP',
    value: metric.value,
    rating: metric.rating,
  }));

  getTTFB(metric => sendToAnalytics({
    name: 'TTFB',
    value: metric.value,
    rating: metric.rating,
  }));
};

// Custom performance metrics for ride booking
export const trackCustomMetrics = {
  timeToFirstFareEstimate: () => {
    const start = performance.mark('fare_estimate_start');
    return {
      end: () => {
        const measure = performance.measure(
          'time_to_fare_estimate',
          'fare_estimate_start'
        );
        analytics.track('custom_metric', {
          name: 'time_to_fare_estimate',
          value: measure.duration,
        });
      },
    };
  },

  timeToDriverMatch: () => {
    const start = Date.now();
    return {
      end: () => {
        analytics.track('custom_metric', {
          name: 'time_to_driver_match',
          value: Date.now() - start,
        });
      },
    };
  },

  mapLoadTime: () => {
    const start = performance.now();
    return {
      end: () => {
        analytics.track('custom_metric', {
          name: 'map_load_time',
          value: performance.now() - start,
        });
      },
    };
  },
};
```

### Real-Time Dashboard Metrics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REAL-TIME DASHBOARD METRICS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Key Metrics to Track:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                              â”‚
â”‚  1. AVAILABILITY METRICS                                                    â”‚
â”‚     â€¢ Active drivers by zone                                               â”‚
â”‚     â€¢ Driver utilization rate                                              â”‚
â”‚     â€¢ Average idle time                                                    â”‚
â”‚                                                                              â”‚
â”‚  2. BOOKING METRICS                                                         â”‚
â”‚     â€¢ Requests per minute (RPM)                                            â”‚
â”‚     â€¢ Booking success rate                                                 â”‚
â”‚     â€¢ Average time to match                                                â”‚
â”‚     â€¢ No-driver-found rate                                                 â”‚
â”‚                                                                              â”‚
â”‚  3. COMPLETION METRICS                                                      â”‚
â”‚     â€¢ Ride completion rate                                                 â”‚
â”‚     â€¢ Cancellation rate (rider vs driver)                                  â”‚
â”‚     â€¢ Average ride duration                                                â”‚
â”‚     â€¢ Average fare                                                         â”‚
â”‚                                                                              â”‚
â”‚  4. PERFORMANCE METRICS                                                     â”‚
â”‚     â€¢ API latency (p50, p95, p99)                                         â”‚
â”‚     â€¢ WebSocket connection rate                                            â”‚
â”‚     â€¢ Map tile load time                                                   â”‚
â”‚     â€¢ App crash rate                                                       â”‚
â”‚                                                                              â”‚
â”‚  5. USER EXPERIENCE METRICS                                                â”‚
â”‚     â€¢ Time to first fare estimate                                          â”‚
â”‚     â€¢ Driver ETA accuracy                                                  â”‚
â”‚     â€¢ Rating distribution                                                  â”‚
â”‚     â€¢ NPS score                                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Tracking

```typescript
// errorTracking.ts
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10% of transactions
  beforeSend(event) {
    // Filter out known non-critical errors
    if (event.exception?.values?.[0]?.type === 'ChunkLoadError') {
      return null; // Ignore chunk load errors (handled by retry)
    }
    return event;
  },
});

// Custom error boundaries for ride flow
export const captureRideError = (
  error: Error,
  context: {
    rideId?: string;
    stage: 'booking' | 'matching' | 'tracking' | 'payment';
    userId?: string;
  }
) => {
  Sentry.withScope(scope => {
    scope.setTag('ride_stage', context.stage);
    if (context.rideId) {
      scope.setExtra('ride_id', context.rideId);
    }
    if (context.userId) {
      scope.setUser({ id: context.userId });
    }
    Sentry.captureException(error);
  });
};

// WebSocket error tracking
export const trackWebSocketError = (
  error: Event | Error,
  reconnectAttempt: number
) => {
  Sentry.captureMessage('WebSocket connection error', {
    level: 'warning',
    extra: {
      error: error.toString(),
      reconnect_attempt: reconnectAttempt,
      connection_state: getConnectionState(),
    },
  });
};

// Location error tracking
export const trackLocationError = (
  error: GeolocationPositionError
) => {
  const errorMessages: Record<number, string> = {
    1: 'Permission denied',
    2: 'Position unavailable',
    3: 'Timeout',
  };

  analytics.track('location_error', {
    error_code: error.code,
    error_message: errorMessages[error.code],
  });
};
```

### A/B Testing Integration

```typescript
// abTesting.ts
interface Experiment {
  id: string;
  variant: string;
  properties: Record<string, any>;
}

const experiments = new Map<string, Experiment>();

export const initExperiments = async (userId: string) => {
  const response = await fetch(`/api/v1/experiments?userId=${userId}`);
  const data = await response.json();

  data.experiments.forEach((exp: Experiment) => {
    experiments.set(exp.id, exp);
  });
};

export const getVariant = (experimentId: string): string | null => {
  return experiments.get(experimentId)?.variant || null;
};

export const trackExperimentExposure = (experimentId: string) => {
  const experiment = experiments.get(experimentId);
  if (experiment) {
    analytics.track('experiment_exposure', {
      experiment_id: experimentId,
      variant: experiment.variant,
    });
  }
};

// Usage in components
const BookingButton = () => {
  const buttonVariant = getVariant('booking_button_v2');

  useEffect(() => {
    trackExperimentExposure('booking_button_v2');
  }, []);

  if (buttonVariant === 'large_green') {
    return <LargeGreenButton />;
  }

  return <DefaultButton />;
};
```

---

## 20. Notification System

### Push Notification Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PUSH NOTIFICATION ARCHITECTURE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Server                    Push Service              Client                â”‚
â”‚   â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€                â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚      â”‚   1. Driver matched     â”‚                        â”‚                  â”‚
â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->â”‚                        â”‚                  â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚      â”‚                          â”‚   2. Push notification â”‚                  â”‚
â”‚      â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚      â”‚                          â”‚                        â”‚ 3. Display       â”‚
â”‚      â”‚                          â”‚                        â”‚    notification  â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚      â”‚                          â”‚                        â”‚ 4. User taps     â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚      â”‚   5. App opens to ride   â”‚                        â”‚                  â”‚
â”‚      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
â”‚      â”‚                          â”‚                        â”‚                  â”‚
â”‚                                                                              â”‚
â”‚   Push Services:                                                            â”‚
â”‚   â€¢ FCM (Firebase Cloud Messaging) - Android & Web                         â”‚
â”‚   â€¢ APNs (Apple Push Notification service) - iOS                           â”‚
â”‚   â€¢ Web Push API - Browsers                                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Web Push Implementation

```typescript
// notifications/webPush.ts
const VAPID_PUBLIC_KEY = process.env.NEXT_PUBLIC_VAPID_KEY;

export const initPushNotifications = async (): Promise<boolean> => {
  // Check support
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    console.log('Push notifications not supported');
    return false;
  }

  // Request permission
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    console.log('Notification permission denied');
    return false;
  }

  // Get service worker registration
  const registration = await navigator.serviceWorker.ready;

  // Subscribe to push
  try {
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
    });

    // Send subscription to server
    await fetch('/api/v1/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(subscription),
    });

    return true;
  } catch (error) {
    console.error('Push subscription failed:', error);
    return false;
  }
};

// Service worker push handler
// sw.js
self.addEventListener('push', (event: PushEvent) => {
  const data = event.data?.json() || {};

  const options: NotificationOptions = {
    body: data.body,
    icon: '/icons/app-icon-192.png',
    badge: '/icons/badge-72.png',
    tag: data.tag || 'ride-update',
    renotify: true,
    data: {
      url: data.url,
      rideId: data.rideId,
    },
    actions: data.actions || [],
    vibrate: [200, 100, 200],
  };

  event.waitUntil(
    self.registration.showNotification(data.title, options)
  );
});

// Handle notification click
self.addEventListener('notificationclick', (event: NotificationEvent) => {
  event.notification.close();

  const { url, rideId } = event.notification.data;

  // Handle action buttons
  if (event.action === 'call_driver') {
    // Open phone dialer
    clients.openWindow(`tel:${event.notification.data.driverPhone}`);
    return;
  }

  // Open app to ride screen
  event.waitUntil(
    clients.matchAll({ type: 'window' }).then(windowClients => {
      // Focus existing window if open
      for (const client of windowClients) {
        if (client.url.includes(url) && 'focus' in client) {
          return client.focus();
        }
      }
      // Otherwise open new window
      return clients.openWindow(url || `/ride/${rideId}`);
    })
  );
});
```

### Notification Types

```typescript
// notifications/types.ts
interface RideNotification {
  type: NotificationType;
  title: string;
  body: string;
  priority: 'high' | 'normal';
  data: Record<string, any>;
  actions?: NotificationAction[];
}

type NotificationType =
  | 'driver_matched'
  | 'driver_arriving'
  | 'driver_arrived'
  | 'trip_started'
  | 'trip_completed'
  | 'payment_received'
  | 'ride_cancelled'
  | 'promo_offer';

const notificationTemplates: Record<NotificationType, (data: any) => RideNotification> = {
  driver_matched: (data) => ({
    type: 'driver_matched',
    title: 'Driver Found!',
    body: `${data.driverName} is on the way. ETA: ${data.eta} min. OTP: ${data.otp}`,
    priority: 'high',
    data: {
      rideId: data.rideId,
      url: `/ride/${data.rideId}`,
      driverPhone: data.driverPhone,
    },
    actions: [
      { action: 'call_driver', title: 'Call Driver' },
      { action: 'view_ride', title: 'View Details' },
    ],
  }),

  driver_arriving: (data) => ({
    type: 'driver_arriving',
    title: 'Driver is Close!',
    body: `${data.driverName} is ${data.distance}m away. Please be ready.`,
    priority: 'high',
    data: { rideId: data.rideId },
    actions: [],
  }),

  driver_arrived: (data) => ({
    type: 'driver_arrived',
    title: 'Driver Has Arrived',
    body: `${data.driverName} is waiting at pickup. Look for ${data.vehicleColor} ${data.vehicleModel}.`,
    priority: 'high',
    data: { rideId: data.rideId },
    actions: [
      { action: 'call_driver', title: 'Call Driver' },
    ],
  }),

  trip_completed: (data) => ({
    type: 'trip_completed',
    title: 'Trip Completed',
    body: `Your ride is complete. Total fare: â‚¹${data.fare}. Rate your ride!`,
    priority: 'normal',
    data: { rideId: data.rideId, url: `/ride/${data.rideId}/rate` },
    actions: [
      { action: 'rate_ride', title: 'Rate Now' },
    ],
  }),

  promo_offer: (data) => ({
    type: 'promo_offer',
    title: data.title,
    body: data.body,
    priority: 'normal',
    data: { promoCode: data.code, url: '/promos' },
    actions: [
      { action: 'apply_promo', title: 'Use Code' },
    ],
  }),
};
```

### In-App Notification Center

```typescript
// NotificationCenter.tsx
interface AppNotification {
  id: string;
  type: NotificationType;
  title: string;
  body: string;
  timestamp: Date;
  read: boolean;
  data: Record<string, any>;
}

const NotificationCenter = () => {
  const [notifications, setNotifications] = useState<AppNotification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [isOpen, setIsOpen] = useState(false);

  // Fetch notifications
  useEffect(() => {
    const fetchNotifications = async () => {
      const response = await fetch('/api/v1/notifications');
      const data = await response.json();
      setNotifications(data.notifications);
      setUnreadCount(data.notifications.filter((n: AppNotification) => !n.read).length);
    };

    fetchNotifications();

    // Subscribe to real-time updates via WebSocket
    const unsubscribe = subscribeToNotifications((notification) => {
      setNotifications(prev => [notification, ...prev]);
      setUnreadCount(prev => prev + 1);
    });

    return unsubscribe;
  }, []);

  const markAsRead = async (id: string) => {
    await fetch(`/api/v1/notifications/${id}/read`, { method: 'POST' });
    setNotifications(prev =>
      prev.map(n => n.id === id ? { ...n, read: true } : n)
    );
    setUnreadCount(prev => Math.max(0, prev - 1));
  };

  const markAllAsRead = async () => {
    await fetch('/api/v1/notifications/read-all', { method: 'POST' });
    setNotifications(prev => prev.map(n => ({ ...n, read: true })));
    setUnreadCount(0);
  };

  return (
    <div className="notification-center">
      <button
        className="notification-bell"
        onClick={() => setIsOpen(!isOpen)}
        aria-label={`Notifications. ${unreadCount} unread.`}
      >
        <BellIcon />
        {unreadCount > 0 && (
          <span className="badge" aria-hidden="true">
            {unreadCount > 99 ? '99+' : unreadCount}
          </span>
        )}
      </button>

      {isOpen && (
        <div className="notification-panel" role="dialog" aria-label="Notifications">
          <div className="panel-header">
            <h2>Notifications</h2>
            {unreadCount > 0 && (
              <button onClick={markAllAsRead}>Mark all read</button>
            )}
          </div>

          <ul className="notification-list">
            {notifications.length === 0 ? (
              <li className="empty-state">No notifications</li>
            ) : (
              notifications.map(notification => (
                <li
                  key={notification.id}
                  className={`notification-item ${notification.read ? '' : 'unread'}`}
                  onClick={() => {
                    markAsRead(notification.id);
                    handleNotificationClick(notification);
                  }}
                >
                  <NotificationIcon type={notification.type} />
                  <div className="notification-content">
                    <p className="notification-title">{notification.title}</p>
                    <p className="notification-body">{notification.body}</p>
                    <span className="notification-time">
                      {formatRelativeTime(notification.timestamp)}
                    </span>
                  </div>
                </li>
              ))
            )}
          </ul>
        </div>
      )}
    </div>
  );
};
```

### Smart Notification Scheduling

```typescript
// notifications/scheduler.ts
const shouldSendNotification = (
  userId: string,
  notificationType: NotificationType,
  context: NotificationContext
): boolean => {
  // Don't spam users
  const recentNotifications = getRecentNotifications(userId, 5 * 60 * 1000); // 5 min
  if (recentNotifications.length > 3) {
    return false;
  }

  // Don't send promo during active ride
  if (notificationType === 'promo_offer' && context.hasActiveRide) {
    return false;
  }

  // Respect quiet hours (configurable per user)
  const userPrefs = getUserNotificationPrefs(userId);
  if (userPrefs.quietHours) {
    const now = new Date();
    const hour = now.getHours();
    if (hour >= userPrefs.quietHoursStart || hour < userPrefs.quietHoursEnd) {
      // Queue for later
      queueNotificationForLater(userId, notificationType, context);
      return false;
    }
  }

  // Check if user has disabled this type
  if (userPrefs.disabledTypes?.includes(notificationType)) {
    return false;
  }

  return true;
};

// Notification grouping for multiple updates
const groupNotifications = (notifications: RideNotification[]): RideNotification[] => {
  // Group location updates into single notification
  const locationUpdates = notifications.filter(n => n.type === 'driver_arriving');
  const others = notifications.filter(n => n.type !== 'driver_arriving');

  if (locationUpdates.length > 1) {
    // Keep only the latest location update
    others.push(locationUpdates[locationUpdates.length - 1]);
  } else {
    others.push(...locationUpdates);
  }

  return others;
};
```

---

## 21. Payment Integration Deep Dive

### Payment Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAYMENT FLOW ARCHITECTURE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Ride Complete                                                             â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    PAYMENT METHOD SELECTION                          â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚  â”‚   Wallet    â”‚ â”‚    UPI      â”‚ â”‚   Card      â”‚ â”‚    Cash     â”‚   â”‚  â”‚
â”‚   â”‚  â”‚   â‚¹500      â”‚ â”‚  GPay/PhonePeâ”‚ â”‚  ****1234  â”‚ â”‚   Pay Later â”‚   â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    PAYMENT PROCESSING                                â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   [Client]     [API Gateway]    [Payment Service]   [Gateway]       â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚â”€â”€ Initiate â”€>â”‚                  â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚              â”‚â”€â”€ Create Order â”€>â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚â”€â”€ Charge â”€â”€â”€â”€>â”‚             â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚               â”‚  Razorpay/  â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚<â”€â”€ Response â”€â”€â”‚  Stripe     â”‚  â”‚
â”‚   â”‚      â”‚              â”‚<â”€â”€ Order ID â”€â”€â”€â”€â”€â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚<â”€â”€ SDK Init â”€â”‚                  â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚â”€â”€ Payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚  â”‚
â”‚   â”‚      â”‚<â”€â”€ Callback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚  â”‚
â”‚   â”‚      â”‚              â”‚                  â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚â”€â”€ Verify â”€â”€â”€>â”‚â”€â”€ Verify â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚             â”‚  â”‚
â”‚   â”‚      â”‚<â”€â”€ Success â”€â”€â”‚<â”€â”€ Confirmed â”€â”€â”€â”€â”‚               â”‚             â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Payment Methods Component

```typescript
// PaymentMethods.tsx
interface PaymentMethod {
  id: string;
  type: 'wallet' | 'upi' | 'card' | 'cash';
  displayName: string;
  details: string;
  isDefault: boolean;
  balance?: number; // For wallet
  last4?: string;   // For cards
}

const PaymentMethods = ({
  fare,
  onSelect,
  selectedMethod
}: PaymentMethodsProps) => {
  const { data: methods, isLoading } = useQuery('paymentMethods', fetchPaymentMethods);
  const [showAddCard, setShowAddCard] = useState(false);

  const canPayWithWallet = methods?.find(m => m.type === 'wallet')?.balance >= fare;

  return (
    <div className="payment-methods">
      <h3>Payment Method</h3>

      {isLoading ? (
        <Skeleton count={3} />
      ) : (
        <ul role="radiogroup" aria-label="Select payment method">
          {methods?.map(method => (
            <li key={method.id}>
              <label
                className={`payment-option ${selectedMethod === method.id ? 'selected' : ''}`}
              >
                <input
                  type="radio"
                  name="payment-method"
                  value={method.id}
                  checked={selectedMethod === method.id}
                  onChange={() => onSelect(method.id)}
                  disabled={method.type === 'wallet' && !canPayWithWallet}
                />

                <PaymentIcon type={method.type} />

                <div className="payment-details">
                  <span className="payment-name">{method.displayName}</span>
                  <span className="payment-info">
                    {method.type === 'wallet' && `Balance: â‚¹${method.balance}`}
                    {method.type === 'card' && `****${method.last4}`}
                    {method.type === 'upi' && method.details}
                  </span>
                </div>

                {method.isDefault && (
                  <span className="default-badge">Default</span>
                )}

                {method.type === 'wallet' && !canPayWithWallet && (
                  <span className="insufficient">
                    Insufficient balance
                    <button onClick={() => navigate('/wallet/add')}>
                      Add â‚¹{fare - method.balance!}
                    </button>
                  </span>
                )}
              </label>
            </li>
          ))}

          {/* Add new card option */}
          <li>
            <button
              className="add-payment-method"
              onClick={() => setShowAddCard(true)}
            >
              <PlusIcon /> Add new card
            </button>
          </li>
        </ul>
      )}

      {showAddCard && (
        <AddCardModal onClose={() => setShowAddCard(false)} />
      )}
    </div>
  );
};
```

### Razorpay Integration

```typescript
// payments/razorpay.ts
interface RazorpayOptions {
  key: string;
  amount: number;
  currency: string;
  name: string;
  description: string;
  order_id: string;
  prefill: {
    name: string;
    email: string;
    contact: string;
  };
  theme: {
    color: string;
  };
  handler: (response: RazorpayResponse) => void;
  modal: {
    ondismiss: () => void;
  };
}

export const initiateRazorpayPayment = async (
  rideId: string,
  amount: number,
  user: User
): Promise<boolean> => {
  try {
    // 1. Create order on server
    const orderResponse = await fetch('/api/v1/payments/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        rideId,
        amount: amount * 100, // Razorpay expects paise
        currency: 'INR',
      }),
    });

    const { orderId, key } = await orderResponse.json();

    // 2. Open Razorpay checkout
    return new Promise((resolve) => {
      const options: RazorpayOptions = {
        key,
        amount: amount * 100,
        currency: 'INR',
        name: 'RideApp',
        description: `Ride Payment - ${rideId}`,
        order_id: orderId,
        prefill: {
          name: user.name,
          email: user.email,
          contact: user.phone,
        },
        theme: {
          color: '#2196F3',
        },
        handler: async (response) => {
          // 3. Verify payment on server
          const verifyResponse = await fetch('/api/v1/payments/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderId: response.razorpay_order_id,
              paymentId: response.razorpay_payment_id,
              signature: response.razorpay_signature,
              rideId,
            }),
          });

          if (verifyResponse.ok) {
            resolve(true);
          } else {
            resolve(false);
          }
        },
        modal: {
          ondismiss: () => {
            resolve(false);
          },
        },
      };

      const razorpay = new window.Razorpay(options);
      razorpay.open();
    });
  } catch (error) {
    console.error('Payment initiation failed:', error);
    return false;
  }
};
```

### Promo Code Application

```typescript
// PromoCodeInput.tsx
const PromoCodeInput = ({
  fare,
  onApply,
  appliedPromo
}: PromoCodeInputProps) => {
  const [code, setCode] = useState('');
  const [isValidating, setIsValidating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const validatePromo = async () => {
    if (!code.trim()) return;

    setIsValidating(true);
    setError(null);

    try {
      const response = await fetch('/api/v1/promos/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          code: code.toUpperCase(),
          fare,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        onApply({
          code: data.code,
          discount: data.discount,
          discountType: data.discountType, // 'percentage' | 'flat'
          maxDiscount: data.maxDiscount,
        });
        setCode('');
      } else {
        setError(data.message || 'Invalid promo code');
      }
    } catch (error) {
      setError('Failed to validate promo code');
    } finally {
      setIsValidating(false);
    }
  };

  const calculateDiscount = (promo: AppliedPromo): number => {
    if (promo.discountType === 'percentage') {
      const discount = (fare * promo.discount) / 100;
      return Math.min(discount, promo.maxDiscount || Infinity);
    }
    return Math.min(promo.discount, fare);
  };

  return (
    <div className="promo-code-section">
      {appliedPromo ? (
        <div className="applied-promo">
          <TagIcon />
          <span>{appliedPromo.code}</span>
          <span className="discount">
            -â‚¹{calculateDiscount(appliedPromo)}
          </span>
          <button onClick={() => onApply(null)} aria-label="Remove promo">
            <XIcon />
          </button>
        </div>
      ) : (
        <div className="promo-input">
          <input
            type="text"
            value={code}
            onChange={(e) => setCode(e.target.value.toUpperCase())}
            placeholder="Enter promo code"
            aria-label="Promo code"
            aria-invalid={!!error}
            aria-describedby={error ? 'promo-error' : undefined}
          />
          <button
            onClick={validatePromo}
            disabled={!code.trim() || isValidating}
          >
            {isValidating ? <Spinner size="small" /> : 'Apply'}
          </button>
        </div>
      )}

      {error && (
        <p id="promo-error" className="error-message" role="alert">
          {error}
        </p>
      )}
    </div>
  );
};
```

### Fare Breakdown Component

```typescript
// FareBreakdown.tsx
interface FareBreakdownProps {
  baseFare: number;
  distanceFare: number;
  timeFare: number;
  surgeFare: number;
  discount: number;
  taxes: number;
  total: number;
}

const FareBreakdown = ({
  baseFare,
  distanceFare,
  timeFare,
  surgeFare,
  discount,
  taxes,
  total
}: FareBreakdownProps) => {
  const [isExpanded, setIsExpanded] = useState(false);

  return (
    <div className="fare-breakdown">
      <button
        className="fare-header"
        onClick={() => setIsExpanded(!isExpanded)}
        aria-expanded={isExpanded}
      >
        <span>Total Fare</span>
        <span className="total">â‚¹{total}</span>
        <ChevronIcon direction={isExpanded ? 'up' : 'down'} />
      </button>

      {isExpanded && (
        <dl className="fare-details">
          <div className="fare-row">
            <dt>Base fare</dt>
            <dd>â‚¹{baseFare}</dd>
          </div>

          <div className="fare-row">
            <dt>Distance fare</dt>
            <dd>â‚¹{distanceFare}</dd>
          </div>

          <div className="fare-row">
            <dt>Time fare</dt>
            <dd>â‚¹{timeFare}</dd>
          </div>

          {surgeFare > 0 && (
            <div className="fare-row surge">
              <dt>
                <SurgeIcon /> Surge pricing
              </dt>
              <dd>+â‚¹{surgeFare}</dd>
            </div>
          )}

          {discount > 0 && (
            <div className="fare-row discount">
              <dt>
                <TagIcon /> Discount
              </dt>
              <dd>-â‚¹{discount}</dd>
            </div>
          )}

          <div className="fare-row">
            <dt>Taxes & fees</dt>
            <dd>â‚¹{taxes}</dd>
          </div>

          <div className="fare-row total">
            <dt>Total</dt>
            <dd>â‚¹{total}</dd>
          </div>
        </dl>
      )}
    </div>
  );
};
```

### Payment Error Handling

```typescript
// payments/errorHandling.ts
type PaymentErrorCode =
  | 'INSUFFICIENT_BALANCE'
  | 'CARD_DECLINED'
  | 'NETWORK_ERROR'
  | 'TIMEOUT'
  | 'FRAUD_DETECTED'
  | 'INVALID_UPI'
  | 'BANK_SERVER_DOWN';

interface PaymentError {
  code: PaymentErrorCode;
  message: string;
  retry: boolean;
  fallbackOptions: string[];
}

const paymentErrorHandlers: Record<PaymentErrorCode, PaymentError> = {
  INSUFFICIENT_BALANCE: {
    code: 'INSUFFICIENT_BALANCE',
    message: 'Insufficient wallet balance. Please add money or use another method.',
    retry: false,
    fallbackOptions: ['card', 'upi', 'cash'],
  },
  CARD_DECLINED: {
    code: 'CARD_DECLINED',
    message: 'Card declined. Please try another card or payment method.',
    retry: true,
    fallbackOptions: ['upi', 'wallet', 'cash'],
  },
  NETWORK_ERROR: {
    code: 'NETWORK_ERROR',
    message: 'Network error. Please check your connection and try again.',
    retry: true,
    fallbackOptions: [],
  },
  TIMEOUT: {
    code: 'TIMEOUT',
    message: 'Payment timed out. Please try again.',
    retry: true,
    fallbackOptions: [],
  },
  FRAUD_DETECTED: {
    code: 'FRAUD_DETECTED',
    message: 'Payment could not be processed. Please contact support.',
    retry: false,
    fallbackOptions: ['cash'],
  },
  INVALID_UPI: {
    code: 'INVALID_UPI',
    message: 'Invalid UPI ID. Please check and try again.',
    retry: true,
    fallbackOptions: ['card', 'wallet'],
  },
  BANK_SERVER_DOWN: {
    code: 'BANK_SERVER_DOWN',
    message: 'Bank server is temporarily unavailable. Please try another method.',
    retry: true,
    fallbackOptions: ['upi', 'wallet', 'cash'],
  },
};

// Payment error UI component
const PaymentErrorModal = ({
  error,
  onRetry,
  onChangMethod
}: PaymentErrorModalProps) => {
  const errorInfo = paymentErrorHandlers[error.code];

  return (
    <div className="payment-error-modal" role="alertdialog">
      <ErrorIcon />
      <h2>Payment Failed</h2>
      <p>{errorInfo.message}</p>

      <div className="error-actions">
        {errorInfo.retry && (
          <button onClick={onRetry} className="primary">
            Try Again
          </button>
        )}

        {errorInfo.fallbackOptions.length > 0 && (
          <>
            <p>Or pay with:</p>
            <div className="fallback-options">
              {errorInfo.fallbackOptions.map(option => (
                <button
                  key={option}
                  onClick={() => onChangMethod(option)}
                  className="fallback-option"
                >
                  <PaymentIcon type={option} />
                  {option.toUpperCase()}
                </button>
              ))}
            </div>
          </>
        )}
      </div>
    </div>
  );
};
```

---

## Quick Reference Cheat Sheet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         QUICK REFERENCE                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Protocol Choice:                                                           â”‚
â”‚  â€¢ Location tracking â†’ WebSocket (MUST)                                     â”‚
â”‚  â€¢ Fare estimate, booking â†’ REST                                            â”‚
â”‚  â€¢ NOT: Polling (too expensive)                                             â”‚
â”‚                                                                              â”‚
â”‚  Database Choice:                                                           â”‚
â”‚  â€¢ Users, Rides, Payments â†’ PostgreSQL (ACID)                              â”‚
â”‚  â€¢ Driver locations â†’ Redis GEO                                            â”‚
â”‚  â€¢ Location history â†’ Cassandra                                            â”‚
â”‚  â€¢ Search â†’ Elasticsearch / Google Places                                  â”‚
â”‚                                                                              â”‚
â”‚  Real-time Features:                                                        â”‚
â”‚  â€¢ Driver location â†’ WebSocket + Redis Pub/Sub                             â”‚
â”‚  â€¢ Ride status â†’ WebSocket                                                  â”‚
â”‚  â€¢ Driver matching â†’ Redis GEORADIUS + distributed lock                   â”‚
â”‚                                                                              â”‚
â”‚  Caching:                                                                   â”‚
â”‚  â€¢ Fare estimates â†’ Redis (geohash key, 5 min TTL)                        â”‚
â”‚  â€¢ ETA â†’ Redis (1 min TTL)                                                 â”‚
â”‚  â€¢ Surge â†’ Redis (5 min TTL)                                               â”‚
â”‚                                                                              â”‚
â”‚  State Management:                                                          â”‚
â”‚  â€¢ Ride state â†’ Zustand (state machine)                                    â”‚
â”‚  â€¢ Server data â†’ React Query                                                â”‚
â”‚  â€¢ WebSocket â†’ Custom provider                                              â”‚
â”‚                                                                              â”‚
â”‚  Key Algorithms:                                                            â”‚
â”‚  â€¢ Driver matching â†’ Score-based (distance, rating, acceptance)            â”‚
â”‚  â€¢ Surge pricing â†’ Demand/supply ratio per zone                            â”‚
â”‚  â€¢ ETA â†’ Google Directions API + caching                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
