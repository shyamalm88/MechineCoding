# Chat Application - WhatsApp/LinkedIn/Facebook Web (HLD)

## Table of Contents
1. [Problem Statement & Requirements](#1-problem-statement--requirements)
2. [High-Level Architecture](#2-high-level-architecture)
3. [Component Architecture](#3-component-architecture)
4. [Data Flow](#4-data-flow)
5. [API Design & Communication Protocols](#5-api-design--communication-protocols)
6. [Database Design](#6-database-design)
7. [Caching Strategy](#7-caching-strategy)
8. [State Management](#8-state-management)
9. [Performance Optimization](#9-performance-optimization)
10. [Error Handling & Edge Cases](#10-error-handling--edge-cases)
11. [Interview Cross-Questions](#11-interview-cross-questions)
12. [Accessibility (A11y)](#12-accessibility-a11y)
13. [Security Deep Dive](#13-security-deep-dive)
14. [Mobile & Touch Considerations](#14-mobile--touch-considerations)
15. [Comprehensive Testing Strategy](#15-comprehensive-testing-strategy)
16. [Offline Support & PWA](#16-offline-support--pwa)
17. [Media Deep Dive](#17-media-deep-dive)
18. [Internationalization (i18n)](#18-internationalization-i18n)
19. [Analytics & Observability](#19-analytics--observability)
20. [Notification System](#20-notification-system)
21. [Advanced Message Features](#21-advanced-message-features)

---

## 1. Problem Statement & Requirements

### Functional Requirements
- Real-time 1:1 messaging
- Group chats (up to 256 members)
- Message status (sent, delivered, read)
- Typing indicators
- Online/offline presence
- Media sharing (images, videos, documents)
- Message search
- Push notifications
- Message history with infinite scroll
- End-to-end encryption (WhatsApp style)

### Non-Functional Requirements
- **Latency**: Message delivery < 100ms (same region)
- **Reliability**: 99.99% message delivery guarantee
- **Scalability**: Handle 1B+ users, 100B+ messages/day
- **Ordering**: Messages must appear in correct order
- **Consistency**: Eventual consistency acceptable
- **Offline**: Queue messages when recipient offline

### Capacity Estimation
```
Daily Active Users (DAU): 500 million
Messages per user per day: 50
Total messages per day: 25 billion
Peak messages per second: 500,000
Average message size: 100 bytes
Storage per day: 2.5 TB (messages only)
WebSocket connections: 100 million concurrent
```

---

## 2. High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Web App       â”‚  â”‚   iOS App       â”‚  â”‚  Android App    â”‚             â”‚
â”‚  â”‚   (React)       â”‚  â”‚   (Swift)       â”‚  â”‚  (Kotlin)       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                    â”‚                    â”‚                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â”‚ WebSocket â”‚ HTTPS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚           â”‚
                          â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            EDGE LAYER                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Load Balancer (L7)                                â”‚   â”‚
â”‚  â”‚   â€¢ SSL Termination  â€¢ WebSocket Upgrade  â€¢ Sticky Sessions         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebSocket     â”‚      â”‚   REST API      â”‚      â”‚   Media         â”‚
â”‚   Gateway       â”‚      â”‚   Server        â”‚      â”‚   Service       â”‚
â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚
â”‚ â€¢ Connection    â”‚      â”‚ â€¢ Auth          â”‚      â”‚ â€¢ Upload        â”‚
â”‚   management    â”‚      â”‚ â€¢ User CRUD     â”‚      â”‚ â€¢ Processing    â”‚
â”‚ â€¢ Message       â”‚      â”‚ â€¢ Chat CRUD     â”‚      â”‚ â€¢ CDN URLs      â”‚
â”‚   routing       â”‚      â”‚ â€¢ Search        â”‚      â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MESSAGE LAYER                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Message       â”‚  â”‚   Presence      â”‚  â”‚   Notification  â”‚             â”‚
â”‚  â”‚   Queue         â”‚  â”‚   Service       â”‚  â”‚   Service       â”‚             â”‚
â”‚  â”‚   (Kafka)       â”‚  â”‚   (Redis)       â”‚  â”‚   (FCM/APNS)    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA LAYER                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Cassandra     â”‚  â”‚     Redis       â”‚  â”‚    S3/Blob      â”‚             â”‚
â”‚  â”‚   (Messages)    â”‚  â”‚   (Cache/PubSub)â”‚  â”‚   (Media)       â”‚             â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚             â”‚
â”‚  â”‚ â€¢ Messages      â”‚  â”‚ â€¢ Sessions      â”‚  â”‚ â€¢ Images        â”‚             â”‚
â”‚  â”‚ â€¢ Chats         â”‚  â”‚ â€¢ Presence      â”‚  â”‚ â€¢ Videos        â”‚             â”‚
â”‚  â”‚ â€¢ Users         â”‚  â”‚ â€¢ Unread count  â”‚  â”‚ â€¢ Documents     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Connection Architecture (WebSocket)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBSOCKET CONNECTION ARCHITECTURE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   User A (NYC)                                              User B (London) â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚        â”‚                                                          â”‚         â”‚
â”‚        â”‚  WebSocket                                    WebSocket  â”‚         â”‚
â”‚        â”‚                                                          â”‚         â”‚
â”‚        â–¼                                                          â–¼         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  WS Gateway â”‚                                       â”‚  WS Gateway â”‚    â”‚
â”‚   â”‚  (NYC)      â”‚                                       â”‚  (London)   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                                                     â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                 â”‚                                            â”‚
â”‚                                 â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚    Redis Pub/Sub    â”‚                                 â”‚
â”‚                     â”‚    (Message Broker) â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                 â”‚                                            â”‚
â”‚         Message Flow:                                                       â”‚
â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚         1. User A sends message â†’ WS Gateway NYC                            â”‚
â”‚         2. Gateway publishes to Redis channel: user:{B_id}                 â”‚
â”‚         3. London Gateway subscribed to user:{B_id}                        â”‚
â”‚         4. London Gateway pushes to User B's WebSocket                     â”‚
â”‚                                                                              â”‚
â”‚   Why Redis Pub/Sub (not direct WS)?                                       â”‚
â”‚   â€¢ Users connect to different gateway instances                           â”‚
â”‚   â€¢ Need cross-gateway message routing                                     â”‚
â”‚   â€¢ Redis provides fan-out to all subscribed gateways                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Component Architecture

### Frontend Component Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ChatApp                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                            â”‚                                           â”‚  â”‚
â”‚  â”‚       Sidebar              â”‚              ChatWindow                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚      Header          â”‚  â”‚  â”‚            ChatHeader               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Avatar â”‚ Searchâ”‚  â”‚  â”‚  â”‚  â”‚ Avatar â”‚ Name â”‚ Status â”‚ Â·Â·Â· â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                            â”‚                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚    ConversationList  â”‚  â”‚  â”‚         MessageList                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   (Virtualized)      â”‚  â”‚  â”‚        (Virtualized)                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ConversationItem â”‚â”‚  â”‚  â”‚  â”‚  MessageBubble (Received)   â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚  â”‚  â”‚  â”‚  â””â”€ Text â”‚ Media â”‚ Time     â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚Avatarâ”‚Name   â”‚ â”‚â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚      â”‚Previewâ”‚ â”‚â”‚  â”‚  â”‚                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚      â”‚Time   â”‚ â”‚â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â”‚      â”‚Badge  â”‚ â”‚â”‚  â”‚  â”‚  â”‚  MessageBubble (Sent)       â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚  â”‚  â”‚  â”‚  â””â”€ Text â”‚ Status (âœ“âœ“) â”‚Timeâ”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                      â”‚  â”‚  â”‚                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ConversationItem â”‚â”‚  â”‚  â”‚  â”‚  TypingIndicator            â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚  â”‚  â””â”€ "John is typing..."     â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         ...          â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                            â”‚                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚                               â”‚  â”‚         MessageInput                 â”‚ â”‚  â”‚
â”‚                               â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚
â”‚                               â”‚  â”‚  â”‚ ðŸ“Ž â”‚ TextField â”‚ ðŸ˜Š â”‚ ðŸŽ¤ â”‚ âž¤  â”‚â”‚ â”‚  â”‚
â”‚                               â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚
â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Modals / Overlays                                  â”‚  â”‚
â”‚  â”‚  â€¢ MediaPreview  â€¢ ContactInfo  â€¢ GroupInfo  â€¢ NewChat  â€¢ Settings   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Component Responsibilities

| Component | Responsibility |
|-----------|---------------|
| `ConversationList` | List of chats, unread badges, last message preview, virtualized |
| `MessageList` | Display messages, infinite scroll (older messages), auto-scroll new |
| `MessageBubble` | Render message content, status indicators, reply preview |
| `MessageInput` | Text input, emoji picker, file upload, voice recording |
| `TypingIndicator` | Show when other user is typing (debounced) |
| `WebSocketProvider` | Manage WS connection, reconnection, message dispatch |

---

## 4. Data Flow

### Send Message Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User A  â”‚     â”‚  UI      â”‚     â”‚WebSocket â”‚     â”‚  Server  â”‚     â”‚  User B  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 1. Type & Send â”‚                â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 2. Optimistic  â”‚                â”‚                â”‚
     â”‚                â”‚    update (âœ“)  â”‚                â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
     â”‚                â”‚    Show pendingâ”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 3. See message â”‚                â”‚                â”‚                â”‚
     â”‚    with (âœ“)    â”‚                â”‚                â”‚                â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 4. Send via WS â”‚                â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 5. Store in DB â”‚
     â”‚                â”‚                â”‚                â”‚ 6. Ack back    â”‚
     â”‚                â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 7. Update to   â”‚                â”‚                â”‚
     â”‚                â”‚    (âœ“âœ“) sent   â”‚                â”‚                â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 8. See (âœ“âœ“)    â”‚                â”‚                â”‚ 9. If B online:â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚    Push via WS â”‚
     â”‚                â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 10. B receives â”‚
     â”‚                â”‚                â”‚                â”‚     message    â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚ 11. Send       â”‚
     â”‚                â”‚                â”‚                â”‚     delivered  â”‚
     â”‚                â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     ack        â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 12. Update to  â”‚                â”‚                â”‚
     â”‚                â”‚     (âœ“âœ“) blue  â”‚                â”‚                â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
```

### Message Status States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MESSAGE STATUS FLOW                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Status         Symbol    Meaning                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚   PENDING        ðŸ•        Message sent to server (optimistic)              â”‚
â”‚   SENT           âœ“         Server acknowledged, stored                      â”‚
â”‚   DELIVERED      âœ“âœ“        Recipient's device received                      â”‚
â”‚   READ           âœ“âœ“ (blue) Recipient opened chat                            â”‚
â”‚   FAILED         âš ï¸        Send failed, retry option                        â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   State Machine:                                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   server ack   â”Œâ”€â”€â”€â”€â”€â”€â”   device ack   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ PENDING â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ SENT â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ DELIVERED â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                                                   â”‚                â”‚
â”‚        â”‚ timeout                                    read ackâ”‚                â”‚
â”‚        â–¼                                                   â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”Œâ”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ FAILED  â”‚                                         â”‚ READ â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â””â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Implementation:                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚   â€¢ Client generates tempId for optimistic update                          â”‚
â”‚   â€¢ Server returns serverId on ack                                         â”‚
â”‚   â€¢ Client replaces tempId with serverId                                   â”‚
â”‚   â€¢ Status updates via WebSocket events                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Typing Indicator Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TYPING INDICATOR FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   User A (typing)                Server                 User B (viewing)    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚   1. Start typing                   â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚   â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Debounce (300ms) â”€â”€â”€â”€â”€â”€â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚   2. WS: { type: "typing",          â”‚                          â”‚            â”‚
â”‚           chatId: "..." }           â”‚                          â”‚            â”‚
â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚â”€â”€â”€â”€ WS: typing event â”€â”€â”€>â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                  3. Show indicator    â”‚
â”‚        â”‚                            â”‚                     "A is typing..."  â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚   â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ 3 seconds pass â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
â”‚        â”‚    (no more typing)        â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚   4. WS: { type: "stop_typing" }    â”‚                          â”‚            â”‚
â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚â”€â”€ WS: stop_typing â”€â”€â”€â”€â”€â”€>â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                  5. Hide indicator    â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚                                                                              â”‚
â”‚   Optimization:                                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚   â€¢ Debounce typing events (don't send on every keystroke)                 â”‚
â”‚   â€¢ Auto-timeout after 3-5 seconds of no typing                            â”‚
â”‚   â€¢ Don't store in DB (ephemeral, real-time only)                          â”‚
â”‚   â€¢ Use Redis Pub/Sub, not persistent storage                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Presence (Online/Offline) Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PRESENCE SYSTEM                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Presence States:                                                          â”‚
â”‚   â€¢ ONLINE:      Currently connected                                        â”‚
â”‚   â€¢ AWAY:        Connected but idle (5 min)                                â”‚
â”‚   â€¢ OFFLINE:     Disconnected                                               â”‚
â”‚   â€¢ LAST_SEEN:   "Last seen today at 3:45 PM"                              â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Architecture:                                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚   Client    â”‚     â”‚  WS Gateway â”‚     â”‚   Redis     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚   Connectâ”‚                   â”‚                   â”‚                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚ SET user:{id}:    â”‚                          â”‚
â”‚          â”‚                   â”‚ presence "online" â”‚                          â”‚
â”‚          â”‚                   â”‚ EX 30             â”‚ (TTL 30s)                â”‚
â”‚          â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚ PUBLISH presence  â”‚                          â”‚
â”‚          â”‚                   â”‚ {userId, "online"}â”‚                          â”‚
â”‚          â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚          â”‚         Every 25s â”‚                   â”‚                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Heartbeat â”€â”€â”€â”€>â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚ EXPIRE user:{id}: â”‚                          â”‚
â”‚          â”‚                   â”‚ presence 30       â”‚                          â”‚
â”‚          â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚   Disconnect (or timeout)    â”‚                   â”‚                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚ DEL user:{id}:    â”‚                          â”‚
â”‚          â”‚                   â”‚ presence          â”‚                          â”‚
â”‚          â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚          â”‚                   â”‚                   â”‚                          â”‚
â”‚          â”‚                   â”‚ SET user:{id}:    â”‚                          â”‚
â”‚          â”‚                   â”‚ last_seen {time}  â”‚                          â”‚
â”‚          â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Subscribing to Presence:                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚   â€¢ Client subscribes to contacts' presence channels                       â”‚
â”‚   â€¢ Receives real-time updates via Pub/Sub                                 â”‚
â”‚   â€¢ Caches presence locally, refreshes on focus                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. API Design & Communication Protocols

### Protocol Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROTOCOL COMPARISON FOR CHAT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Protocol     â”‚     Pros      â”‚     Cons      â”‚     Use Case              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Bi-direct   â”‚ â€¢ Connection  â”‚ â€¢ âœ… REAL-TIME MESSAGES   â”‚
â”‚   WebSocket     â”‚ â€¢ Low latency â”‚   overhead    â”‚ â€¢ âœ… Typing indicators    â”‚
â”‚                 â”‚ â€¢ Full-duplex â”‚ â€¢ Scaling     â”‚ â€¢ âœ… Presence updates     â”‚
â”‚                 â”‚ â€¢ Push model  â”‚   complexity  â”‚ â€¢ âœ… Read receipts        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Simple      â”‚ â€¢ No push     â”‚ â€¢ Auth, user CRUD         â”‚
â”‚    REST         â”‚ â€¢ Stateless   â”‚ â€¢ Higher      â”‚ â€¢ Chat history (GET)      â”‚
â”‚                 â”‚ â€¢ Cacheable   â”‚   latency     â”‚ â€¢ Media upload            â”‚
â”‚                 â”‚               â”‚               â”‚ â€¢ Search                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Less over-  â”‚ â€¢ One-way     â”‚ â€¢ âŒ NOT for chat         â”‚
â”‚    SSE          â”‚   head than WSâ”‚ â€¢ No clientâ†’  â”‚ â€¢ Could work for          â”‚
â”‚                 â”‚ â€¢ Auto-recon  â”‚   server      â”‚   notifications only      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Held until  â”‚ â€¢ Reconnect   â”‚ â€¢ âŒ NOT for chat         â”‚
â”‚  Long Polling   â”‚   data ready  â”‚   overhead    â”‚ â€¢ Fallback only           â”‚
â”‚                 â”‚ â€¢ Simple impl â”‚ â€¢ Higher      â”‚   (if WS unavailable)     â”‚
â”‚                 â”‚               â”‚   latency     â”‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚ â€¢ Efficient   â”‚ â€¢ No browser  â”‚ â€¢ Service-to-service      â”‚
â”‚    gRPC         â”‚ â€¢ Streaming   â”‚   support     â”‚ â€¢ Backend communication   â”‚
â”‚                 â”‚ â€¢ Type-safe   â”‚               â”‚ â€¢ NOT for frontend        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why WebSocket is Essential for Chat

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WHY WEBSOCKET (NOT LONG POLLING) FOR CHAT                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Long Polling for Chat (Problems):                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                              â”‚
â”‚  Client â”€â”€â”€â”€â”€â”€â”€> Request â”€â”€â”€â”€â”€â”€â”€> Server (hold 30s)                         â”‚
â”‚         <â”€â”€â”€â”€â”€â”€â”€ Response â”€â”€â”€â”€â”€â”€â”€ (on new message OR timeout)               â”‚
â”‚  Client â”€â”€â”€â”€â”€â”€â”€> Request â”€â”€â”€â”€â”€â”€â”€> Server (immediately reconnect)            â”‚
â”‚         <â”€â”€â”€â”€â”€â”€â”€ Response â”€â”€â”€â”€â”€â”€â”€ ...                                       â”‚
â”‚                                                                              â”‚
â”‚  Problems:                                                                  â”‚
â”‚  â€¢ Reconnection overhead for every message                                  â”‚
â”‚  â€¢ Can't push multiple messages quickly                                     â”‚
â”‚  â€¢ Typing indicators would flood with requests                              â”‚
â”‚  â€¢ ~30s latency worst case                                                  â”‚
â”‚  â€¢ Server holds millions of connections waiting                             â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  WebSocket for Chat (Solution):                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚                                                                              â”‚
â”‚  Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server (persistent connection)           â”‚
â”‚         â”‚                        â”‚                                          â”‚
â”‚         â”‚<â”€â”€â”€ message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                          â”‚
â”‚         â”‚<â”€â”€â”€ typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                          â”‚
â”‚         â”‚<â”€â”€â”€ read_receipt â”€â”€â”€â”€â”€â”€â”‚                                          â”‚
â”‚         â”‚<â”€â”€â”€ presence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                          â”‚
â”‚         â”‚                        â”‚                                          â”‚
â”‚         â”‚â”€â”€â”€â”€ send_message â”€â”€â”€â”€â”€>â”‚                                          â”‚
â”‚         â”‚â”€â”€â”€â”€ typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                          â”‚
â”‚         â”‚                        â”‚                                          â”‚
â”‚                                                                              â”‚
â”‚  Benefits:                                                                  â”‚
â”‚  â€¢ Instant delivery (< 100ms)                                               â”‚
â”‚  â€¢ Bi-directional (client sends AND receives)                              â”‚
â”‚  â€¢ Multiple event types on same connection                                  â”‚
â”‚  â€¢ Efficient for high-frequency events (typing)                            â”‚
â”‚  â€¢ Lower server load (no reconnection)                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket Message Protocol

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WEBSOCKET MESSAGE SCHEMA                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Connection:                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚  wss://chat.app.com/ws?token=JWT                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Client â†’ Server Messages:                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚                                                                              â”‚
â”‚  // Send message                                                            â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "message",                                                       â”‚
â”‚    "tempId": "temp-uuid-123",  // Client-generated                         â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "content": {                                                              â”‚
â”‚      "type": "text",                                                        â”‚
â”‚      "text": "Hello!"                                                       â”‚
â”‚    },                                                                        â”‚
â”‚    "replyTo": null  // or message_id                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Typing indicator                                                        â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "typing",                                                        â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "isTyping": true                                                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Read receipt                                                            â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "read",                                                          â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "messageId": "msg_789"  // Last read message                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Ping (keep-alive)                                                       â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "ping"                                                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Server â†’ Client Messages:                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚                                                                              â”‚
â”‚  // Message acknowledgment                                                  â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "message_ack",                                                   â”‚
â”‚    "tempId": "temp-uuid-123",                                               â”‚
â”‚    "messageId": "msg_server_id",                                            â”‚
â”‚    "status": "sent",                                                        â”‚
â”‚    "timestamp": "2024-12-22T10:30:00Z"                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // New message received                                                    â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "message",                                                       â”‚
â”‚    "messageId": "msg_999",                                                  â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "senderId": "user_123",                                                  â”‚
â”‚    "content": { "type": "text", "text": "Hi there!" },                     â”‚
â”‚    "timestamp": "2024-12-22T10:31:00Z"                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Delivery receipt                                                        â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "delivered",                                                     â”‚
â”‚    "messageId": "msg_789",                                                  â”‚
â”‚    "chatId": "chat_456"                                                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Read receipt                                                            â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "read",                                                          â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "userId": "user_789",                                                    â”‚
â”‚    "lastReadMessageId": "msg_999"                                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Typing indicator                                                        â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "typing",                                                        â”‚
â”‚    "chatId": "chat_456",                                                    â”‚
â”‚    "userId": "user_123",                                                    â”‚
â”‚    "isTyping": true                                                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Presence update                                                         â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "presence",                                                      â”‚
â”‚    "userId": "user_123",                                                    â”‚
â”‚    "status": "online" | "offline",                                          â”‚
â”‚    "lastSeen": "2024-12-22T10:30:00Z"  // if offline                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  // Pong                                                                    â”‚
â”‚  {                                                                           â”‚
â”‚    "type": "pong"                                                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### REST API Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REST API DESIGN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  CHATS                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€                                                                       â”‚
â”‚  GET    /api/v1/chats                                                       â”‚
â”‚         â†’ List all chats with last message, unread count                   â”‚
â”‚         Response: { chats: [...], nextCursor }                             â”‚
â”‚                                                                              â”‚
â”‚  POST   /api/v1/chats                                                       â”‚
â”‚         Body: { participantIds: [...] } or { groupName, participantIds }   â”‚
â”‚         â†’ Create new 1:1 or group chat                                     â”‚
â”‚                                                                              â”‚
â”‚  GET    /api/v1/chats/:chatId                                               â”‚
â”‚         â†’ Get chat details (participants, settings)                        â”‚
â”‚                                                                              â”‚
â”‚  MESSAGES                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                                    â”‚
â”‚  GET    /api/v1/chats/:chatId/messages                                      â”‚
â”‚         ?cursor=xxx&limit=50&direction=before                              â”‚
â”‚         â†’ Fetch message history (infinite scroll)                          â”‚
â”‚         Response: { messages: [...], nextCursor, hasMore }                 â”‚
â”‚                                                                              â”‚
â”‚  POST   /api/v1/chats/:chatId/messages                                      â”‚
â”‚         â†’ Fallback if WebSocket unavailable                                â”‚
â”‚                                                                              â”‚
â”‚  DELETE /api/v1/messages/:messageId                                         â”‚
â”‚         â†’ Delete message (for self or everyone)                            â”‚
â”‚                                                                              â”‚
â”‚  MEDIA                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€                                                                       â”‚
â”‚  POST   /api/v1/media/upload                                                â”‚
â”‚         Content-Type: multipart/form-data                                  â”‚
â”‚         â†’ Upload image/video/document                                      â”‚
â”‚         Response: { mediaId, url, thumbnailUrl }                           â”‚
â”‚                                                                              â”‚
â”‚  SEARCH                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€                                                                      â”‚
â”‚  GET    /api/v1/search/messages                                             â”‚
â”‚         ?q=keyword&chatId=xxx                                              â”‚
â”‚         â†’ Full-text search in messages                                     â”‚
â”‚                                                                              â”‚
â”‚  USERS                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€                                                                       â”‚
â”‚  GET    /api/v1/users/:userId                                               â”‚
â”‚  PUT    /api/v1/users/me                                                    â”‚
â”‚  GET    /api/v1/users/me/contacts                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Database Design

### SQL vs NoSQL Decision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE CHOICE RATIONALE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Cassandra (Primary for Messages)                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Messages (write-heavy, time-series)                              â”‚   â”‚
â”‚  â”‚  â€¢ Chat metadata                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Read receipts                                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  WHY Cassandra:                                                      â”‚   â”‚
â”‚  â”‚  â€¢ Horizontal scaling for billions of messages                      â”‚   â”‚
â”‚  â”‚  â€¢ Write-optimized (high ingestion rate)                            â”‚   â”‚
â”‚  â”‚  â€¢ Time-based partitioning (chat_id + bucket)                      â”‚   â”‚
â”‚  â”‚  â€¢ Tunable consistency (ONE for speed)                              â”‚   â”‚
â”‚  â”‚  â€¢ No single point of failure                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why NOT PostgreSQL:                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Can't scale writes horizontally                                  â”‚   â”‚
â”‚  â”‚  â€¢ 25B messages/day would overwhelm single master                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     PostgreSQL (Relational Data)                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ User accounts (ACID required)                                    â”‚   â”‚
â”‚  â”‚  â€¢ Authentication                                                    â”‚   â”‚
â”‚  â”‚  â€¢ Contact relationships                                            â”‚   â”‚
â”‚  â”‚  â€¢ Group memberships                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Settings/preferences                                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  WHY SQL:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Strong consistency for auth                                      â”‚   â”‚
â”‚  â”‚  â€¢ Complex queries (user lookup)                                    â”‚   â”‚
â”‚  â”‚  â€¢ Relatively low write volume                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Redis (Cache + Real-time)                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ User sessions                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Presence (online/offline)                                        â”‚   â”‚
â”‚  â”‚  â€¢ Unread message counts                                             â”‚   â”‚
â”‚  â”‚  â€¢ Recent messages cache                                             â”‚   â”‚
â”‚  â”‚  â€¢ Pub/Sub for message routing                                      â”‚   â”‚
â”‚  â”‚  â€¢ Rate limiting                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Typing indicators (ephemeral)                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Data Structures:                                                    â”‚   â”‚
â”‚  â”‚  â€¢ String: presence, last_seen                                      â”‚   â”‚
â”‚  â”‚  â€¢ Hash: user sessions                                              â”‚   â”‚
â”‚  â”‚  â€¢ Sorted Set: recent messages, unread counts                       â”‚   â”‚
â”‚  â”‚  â€¢ Pub/Sub: message routing, typing events                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Elasticsearch (Search)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Full-text message search                                         â”‚   â”‚
â”‚  â”‚  â€¢ User search                                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Index messages async via Kafka consumer                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     S3/Blob Storage (Media)                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  USE FOR:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Images, videos, voice messages                                   â”‚   â”‚
â”‚  â”‚  â€¢ Documents                                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Serve via CDN with signed URLs                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cassandra Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CASSANDRA SCHEMA                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Table: messages                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  CREATE TABLE messages (                                                    â”‚
â”‚    chat_id       UUID,                                                      â”‚
â”‚    bucket        TEXT,           -- "2024-12-22" (daily bucket)            â”‚
â”‚    message_id    TIMEUUID,       -- Time-based UUID for ordering           â”‚
â”‚    sender_id     UUID,                                                      â”‚
â”‚    content_type  TEXT,           -- "text", "image", "video"               â”‚
â”‚    content       TEXT,           -- Encrypted message or media URL         â”‚
â”‚    reply_to      TIMEUUID,                                                  â”‚
â”‚    created_at    TIMESTAMP,                                                 â”‚
â”‚    PRIMARY KEY ((chat_id, bucket), message_id)                             â”‚
â”‚  ) WITH CLUSTERING ORDER BY (message_id DESC);                             â”‚
â”‚                                                                              â”‚
â”‚  Why this design:                                                           â”‚
â”‚  â€¢ Partition by (chat_id, bucket) â†’ limits partition size                  â”‚
â”‚  â€¢ Cluster by message_id DESC â†’ newest first (efficient reads)             â”‚
â”‚  â€¢ TIMEUUID provides ordering + uniqueness                                 â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Table: chats_by_user                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  CREATE TABLE chats_by_user (                                               â”‚
â”‚    user_id           UUID,                                                  â”‚
â”‚    last_activity     TIMESTAMP,                                             â”‚
â”‚    chat_id           UUID,                                                  â”‚
â”‚    chat_type         TEXT,        -- "direct", "group"                     â”‚
â”‚    chat_name         TEXT,        -- null for 1:1, name for group          â”‚
â”‚    last_message      TEXT,                                                  â”‚
â”‚    unread_count      INT,                                                   â”‚
â”‚    PRIMARY KEY (user_id, last_activity, chat_id)                           â”‚
â”‚  ) WITH CLUSTERING ORDER BY (last_activity DESC, chat_id ASC);             â”‚
â”‚                                                                              â”‚
â”‚  Why this design:                                                           â”‚
â”‚  â€¢ Partition by user_id â†’ one query for user's chats                       â”‚
â”‚  â€¢ Order by last_activity â†’ recent chats first                             â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Table: chat_participants                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  CREATE TABLE chat_participants (                                           â”‚
â”‚    chat_id      UUID,                                                       â”‚
â”‚    user_id      UUID,                                                       â”‚
â”‚    role         TEXT,    -- "member", "admin", "owner"                     â”‚
â”‚    joined_at    TIMESTAMP,                                                  â”‚
â”‚    PRIMARY KEY (chat_id, user_id)                                          â”‚
â”‚  );                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Caching Strategy

### Multi-Layer Cache

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHING ARCHITECTURE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LAYER 1: Client Cache (In-Memory)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Messages per chat (last 100 in memory)                           â”‚   â”‚
â”‚  â”‚  â€¢ Chat list with previews                                          â”‚   â”‚
â”‚  â”‚  â€¢ Presence status                                                   â”‚   â”‚
â”‚  â”‚  â€¢ User profiles (contacts)                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Implementation: React Query / Zustand                              â”‚   â”‚
â”‚  â”‚  TTL: Session-based, invalidated by WebSocket events               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  LAYER 2: IndexedDB (Offline Persistence)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ All messages (encrypted at rest)                                 â”‚   â”‚
â”‚  â”‚  â€¢ Media thumbnails                                                  â”‚   â”‚
â”‚  â”‚  â€¢ Draft messages                                                    â”‚   â”‚
â”‚  â”‚  â€¢ Offline queue (pending sends)                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Sync Strategy:                                                      â”‚   â”‚
â”‚  â”‚  â€¢ On reconnect, fetch messages since lastSyncTimestamp             â”‚   â”‚
â”‚  â”‚  â€¢ Merge with local, resolve conflicts                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  LAYER 3: Redis (Server-side)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cache Keys:                                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  // Recent messages (last 50 per chat)                              â”‚   â”‚
â”‚  â”‚  messages:recent:{chat_id} â†’ ZSET (message_id, timestamp)           â”‚   â”‚
â”‚  â”‚  message:{message_id} â†’ HASH (content, sender, timestamp)           â”‚   â”‚
â”‚  â”‚  TTL: 24 hours                                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  // Chat list per user                                              â”‚   â”‚
â”‚  â”‚  chats:user:{user_id} â†’ ZSET (chat_id, last_activity)              â”‚   â”‚
â”‚  â”‚  chat:{chat_id}:meta â†’ HASH (name, last_message, ...)              â”‚   â”‚
â”‚  â”‚  TTL: 1 hour                                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  // Unread counts                                                    â”‚   â”‚
â”‚  â”‚  unread:{user_id}:{chat_id} â†’ INT                                   â”‚   â”‚
â”‚  â”‚  TTL: None (always accurate)                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  // Presence                                                         â”‚   â”‚
â”‚  â”‚  presence:{user_id} â†’ STRING ("online" | timestamp)                 â”‚   â”‚
â”‚  â”‚  TTL: 30 seconds (refresh with heartbeat)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  // Sessions                                                         â”‚   â”‚
â”‚  â”‚  session:{token} â†’ HASH (user_id, device_id, ...)                   â”‚   â”‚
â”‚  â”‚  TTL: 30 days                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache Invalidation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CACHE INVALIDATION FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Event: New Message                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   1. Store in Cassandra                                                     â”‚
â”‚   2. Update Redis:                                                          â”‚
â”‚      â€¢ ZADD messages:recent:{chat_id}                                      â”‚
â”‚      â€¢ SET message:{msg_id}                                                 â”‚
â”‚      â€¢ ZADD chats:user:{user_id} (update last_activity)                    â”‚
â”‚      â€¢ INCR unread:{recipient_id}:{chat_id}                                â”‚
â”‚   3. PUBLISH message:{chat_id} (notify connected clients)                  â”‚
â”‚   4. Clients receive via WebSocket, update local cache                     â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Event: Message Read                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚   1. DEL unread:{user_id}:{chat_id}                                        â”‚
â”‚   2. PUBLISH read_receipt:{chat_id}                                        â”‚
â”‚   3. Sender's client updates message status                                â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   Event: Message Deleted                                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚   1. Mark deleted in Cassandra (soft delete)                               â”‚
â”‚   2. DEL message:{msg_id} from Redis                                       â”‚
â”‚   3. PUBLISH delete:{chat_id} { messageId }                                â”‚
â”‚   4. Clients remove from local cache                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. State Management

### State Categories

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       STATE MANAGEMENT STRATEGY                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WEBSOCKET STATE (Custom Context/Store)                             â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚   â”‚
â”‚  â”‚  â€¢ Connection status (connected, connecting, disconnected)          â”‚   â”‚
â”‚  â”‚  â€¢ Reconnection attempts                                             â”‚   â”‚
â”‚  â”‚  â€¢ Message queue (pending sends)                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why separate: Needs special handling, reconnection logic           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SERVER STATE (React Query)                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚  â€¢ Chat list                                                         â”‚   â”‚
â”‚  â”‚  â€¢ Message history (paginated)                                       â”‚   â”‚
â”‚  â”‚  â€¢ User profiles                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Search results                                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why React Query: Caching, background refresh, pagination           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Special: Messages updated via WebSocket invalidate cache           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  REAL-TIME STATE (Zustand/Jotai)                                    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚   â”‚
â”‚  â”‚  â€¢ Typing indicators per chat                                       â”‚   â”‚
â”‚  â”‚  â€¢ Presence per user                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Unread counts                                                     â”‚   â”‚
â”‚  â”‚  â€¢ New messages (optimistic)                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why separate: High-frequency updates, ephemeral data               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UI STATE (Local useState)                                          â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚  â€¢ Selected chat                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Modal open/closed                                                 â”‚   â”‚
â”‚  â”‚  â€¢ Input draft text                                                  â”‚   â”‚
â”‚  â”‚  â€¢ Emoji picker visible                                              â”‚   â”‚
â”‚  â”‚  â€¢ Scroll position                                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why local: Component-specific, no need to share                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PERSISTED STATE (IndexedDB)                                        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚   â”‚
â”‚  â”‚  â€¢ Message history (offline)                                        â”‚   â”‚
â”‚  â”‚  â€¢ Draft messages                                                    â”‚   â”‚
â”‚  â”‚  â€¢ Pending sends queue                                               â”‚   â”‚
â”‚  â”‚  â€¢ Media cache                                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Why IndexedDB: Offline support, large storage                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket Integration with React

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   WEBSOCKET + REACT ARCHITECTURE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  WebSocketProvider                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Manages single WebSocket connection                               â”‚   â”‚
â”‚  â”‚  â€¢ Handles reconnection with exponential backoff                    â”‚   â”‚
â”‚  â”‚  â€¢ Dispatches events to subscribers                                 â”‚   â”‚
â”‚  â”‚  â€¢ Provides send() method to children                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Connection Lifecycle:                                               â”‚   â”‚
â”‚  â”‚  1. Mount â†’ Connect                                                  â”‚   â”‚
â”‚  â”‚  2. Disconnect â†’ Reconnect (with backoff)                           â”‚   â”‚
â”‚  â”‚  3. Unmount â†’ Close connection                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Event Dispatch:                                                     â”‚   â”‚
â”‚  â”‚  â€¢ message â†’ Add to React Query cache                               â”‚   â”‚
â”‚  â”‚  â€¢ typing â†’ Update Zustand store                                    â”‚   â”‚
â”‚  â”‚  â€¢ presence â†’ Update Zustand store                                  â”‚   â”‚
â”‚  â”‚  â€¢ read_receipt â†’ Update message status in cache                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Reconnection Strategy:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Attempt 1: Wait 1 second                                           â”‚   â”‚
â”‚  â”‚  Attempt 2: Wait 2 seconds                                          â”‚   â”‚
â”‚  â”‚  Attempt 3: Wait 4 seconds                                          â”‚   â”‚
â”‚  â”‚  Attempt 4: Wait 8 seconds                                          â”‚   â”‚
â”‚  â”‚  ...                                                                 â”‚   â”‚
â”‚  â”‚  Max: 30 seconds between attempts                                   â”‚   â”‚
â”‚  â”‚  Give up after: 10 attempts â†’ Show "Connection failed" UI          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Performance Optimization

### Message List Virtualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MESSAGE LIST OPTIMIZATION                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Problem: 10,000+ messages in a chat â†’ DOM overload                        â”‚
â”‚                                                                              â”‚
â”‚  Solution: Virtualized list (react-window / react-virtuoso)                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  â–² Load More (Intersection Observer)                       â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â”‚   â”‚
â”‚  â”‚  â•‘  Spacer (overscan top)                                     â•‘     â”‚   â”‚
â”‚  â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£     â”‚   â”‚
â”‚  â”‚  â•‘                                                            â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  Rendered Messages (only visible + buffer)                 â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â”‚ Message 1 (Dec 22, 10:00 AM)                         â”‚  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â”‚ Message 2 (Dec 22, 10:01 AM)                         â”‚  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘     â”‚   â”‚
â”‚  â”‚  â•‘  ...                                                       â•‘     â”‚   â”‚
â”‚  â”‚  â•‘                                                            â•‘     â”‚   â”‚
â”‚  â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£     â”‚   â”‚
â”‚  â”‚  â•‘  Spacer (overscan bottom)                                  â•‘     â”‚   â”‚
â”‚  â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Special Considerations:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  â€¢ Variable height messages (text vs image vs video)                       â”‚
â”‚  â€¢ Auto-scroll to bottom on new message (if already at bottom)            â”‚
â”‚  â€¢ Maintain scroll position when loading older messages                    â”‚
â”‚  â€¢ Date separators between message groups                                  â”‚
â”‚                                                                              â”‚
â”‚  Library: react-virtuoso (better for chat, handles variable heights)       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Optimistic Updates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       OPTIMISTIC UPDATES                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Send Message Optimistically:                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚                                                                              â”‚
â”‚  1. User clicks send                                                        â”‚
â”‚  2. Generate tempId (UUID)                                                  â”‚
â”‚  3. Add to local state immediately with status: "pending"                  â”‚
â”‚  4. Show message in UI with clock icon                                     â”‚
â”‚  5. Send via WebSocket                                                      â”‚
â”‚  6. On ack: Replace tempId with serverId, update status: "sent"           â”‚
â”‚  7. On delivery: Update status: "delivered"                                â”‚
â”‚  8. On read: Update status: "read"                                         â”‚
â”‚  9. On error: Update status: "failed", show retry option                   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Message Object:                                                     â”‚   â”‚
â”‚  â”‚  {                                                                   â”‚   â”‚
â”‚  â”‚    id: "temp-uuid-123",  // or "server-uuid-456" after ack          â”‚   â”‚
â”‚  â”‚    tempId: "temp-uuid-123",  // kept for matching                   â”‚   â”‚
â”‚  â”‚    content: "Hello!",                                                â”‚   â”‚
â”‚  â”‚    status: "pending" | "sent" | "delivered" | "read" | "failed",   â”‚   â”‚
â”‚  â”‚    timestamp: "2024-12-22T10:30:00Z"                                â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Retry Failed Messages:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ Store failed messages in IndexedDB                                       â”‚
â”‚  â€¢ Show retry button on failed message                                      â”‚
â”‚  â€¢ On app start, check for pending messages                                â”‚
â”‚  â€¢ Automatically retry when reconnected                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Media Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MEDIA OPTIMIZATION                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Upload Flow:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  1. User selects image                                                      â”‚
â”‚  2. Client generates thumbnail (canvas)                                    â”‚
â”‚  3. Show thumbnail immediately (optimistic)                                â”‚
â”‚  4. Upload original to S3 via presigned URL                               â”‚
â”‚  5. Server processes: resize, compress, generate thumbnails               â”‚
â”‚  6. Update message with final URLs                                         â”‚
â”‚                                                                              â”‚
â”‚  Image Sizes:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  â€¢ Thumbnail: 100x100 (chat list preview)                                  â”‚
â”‚  â€¢ Preview: 400x400 (in-chat display)                                      â”‚
â”‚  â€¢ Full: 1920xAuto (on click/zoom)                                         â”‚
â”‚                                                                              â”‚
â”‚  Lazy Loading:                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â€¢ Only load images in viewport                                            â”‚
â”‚  â€¢ Use Intersection Observer                                                â”‚
â”‚  â€¢ Show blur-up placeholder while loading                                  â”‚
â”‚                                                                              â”‚
â”‚  Progressive Loading:                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  â€¢ Load thumbnail first (fast)                                             â”‚
â”‚  â€¢ Fade in full image when ready                                           â”‚
â”‚                                                                              â”‚
â”‚  Formats:                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                                    â”‚
â”‚  â€¢ WebP for modern browsers (30% smaller)                                  â”‚
â”‚  â€¢ JPEG fallback                                                            â”‚
â”‚  â€¢ AVIF for latest browsers (50% smaller)                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Error Handling & Edge Cases

### Connection Failure Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONNECTION FAILURE HANDLING                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Scenario 1: WebSocket Disconnects Mid-Chat                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ Show "Connecting..." banner                                              â”‚
â”‚  â€¢ Queue outgoing messages locally                                          â”‚
â”‚  â€¢ Reconnect with exponential backoff                                       â”‚
â”‚  â€¢ On reconnect:                                                            â”‚
â”‚    - Fetch messages since last known timestamp                             â”‚
â”‚    - Send queued messages                                                   â”‚
â”‚    - Re-subscribe to presence channels                                     â”‚
â”‚                                                                              â”‚
â”‚  Scenario 2: Send Fails                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ Mark message as "failed"                                                 â”‚
â”‚  â€¢ Show retry button                                                        â”‚
â”‚  â€¢ Persist to IndexedDB for later retry                                    â”‚
â”‚  â€¢ On reconnect, auto-retry pending messages                               â”‚
â”‚                                                                              â”‚
â”‚  Scenario 3: App Backgrounded (Mobile Web)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ WebSocket may close                                                      â”‚
â”‚  â€¢ On foreground:                                                           â”‚
â”‚    - Check connection state                                                 â”‚
â”‚    - Reconnect if needed                                                    â”‚
â”‚    - Sync missed messages                                                   â”‚
â”‚                                                                              â”‚
â”‚  Scenario 4: Offline Mode                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  â€¢ Show offline banner                                                      â”‚
â”‚  â€¢ Allow viewing cached messages                                            â”‚
â”‚  â€¢ Queue sends in IndexedDB                                                 â”‚
â”‚  â€¢ Sync when back online                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Edge Cases

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EDGE CASES                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Message Ordering                                                        â”‚
â”‚     â€¢ Use TIMEUUID for server-side ordering                                â”‚
â”‚     â€¢ Display by server timestamp, not client timestamp                    â”‚
â”‚     â€¢ Handle late-arriving messages (insert in correct position)           â”‚
â”‚                                                                              â”‚
â”‚  2. Duplicate Messages                                                      â”‚
â”‚     â€¢ Idempotency key (tempId) prevents duplicates                         â”‚
â”‚     â€¢ Server checks if tempId already processed                            â”‚
â”‚     â€¢ Client deduplicates by messageId                                     â”‚
â”‚                                                                              â”‚
â”‚  3. Large Group Messages                                                    â”‚
â”‚     â€¢ Batch delivery receipts (every 5 seconds)                            â”‚
â”‚     â€¢ Don't show individual read receipts in large groups                  â”‚
â”‚     â€¢ Limit typing indicators to "X people typing..."                      â”‚
â”‚                                                                              â”‚
â”‚  4. Multi-Device Sync                                                       â”‚
â”‚     â€¢ Each device has separate WebSocket                                   â”‚
â”‚     â€¢ Server broadcasts to all user's devices                              â”‚
â”‚     â€¢ Sync read status across devices                                      â”‚
â”‚                                                                              â”‚
â”‚  5. Time Sync Issues                                                        â”‚
â”‚     â€¢ Client clock may be wrong                                            â”‚
â”‚     â€¢ Use server timestamp for ordering                                    â”‚
â”‚     â€¢ Display relative time ("2 min ago") to hide discrepancies           â”‚
â”‚                                                                              â”‚
â”‚  6. Media Upload Failures                                                   â”‚
â”‚     â€¢ Resumable uploads (tus protocol)                                     â”‚
â”‚     â€¢ Retry with exponential backoff                                       â”‚
â”‚     â€¢ Show progress and allow cancel                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Interview Cross-Questions

### Common Questions & Answers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTERVIEW CROSS-QUESTIONS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Q: Why WebSocket instead of Long Polling?                                  â”‚
â”‚  A: â€¢ Chat requires bi-directional real-time (send AND receive)            â”‚
â”‚     â€¢ Typing indicators would flood long polling                           â”‚
â”‚     â€¢ Single persistent connection more efficient                          â”‚
â”‚     â€¢ Sub-100ms latency vs 30s worst case                                  â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: Why Cassandra instead of PostgreSQL for messages?                       â”‚
â”‚  A: â€¢ 25 billion messages/day needs horizontal write scaling               â”‚
â”‚     â€¢ PostgreSQL can't scale writes (single master)                        â”‚
â”‚     â€¢ Cassandra: linear scaling by adding nodes                            â”‚
â”‚     â€¢ Time-series access pattern (messages by chat + time)                 â”‚
â”‚     â€¢ Tunable consistency (ONE for speed, acceptable for chat)             â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you ensure message delivery guarantee?                           â”‚
â”‚  A: â€¢ At-least-once: Retry until ack received                              â”‚
â”‚     â€¢ Idempotency key (tempId) prevents duplicates                        â”‚
â”‚     â€¢ Persistent queue for offline recipients                             â”‚
â”‚     â€¢ Message stored in DB before ack sent                                 â”‚
â”‚     â€¢ Push notification as backup if WS disconnected                      â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you handle millions of concurrent WebSocket connections?        â”‚
â”‚  A: â€¢ Horizontal scaling of WS gateway servers                             â”‚
â”‚     â€¢ Redis Pub/Sub for cross-server message routing                      â”‚
â”‚     â€¢ Sticky sessions (but handle failover)                               â”‚
â”‚     â€¢ Each server handles ~100K connections                               â”‚
â”‚     â€¢ 100M users â†’ ~1000 WS gateway instances                             â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you implement end-to-end encryption?                             â”‚
â”‚  A: â€¢ Signal Protocol (used by WhatsApp)                                   â”‚
â”‚     â€¢ Key exchange: X3DH (Extended Triple Diffie-Hellman)                  â”‚
â”‚     â€¢ Message encryption: Double Ratchet Algorithm                        â”‚
â”‚     â€¢ Keys stored on device only, not server                              â”‚
â”‚     â€¢ Server stores only encrypted blobs                                   â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you handle message ordering across devices?                      â”‚
â”‚  A: â€¢ TIMEUUID guarantees ordering (timestamp + random)                    â”‚
â”‚     â€¢ Server is source of truth                                            â”‚
â”‚     â€¢ Client displays by server timestamp                                  â”‚
â”‚     â€¢ Late messages inserted in correct position                          â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: How do you implement typing indicators efficiently?                     â”‚
â”‚  A: â€¢ Debounce: Send "typing" only after 300ms of typing                   â”‚
â”‚     â€¢ Auto-timeout: 3 seconds of no typing â†’ stop                         â”‚
â”‚     â€¢ Redis Pub/Sub (ephemeral, don't persist)                            â”‚
â”‚     â€¢ Don't store in DB                                                     â”‚
â”‚     â€¢ Throttle on receiver side too                                        â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  Q: What metrics would you track?                                           â”‚
â”‚  A: â€¢ Message latency (send to deliver)                                    â”‚
â”‚     â€¢ WebSocket connection success rate                                    â”‚
â”‚     â€¢ Reconnection frequency                                               â”‚
â”‚     â€¢ Message delivery rate (sent vs delivered)                           â”‚
â”‚     â€¢ API response times                                                    â”‚
â”‚     â€¢ Error rates by type                                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. Accessibility (A11y)

### Chat Accessibility Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACCESSIBLE CHAT INTERFACE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Screen Reader Announcements:                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ARIA Live Regions for Real-time Content                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  <!-- New message announcements -->                                 â”‚   â”‚
â”‚  â”‚  <div aria-live="polite" aria-atomic="false" class="sr-only">      â”‚   â”‚
â”‚  â”‚    <!-- Dynamically inserted: "John: Hello, how are you?" -->      â”‚   â”‚
â”‚  â”‚  </div>                                                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  <!-- Typing indicator -->                                          â”‚   â”‚
â”‚  â”‚  <div aria-live="polite" aria-atomic="true" class="sr-only">       â”‚   â”‚
â”‚  â”‚    <!-- "John is typing" or empty -->                               â”‚   â”‚
â”‚  â”‚  </div>                                                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  <!-- Connection status -->                                         â”‚   â”‚
â”‚  â”‚  <div aria-live="assertive" class="sr-only">                        â”‚   â”‚
â”‚  â”‚    <!-- "Connection lost. Reconnecting..." -->                      â”‚   â”‚
â”‚  â”‚  </div>                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Why Different aria-live Values:                                            â”‚
â”‚  â€¢ polite: New messages (don't interrupt current reading)                  â”‚
â”‚  â€¢ assertive: Connection issues (important, announce immediately)          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Accessible Message Component

```jsx
// AccessibleMessage.jsx
const AccessibleMessage = ({ message, isOwn, status }) => {
  const statusLabels = {
    pending: 'Sending',
    sent: 'Sent',
    delivered: 'Delivered',
    read: 'Read',
    failed: 'Failed to send'
  };

  return (
    <article
      role="article"
      aria-label={`Message from ${message.senderName}`}
      className={`message ${isOwn ? 'message--own' : 'message--other'}`}
    >
      <div className="message__content">
        {message.type === 'text' && (
          <p>{message.text}</p>
        )}

        {message.type === 'image' && (
          <img
            src={message.imageUrl}
            alt={message.altText || 'Shared image'}
            // Allow zoom for low vision users
            style={{ maxWidth: '100%', cursor: 'zoom-in' }}
          />
        )}

        {message.type === 'voice' && (
          <VoiceMessage
            src={message.audioUrl}
            duration={message.duration}
            // Transcript for deaf/hard of hearing
            transcript={message.transcript}
          />
        )}
      </div>

      <footer className="message__meta">
        <time
          dateTime={message.timestamp}
          aria-label={formatTimeForScreenReader(message.timestamp)}
        >
          {formatTime(message.timestamp)}
        </time>

        {isOwn && (
          <span
            className="message__status"
            aria-label={statusLabels[status]}
          >
            <StatusIcon status={status} aria-hidden="true" />
          </span>
        )}
      </footer>
    </article>
  );
};

// Voice message with transcript
const VoiceMessage = ({ src, duration, transcript }) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = useRef(null);

  return (
    <div className="voice-message">
      <button
        aria-label={isPlaying ? 'Pause voice message' : 'Play voice message'}
        aria-pressed={isPlaying}
        onClick={() => {
          if (isPlaying) {
            audioRef.current.pause();
          } else {
            audioRef.current.play();
          }
          setIsPlaying(!isPlaying);
        }}
      >
        {isPlaying ? <PauseIcon /> : <PlayIcon />}
      </button>

      <audio
        ref={audioRef}
        src={src}
        onEnded={() => setIsPlaying(false)}
      />

      <span aria-label={`Duration: ${duration} seconds`}>
        {formatDuration(duration)}
      </span>

      {/* Transcript for accessibility */}
      {transcript && (
        <details className="voice-message__transcript">
          <summary>Show transcript</summary>
          <p>{transcript}</p>
        </details>
      )}
    </div>
  );
};
```

### Keyboard Navigation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KEYBOARD NAVIGATION MAP                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Global Shortcuts:                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚  Ctrl/Cmd + K        â†’ Search conversations                                 â”‚
â”‚  Ctrl/Cmd + N        â†’ New chat                                             â”‚
â”‚  Ctrl/Cmd + Shift+M  â†’ Mute/unmute notifications                           â”‚
â”‚  Escape              â†’ Close modal/overlay                                  â”‚
â”‚                                                                              â”‚
â”‚  Conversation List:                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â†‘/â†“                 â†’ Navigate conversations                               â”‚
â”‚  Enter               â†’ Open selected conversation                           â”‚
â”‚  Delete/Backspace    â†’ Archive conversation (with confirmation)            â”‚
â”‚  Tab                 â†’ Move to chat window                                  â”‚
â”‚                                                                              â”‚
â”‚  Chat Window:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  Tab                 â†’ Cycle: Messages â†’ Input â†’ Send button               â”‚
â”‚  Shift+Tab           â†’ Reverse cycle                                        â”‚
â”‚  â†‘/â†“ (in messages)   â†’ Navigate between messages                           â”‚
â”‚  Enter (on message)  â†’ Open message actions menu                           â”‚
â”‚  R                   â†’ Reply to focused message                             â”‚
â”‚  F                   â†’ Forward focused message                              â”‚
â”‚                                                                              â”‚
â”‚  Message Input:                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  Enter               â†’ Send message                                         â”‚
â”‚  Shift+Enter         â†’ New line                                             â”‚
â”‚  Ctrl/Cmd + E        â†’ Open emoji picker                                   â”‚
â”‚  Ctrl/Cmd + U        â†’ Attach file                                         â”‚
â”‚  Escape              â†’ Clear input / Close picker                          â”‚
â”‚                                                                              â”‚
â”‚  Emoji Picker:                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â†‘/â†“/â†/â†’             â†’ Navigate emojis                                      â”‚
â”‚  Enter               â†’ Select emoji                                         â”‚
â”‚  Tab                 â†’ Switch category                                      â”‚
â”‚  Type                â†’ Search emojis                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Focus Management

```jsx
// useFocusManagement.js
const useChatFocus = () => {
  const messageInputRef = useRef(null);
  const messageListRef = useRef(null);
  const lastFocusedMessage = useRef(null);

  // Focus input when chat opens
  useEffect(() => {
    if (messageInputRef.current) {
      messageInputRef.current.focus();
    }
  }, [selectedChatId]);

  // Trap focus in modals
  const trapFocus = useCallback((modalRef) => {
    const focusableElements = modalRef.current.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    const handleKeyDown = (e) => {
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        } else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    };

    modalRef.current.addEventListener('keydown', handleKeyDown);
    firstElement?.focus();

    return () => {
      modalRef.current?.removeEventListener('keydown', handleKeyDown);
    };
  }, []);

  // Restore focus after modal closes
  const restoreFocus = useCallback(() => {
    lastFocusedMessage.current?.focus();
  }, []);

  // Scroll new messages into view without losing focus
  const announceNewMessage = useCallback((message) => {
    // Don't steal focus, just announce
    const announcement = document.getElementById('message-announcer');
    if (announcement) {
      announcement.textContent = `${message.senderName}: ${message.text}`;
    }
  }, []);

  return {
    messageInputRef,
    messageListRef,
    trapFocus,
    restoreFocus,
    announceNewMessage
  };
};
```

### Color and Visual Accessibility

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COLOR & VISUAL ACCESSIBILITY                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Message Status (Not Color-Only):                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                              â”‚
â”‚  âŒ Bad: Only color difference                                              â”‚
â”‚     â€¢ Sent: gray checkmark                                                  â”‚
â”‚     â€¢ Read: blue checkmark                                                  â”‚
â”‚                                                                              â”‚
â”‚  âœ… Good: Color + Shape/Text                                                â”‚
â”‚     â€¢ Pending: ðŸ• clock icon                                                â”‚
â”‚     â€¢ Sent: âœ“ single checkmark                                              â”‚
â”‚     â€¢ Delivered: âœ“âœ“ double checkmark                                        â”‚
â”‚     â€¢ Read: âœ“âœ“ filled/bold checkmarks + "Read" on hover/focus             â”‚
â”‚     â€¢ Failed: âš ï¸ warning icon + "Retry" text                               â”‚
â”‚                                                                              â”‚
â”‚  Online Status:                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚     â€¢ Online: Green dot + "Online" text                                     â”‚
â”‚     â€¢ Away: Yellow dot + "Away" text                                        â”‚
â”‚     â€¢ Offline: No dot + "Last seen..." text                                â”‚
â”‚                                                                              â”‚
â”‚  Unread Messages:                                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚     â€¢ Badge with count (not just color)                                     â”‚
â”‚     â€¢ Bold conversation name                                                â”‚
â”‚     â€¢ Screen reader: "3 unread messages"                                   â”‚
â”‚                                                                              â”‚
â”‚  High Contrast Mode:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  @media (prefers-contrast: high) {                                         â”‚
â”‚    .message--own { border: 2px solid #000; }                               â”‚
â”‚    .message--other { border: 2px solid #333; }                             â”‚
â”‚    .unread-badge { outline: 2px solid #000; }                              â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  Reduced Motion:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  @media (prefers-reduced-motion: reduce) {                                 â”‚
â”‚    .typing-indicator { animation: none; }                                  â”‚
â”‚    .message-enter { transition: none; }                                    â”‚
â”‚    .notification { animation: none; }                                      â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. Security Deep Dive

### End-to-End Encryption Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    END-TO-END ENCRYPTION (Signal Protocol)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Key Components:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚                                                                              â”‚
â”‚  1. Identity Key Pair (Long-term)                                          â”‚
â”‚     â€¢ Generated on first app install                                        â”‚
â”‚     â€¢ Never changes (unless reinstall)                                      â”‚
â”‚     â€¢ Public key registered with server                                     â”‚
â”‚                                                                              â”‚
â”‚  2. Signed Pre-Key (Medium-term)                                           â”‚
â”‚     â€¢ Rotated periodically (e.g., weekly)                                  â”‚
â”‚     â€¢ Signed by identity key                                                â”‚
â”‚                                                                              â”‚
â”‚  3. One-Time Pre-Keys (Ephemeral)                                          â”‚
â”‚     â€¢ Batch of 100 keys uploaded to server                                 â”‚
â”‚     â€¢ Each used once, then discarded                                        â”‚
â”‚     â€¢ Provides forward secrecy                                              â”‚
â”‚                                                                              â”‚
â”‚  4. Session Keys (Per conversation)                                        â”‚
â”‚     â€¢ Derived using X3DH key exchange                                       â”‚
â”‚     â€¢ Ratcheted with each message                                          â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  X3DH Key Exchange (Initial Setup):                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚                                                                              â”‚
â”‚   Alice                           Server                          Bob       â”‚
â”‚     â”‚                               â”‚                              â”‚        â”‚
â”‚     â”‚  1. Fetch Bob's key bundle    â”‚                              â”‚        â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚        â”‚
â”‚     â”‚                               â”‚                              â”‚        â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                              â”‚        â”‚
â”‚     â”‚  â”‚ Bob's Bundle:         â”‚    â”‚                              â”‚        â”‚
â”‚     â”‚  â”‚ â€¢ Identity Key (IKb)  â”‚    â”‚                              â”‚        â”‚
â”‚     â”‚  â”‚ â€¢ Signed Pre-Key (SPK)â”‚    â”‚                              â”‚        â”‚
â”‚     â”‚  â”‚ â€¢ One-Time Key (OPK)  â”‚    â”‚                              â”‚        â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                              â”‚        â”‚
â”‚     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚        â”‚
â”‚     â”‚                               â”‚                              â”‚        â”‚
â”‚     â”‚  2. Compute shared secret:                                   â”‚        â”‚
â”‚     â”‚     DH1 = DH(IKa, SPKb)                                      â”‚        â”‚
â”‚     â”‚     DH2 = DH(EKa, IKb)                                       â”‚        â”‚
â”‚     â”‚     DH3 = DH(EKa, SPKb)                                      â”‚        â”‚
â”‚     â”‚     DH4 = DH(EKa, OPKb)                                      â”‚        â”‚
â”‚     â”‚     SK = KDF(DH1 || DH2 || DH3 || DH4)                       â”‚        â”‚
â”‚     â”‚                               â”‚                              â”‚        â”‚
â”‚     â”‚  3. Send encrypted message    â”‚                              â”‚        â”‚
â”‚     â”‚     + Ephemeral Key (EKa)     â”‚                              â”‚        â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚        â”‚
â”‚     â”‚                               â”‚                              â”‚        â”‚
â”‚     â”‚                               â”‚  4. Bob derives same SK      â”‚        â”‚
â”‚     â”‚                               â”‚     Decrypts message         â”‚        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Frontend Encryption Implementation

```jsx
// encryption/SignalProtocol.js
import { KeyHelper, SignalProtocolAddress, SessionBuilder } from '@aspect/signal';

class E2EEncryption {
  constructor(userId) {
    this.userId = userId;
    this.store = new SignalProtocolStore(); // IndexedDB backed
  }

  // Generate keys on first install
  async generateIdentity() {
    const identityKeyPair = await KeyHelper.generateIdentityKeyPair();
    const registrationId = KeyHelper.generateRegistrationId();
    const signedPreKey = await KeyHelper.generateSignedPreKey(identityKeyPair, 1);
    const preKeys = await KeyHelper.generatePreKeys(1, 100);

    // Store locally (encrypted with device key)
    await this.store.storeIdentityKeyPair(identityKeyPair);
    await this.store.storeRegistrationId(registrationId);
    await this.store.storeSignedPreKey(signedPreKey);

    for (const preKey of preKeys) {
      await this.store.storePreKey(preKey.keyId, preKey.keyPair);
    }

    // Upload public keys to server
    return {
      identityKey: identityKeyPair.pubKey,
      registrationId,
      signedPreKey: {
        keyId: signedPreKey.keyId,
        publicKey: signedPreKey.keyPair.pubKey,
        signature: signedPreKey.signature
      },
      preKeys: preKeys.map(pk => ({
        keyId: pk.keyId,
        publicKey: pk.keyPair.pubKey
      }))
    };
  }

  // Encrypt message for recipient
  async encryptMessage(recipientId, plaintext) {
    const address = new SignalProtocolAddress(recipientId, 1);
    const sessionCipher = new SessionCipher(this.store, address);

    const ciphertext = await sessionCipher.encrypt(
      new TextEncoder().encode(plaintext)
    );

    return {
      type: ciphertext.type, // 1 = PreKey, 3 = Normal
      body: arrayBufferToBase64(ciphertext.body)
    };
  }

  // Decrypt received message
  async decryptMessage(senderId, ciphertext) {
    const address = new SignalProtocolAddress(senderId, 1);
    const sessionCipher = new SessionCipher(this.store, address);

    let plaintext;
    if (ciphertext.type === 3) {
      // PreKeyWhisperMessage (first message)
      plaintext = await sessionCipher.decryptPreKeyWhisperMessage(
        base64ToArrayBuffer(ciphertext.body)
      );
    } else {
      // WhisperMessage (subsequent messages)
      plaintext = await sessionCipher.decryptWhisperMessage(
        base64ToArrayBuffer(ciphertext.body)
      );
    }

    return new TextDecoder().decode(plaintext);
  }
}
```

### XSS Prevention in Messages

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XSS PREVENTION IN CHAT                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  CRITICAL: User messages can contain malicious content!                     â”‚
â”‚                                                                              â”‚
â”‚  Attack Vectors:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  â€¢ <script>alert('xss')</script>                                           â”‚
â”‚  â€¢ <img src=x onerror="steal(document.cookie)">                            â”‚
â”‚  â€¢ javascript:alert('xss') in links                                        â”‚
â”‚  â€¢ <a href="data:text/html,<script>...</script>">                          â”‚
â”‚                                                                              â”‚
â”‚  Defense Layers:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚                                                                              â”‚
â”‚  1. Content Security Policy (CSP)                                          â”‚
â”‚     Content-Security-Policy:                                                â”‚
â”‚       default-src 'self';                                                   â”‚
â”‚       script-src 'self';                                                    â”‚
â”‚       style-src 'self' 'unsafe-inline';                                    â”‚
â”‚       img-src 'self' https://media.chat.app blob: data:;                   â”‚
â”‚       connect-src 'self' wss://chat.app;                                   â”‚
â”‚       frame-ancestors 'none';                                               â”‚
â”‚                                                                              â”‚
â”‚  2. React's Built-in Escaping                                              â”‚
â”‚     // âœ… Safe - React escapes by default                                  â”‚
â”‚     <p>{message.text}</p>                                                   â”‚
â”‚                                                                              â”‚
â”‚     // âŒ DANGEROUS - Never do this                                         â”‚
â”‚     <div dangerouslySetInnerHTML={{ __html: message.text }} />             â”‚
â”‚                                                                              â”‚
â”‚  3. URL Sanitization                                                        â”‚
â”‚     const sanitizeUrl = (url) => {                                         â”‚
â”‚       const parsed = new URL(url);                                         â”‚
â”‚       const allowed = ['http:', 'https:', 'mailto:'];                     â”‚
â”‚       if (!allowed.includes(parsed.protocol)) {                            â”‚
â”‚         return '#blocked';                                                  â”‚
â”‚       }                                                                     â”‚
â”‚       return url;                                                           â”‚
â”‚     };                                                                      â”‚
â”‚                                                                              â”‚
â”‚  4. Link Preview Sanitization                                              â”‚
â”‚     â€¢ Generate previews server-side                                        â”‚
â”‚     â€¢ Sanitize HTML with DOMPurify                                         â”‚
â”‚     â€¢ Validate image URLs                                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Session Security

```jsx
// security/SessionManager.js
class SecureSessionManager {
  constructor() {
    this.SESSION_TIMEOUT = 30 * 24 * 60 * 60 * 1000; // 30 days
    this.IDLE_TIMEOUT = 30 * 60 * 1000; // 30 minutes
  }

  // Store session securely
  async storeSession(token, userData) {
    // Use httpOnly cookie for token (set by server)
    // Store non-sensitive data in encrypted IndexedDB
    const encryptedData = await this.encrypt(JSON.stringify(userData));
    await this.db.put('session', {
      data: encryptedData,
      expiresAt: Date.now() + this.SESSION_TIMEOUT
    });
  }

  // Detect session hijacking
  validateSession(session) {
    const fingerprint = this.getDeviceFingerprint();
    if (session.fingerprint !== fingerprint) {
      this.logout();
      throw new Error('Session invalidated: device mismatch');
    }
  }

  // Handle idle timeout
  setupIdleDetection() {
    let idleTimer;

    const resetTimer = () => {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        this.lockScreen(); // Require re-auth
      }, this.IDLE_TIMEOUT);
    };

    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
      document.addEventListener(event, resetTimer, { passive: true });
    });

    resetTimer();
  }

  // Secure logout
  async logout() {
    // Clear all sensitive data
    await this.db.clear('session');
    await this.db.clear('messages'); // Clear cached messages
    await this.db.clear('keys'); // Clear encryption keys

    // Revoke token server-side
    await fetch('/api/auth/logout', { method: 'POST' });

    // Clear memory
    this.encryptionKeys = null;

    // Redirect
    window.location.href = '/login';
  }
}
```

---

## 14. Mobile & Touch Considerations

### Touch Gestures

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TOUCH GESTURE SYSTEM                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Message Gestures:                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   Swipe Right â†’ Reply                                               â”‚   â”‚
â”‚  â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”>            â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚   â”‚  â†©ï¸  "Hello, how are you?"             â”‚                        â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   Long Press â†’ Context Menu                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚   â”‚  â±ï¸ (500ms)                            â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Reply                   â”‚           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Forward                 â”‚           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Copy                    â”‚           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Delete                  â”‚           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Star                    â”‚           â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                        â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   Double Tap â†’ React with â¤ï¸                                        â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚   â”‚  ðŸ‘†ðŸ‘†                                   â”‚  â†’ â¤ï¸                 â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Conversation List Gestures:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚  â€¢ Swipe Left â†’ Archive / Delete                                           â”‚
â”‚  â€¢ Swipe Right â†’ Pin / Mark as read                                        â”‚
â”‚  â€¢ Pull Down â†’ Refresh                                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Swipe to Reply Implementation

```jsx
// components/SwipeableMessage.jsx
import { useSpring, animated } from '@react-spring/web';
import { useDrag } from '@use-gesture/react';

const SwipeableMessage = ({ message, onReply }) => {
  const SWIPE_THRESHOLD = 80;
  const MAX_SWIPE = 100;

  const [{ x }, api] = useSpring(() => ({ x: 0 }));
  const [showReplyIcon, setShowReplyIcon] = useState(false);

  const bind = useDrag(({
    down,
    movement: [mx],
    velocity: [vx],
    direction: [dx],
    cancel
  }) => {
    // Only allow right swipe
    if (dx < 0) {
      cancel();
      return;
    }

    if (down) {
      // Clamp movement
      const clampedX = Math.min(mx, MAX_SWIPE);
      api.start({ x: clampedX, immediate: true });
      setShowReplyIcon(clampedX > SWIPE_THRESHOLD * 0.5);
    } else {
      // Release
      if (mx > SWIPE_THRESHOLD || vx > 0.5) {
        // Trigger reply
        onReply(message);
        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }
      // Spring back
      api.start({ x: 0 });
      setShowReplyIcon(false);
    }
  }, {
    axis: 'x',
    bounds: { left: 0, right: MAX_SWIPE },
    rubberband: true
  });

  return (
    <div className="swipeable-message-container">
      {/* Reply icon that appears during swipe */}
      <animated.div
        className="reply-icon"
        style={{
          opacity: x.to([0, SWIPE_THRESHOLD], [0, 1]),
          transform: x.to(v => `scale(${Math.min(v / SWIPE_THRESHOLD, 1)})`)
        }}
      >
        <ReplyIcon />
      </animated.div>

      {/* Swipeable message */}
      <animated.div
        {...bind()}
        style={{ x, touchAction: 'pan-y' }}
        className="message-bubble"
      >
        <MessageContent message={message} />
      </animated.div>
    </div>
  );
};
```

### Virtual Keyboard Handling

```jsx
// hooks/useVirtualKeyboard.js
const useVirtualKeyboard = () => {
  const [keyboardHeight, setKeyboardHeight] = useState(0);
  const [isKeyboardVisible, setIsKeyboardVisible] = useState(false);

  useEffect(() => {
    // Modern API (Chrome 94+)
    if ('virtualKeyboard' in navigator) {
      navigator.virtualKeyboard.overlaysContent = true;

      navigator.virtualKeyboard.addEventListener('geometrychange', (e) => {
        const { height } = e.target.boundingRect;
        setKeyboardHeight(height);
        setIsKeyboardVisible(height > 0);
      });
      return;
    }

    // Fallback: VisualViewport API
    if (window.visualViewport) {
      const handleResize = () => {
        const heightDiff = window.innerHeight - window.visualViewport.height;
        setKeyboardHeight(Math.max(0, heightDiff));
        setIsKeyboardVisible(heightDiff > 100);
      };

      window.visualViewport.addEventListener('resize', handleResize);
      window.visualViewport.addEventListener('scroll', handleResize);

      return () => {
        window.visualViewport.removeEventListener('resize', handleResize);
        window.visualViewport.removeEventListener('scroll', handleResize);
      };
    }
  }, []);

  return { keyboardHeight, isKeyboardVisible };
};

// Usage in ChatWindow
const ChatWindow = () => {
  const { keyboardHeight, isKeyboardVisible } = useVirtualKeyboard();
  const messageListRef = useRef(null);

  // Scroll to bottom when keyboard opens
  useEffect(() => {
    if (isKeyboardVisible && messageListRef.current) {
      messageListRef.current.scrollToEnd({ animated: true });
    }
  }, [isKeyboardVisible]);

  return (
    <div
      className="chat-window"
      style={{
        paddingBottom: keyboardHeight,
        transition: 'padding-bottom 0.2s ease'
      }}
    >
      <MessageList ref={messageListRef} />
      <MessageInput />
    </div>
  );
};
```

### Mobile-Optimized Media

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MOBILE MEDIA OPTIMIZATION                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Image Capture:                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚  <input
â”‚    type="file"
â”‚    accept="image/*"
â”‚    capture="environment"   <!-- Use back camera -->
â”‚  />                                                                          â”‚
â”‚                                                                              â”‚
â”‚  Camera UI (Custom):                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â€¢ Full-screen camera view                                                  â”‚
â”‚  â€¢ Pinch to zoom                                                            â”‚
â”‚  â€¢ Tap to focus                                                             â”‚
â”‚  â€¢ Flash toggle                                                             â”‚
â”‚  â€¢ Front/back camera switch                                                 â”‚
â”‚                                                                              â”‚
â”‚  Image Compression Before Upload:                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  const compressImage = async (file, maxWidth = 1920) => {                  â”‚
â”‚    const img = await createImageBitmap(file);                              â”‚
â”‚    const canvas = new OffscreenCanvas(                                     â”‚
â”‚      Math.min(img.width, maxWidth),                                        â”‚
â”‚      Math.min(img.height, maxWidth * (img.height / img.width))             â”‚
â”‚    );                                                                       â”‚
â”‚    const ctx = canvas.getContext('2d');                                    â”‚
â”‚    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);                 â”‚
â”‚    return canvas.convertToBlob({ type: 'image/webp', quality: 0.8 });     â”‚
â”‚  };                                                                         â”‚
â”‚                                                                              â”‚
â”‚  Voice Message Recording:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  â€¢ Hold to record (like WhatsApp)                                          â”‚
â”‚  â€¢ Swipe up to lock recording                                              â”‚
â”‚  â€¢ Swipe left to cancel                                                    â”‚
â”‚  â€¢ Waveform visualization                                                   â”‚
â”‚  â€¢ Use Opus codec for small size                                           â”‚
â”‚                                                                              â”‚
â”‚  Video Optimization:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â€¢ Compress to 720p max for mobile upload                                  â”‚
â”‚  â€¢ Generate thumbnail on client                                            â”‚
â”‚  â€¢ Resumable upload (tus protocol)                                         â”‚
â”‚  â€¢ Background upload with progress                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 15. Comprehensive Testing Strategy

### Testing Pyramid for Chat App

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TESTING PYRAMID                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                            â•±â•²                                                â”‚
â”‚                           â•±  â•²                                               â”‚
â”‚                          â•± E2Eâ•²         5-10 tests                          â”‚
â”‚                         â•±â”€â”€â”€â”€â”€â”€â•²        (Critical flows)                    â”‚
â”‚                        â•±        â•²                                            â”‚
â”‚                       â•±Integrationâ•²     50-100 tests                        â”‚
â”‚                      â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²     (WebSocket, API)                    â”‚
â”‚                     â•±              â•²                                         â”‚
â”‚                    â•±   Unit Tests   â•²   500+ tests                          â”‚
â”‚                   â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²  (Components, Utils)                 â”‚
â”‚                  â•±                    â•²                                      â”‚
â”‚                 â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                  â”‚
â”‚                                                                              â”‚
â”‚  Focus Areas:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  â€¢ Unit: Message rendering, encryption, date formatting                    â”‚
â”‚  â€¢ Integration: WebSocket connection, state management                     â”‚
â”‚  â€¢ E2E: Send/receive messages, login flow, media upload                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Unit Tests

```jsx
// __tests__/components/MessageBubble.test.jsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { MessageBubble } from '../MessageBubble';

describe('MessageBubble', () => {
  const mockMessage = {
    id: 'msg-1',
    text: 'Hello, world!',
    senderId: 'user-1',
    timestamp: '2024-12-22T10:30:00Z',
    status: 'sent'
  };

  it('renders text message correctly', () => {
    render(<MessageBubble message={mockMessage} isOwn={true} />);

    expect(screen.getByText('Hello, world!')).toBeInTheDocument();
    expect(screen.getByRole('article')).toHaveClass('message--own');
  });

  it('displays correct status icon', () => {
    const { rerender } = render(
      <MessageBubble message={{ ...mockMessage, status: 'pending' }} isOwn={true} />
    );
    expect(screen.getByLabelText('Sending')).toBeInTheDocument();

    rerender(
      <MessageBubble message={{ ...mockMessage, status: 'delivered' }} isOwn={true} />
    );
    expect(screen.getByLabelText('Delivered')).toBeInTheDocument();

    rerender(
      <MessageBubble message={{ ...mockMessage, status: 'read' }} isOwn={true} />
    );
    expect(screen.getByLabelText('Read')).toBeInTheDocument();
  });

  it('shows retry button for failed messages', async () => {
    const onRetry = jest.fn();
    render(
      <MessageBubble
        message={{ ...mockMessage, status: 'failed' }}
        isOwn={true}
        onRetry={onRetry}
      />
    );

    const retryButton = screen.getByRole('button', { name: /retry/i });
    await userEvent.click(retryButton);

    expect(onRetry).toHaveBeenCalledWith('msg-1');
  });

  it('handles long messages with word wrap', () => {
    const longMessage = {
      ...mockMessage,
      text: 'A'.repeat(1000)
    };

    render(<MessageBubble message={longMessage} isOwn={true} />);

    const messageElement = screen.getByText(/A+/);
    expect(messageElement).toHaveStyle({ wordWrap: 'break-word' });
  });

  it('escapes HTML in message text (XSS prevention)', () => {
    const xssMessage = {
      ...mockMessage,
      text: '<script>alert("xss")</script>'
    };

    render(<MessageBubble message={xssMessage} isOwn={false} />);

    // Should display as text, not execute
    expect(screen.getByText('<script>alert("xss")</script>')).toBeInTheDocument();
    expect(document.querySelector('script')).not.toBeInTheDocument();
  });
});

// __tests__/utils/encryption.test.js
describe('E2E Encryption', () => {
  it('encrypts and decrypts message correctly', async () => {
    const alice = new E2EEncryption('alice');
    const bob = new E2EEncryption('bob');

    // Exchange keys
    const aliceKeys = await alice.generateIdentity();
    const bobKeys = await bob.generateIdentity();

    await alice.establishSession('bob', bobKeys);
    await bob.establishSession('alice', aliceKeys);

    // Alice sends to Bob
    const plaintext = 'Hello, Bob!';
    const ciphertext = await alice.encryptMessage('bob', plaintext);
    const decrypted = await bob.decryptMessage('alice', ciphertext);

    expect(decrypted).toBe(plaintext);
  });

  it('provides forward secrecy (old keys cannot decrypt new messages)', async () => {
    // After key ratchet, old session keys should not work
    // ... test implementation
  });
});
```

### WebSocket Integration Tests

```jsx
// __tests__/integration/websocket.test.js
import { renderHook, act, waitFor } from '@testing-library/react';
import WS from 'jest-websocket-mock';
import { useWebSocket } from '../hooks/useWebSocket';
import { WebSocketProvider } from '../providers/WebSocketProvider';

describe('WebSocket Integration', () => {
  let server;

  beforeEach(() => {
    server = new WS('wss://chat.example.com/ws');
  });

  afterEach(() => {
    WS.clean();
  });

  it('connects and authenticates successfully', async () => {
    const { result } = renderHook(() => useWebSocket(), {
      wrapper: ({ children }) => (
        <WebSocketProvider token="valid-token">
          {children}
        </WebSocketProvider>
      )
    });

    await server.connected;

    expect(result.current.status).toBe('connected');
  });

  it('receives and processes incoming messages', async () => {
    const onMessage = jest.fn();

    renderHook(() => useWebSocket({ onMessage }), {
      wrapper: WebSocketProvider
    });

    await server.connected;

    act(() => {
      server.send(JSON.stringify({
        type: 'message',
        messageId: 'msg-123',
        chatId: 'chat-456',
        senderId: 'user-789',
        content: { type: 'text', text: 'Hello!' },
        timestamp: '2024-12-22T10:30:00Z'
      }));
    });

    await waitFor(() => {
      expect(onMessage).toHaveBeenCalledWith(
        expect.objectContaining({
          type: 'message',
          messageId: 'msg-123'
        })
      );
    });
  });

  it('sends message and receives acknowledgment', async () => {
    const { result } = renderHook(() => useWebSocket(), {
      wrapper: WebSocketProvider
    });

    await server.connected;

    // Send message
    let sendPromise;
    act(() => {
      sendPromise = result.current.sendMessage({
        chatId: 'chat-456',
        content: { type: 'text', text: 'Hello!' }
      });
    });

    // Verify message sent
    await expect(server).toReceiveMessage(
      expect.stringContaining('"type":"message"')
    );

    // Send ack
    act(() => {
      server.send(JSON.stringify({
        type: 'message_ack',
        tempId: 'temp-123',
        messageId: 'server-msg-id',
        status: 'sent'
      }));
    });

    await expect(sendPromise).resolves.toEqual({
      messageId: 'server-msg-id',
      status: 'sent'
    });
  });

  it('reconnects with exponential backoff', async () => {
    const { result } = renderHook(() => useWebSocket(), {
      wrapper: WebSocketProvider
    });

    await server.connected;

    // Simulate disconnect
    act(() => {
      server.close();
    });

    expect(result.current.status).toBe('reconnecting');

    // Create new server for reconnection
    server = new WS('wss://chat.example.com/ws');

    await waitFor(() => {
      expect(result.current.status).toBe('connected');
    }, { timeout: 5000 });
  });

  it('queues messages during disconnect', async () => {
    const { result } = renderHook(() => useWebSocket(), {
      wrapper: WebSocketProvider
    });

    await server.connected;
    server.close();

    // Send while disconnected
    act(() => {
      result.current.sendMessage({
        chatId: 'chat-456',
        content: { type: 'text', text: 'Queued message' }
      });
    });

    expect(result.current.queuedMessages).toHaveLength(1);

    // Reconnect
    server = new WS('wss://chat.example.com/ws');
    await server.connected;

    // Should send queued message
    await expect(server).toReceiveMessage(
      expect.stringContaining('Queued message')
    );
  });
});
```

### E2E Tests

```jsx
// e2e/chat.spec.ts (Playwright)
import { test, expect } from '@playwright/test';

test.describe('Chat Flow', () => {
  test.beforeEach(async ({ page }) => {
    // Login
    await page.goto('/login');
    await page.fill('[name="phone"]', '+1234567890');
    await page.click('button[type="submit"]');
    await page.fill('[name="otp"]', '123456');
    await page.click('button[type="submit"]');
    await expect(page).toHaveURL('/chats');
  });

  test('sends and receives text message', async ({ page, context }) => {
    // Open second browser for recipient
    const recipientPage = await context.newPage();
    await recipientPage.goto('/login');
    // ... login as recipient

    // Sender: Select chat and send message
    await page.click('[data-testid="chat-item-user-456"]');
    await page.fill('[data-testid="message-input"]', 'Hello from E2E test!');
    await page.click('[data-testid="send-button"]');

    // Verify message appears for sender with pending status
    const senderMessage = page.locator('[data-testid="message"]:last-child');
    await expect(senderMessage).toContainText('Hello from E2E test!');
    await expect(senderMessage.locator('[data-testid="status-pending"]')).toBeVisible();

    // Wait for sent status
    await expect(senderMessage.locator('[data-testid="status-sent"]')).toBeVisible();

    // Verify message appears for recipient
    await recipientPage.click('[data-testid="chat-item-user-123"]');
    const recipientMessage = recipientPage.locator('[data-testid="message"]:last-child');
    await expect(recipientMessage).toContainText('Hello from E2E test!');

    // Verify delivered status for sender
    await expect(senderMessage.locator('[data-testid="status-delivered"]')).toBeVisible();
  });

  test('uploads and displays image', async ({ page }) => {
    await page.click('[data-testid="chat-item-user-456"]');

    // Upload image
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('./fixtures/test-image.jpg');

    // Wait for upload
    const imageMessage = page.locator('[data-testid="message-image"]:last-child');
    await expect(imageMessage).toBeVisible();
    await expect(imageMessage.locator('img')).toHaveAttribute('src', /media\.chat\.app/);
  });

  test('shows typing indicator', async ({ page, context }) => {
    const recipientPage = await context.newPage();
    // ... setup recipient

    // Sender starts typing
    await page.click('[data-testid="chat-item-user-456"]');
    await page.type('[data-testid="message-input"]', 'Typing...');

    // Recipient should see typing indicator
    await recipientPage.click('[data-testid="chat-item-user-123"]');
    await expect(recipientPage.locator('[data-testid="typing-indicator"]'))
      .toContainText('typing');
  });

  test('works offline and syncs on reconnect', async ({ page, context }) => {
    await page.click('[data-testid="chat-item-user-456"]');

    // Go offline
    await context.setOffline(true);

    // Send message while offline
    await page.fill('[data-testid="message-input"]', 'Offline message');
    await page.click('[data-testid="send-button"]');

    // Should show pending status
    const message = page.locator('[data-testid="message"]:last-child');
    await expect(message.locator('[data-testid="status-pending"]')).toBeVisible();

    // Go back online
    await context.setOffline(false);

    // Should sync and show sent status
    await expect(message.locator('[data-testid="status-sent"]')).toBeVisible({
      timeout: 10000
    });
  });
});
```

---

## 16. Offline Support & PWA

### Service Worker Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE WORKER ARCHITECTURE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Caching Strategy:                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ASSET TYPE        â”‚  STRATEGY          â”‚  CACHE NAME               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  App Shell         â”‚  Cache First       â”‚  app-shell-v1             â”‚   â”‚
â”‚  â”‚  (HTML, JS, CSS)   â”‚                    â”‚                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  API Responses     â”‚  Network First     â”‚  api-cache-v1             â”‚   â”‚
â”‚  â”‚  (chats, messages) â”‚  (fallback cache)  â”‚                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Media (images)    â”‚  Cache First       â”‚  media-cache-v1           â”‚   â”‚
â”‚  â”‚                    â”‚  (stale-while-     â”‚                           â”‚   â”‚
â”‚  â”‚                    â”‚   revalidate)      â”‚                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  User Avatars      â”‚  Stale While       â”‚  avatar-cache-v1          â”‚   â”‚
â”‚  â”‚                    â”‚  Revalidate        â”‚                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  Offline Message Queue:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ Pending messages stored in IndexedDB                                    â”‚
â”‚  â€¢ Background Sync API for automatic retry                                 â”‚
â”‚  â€¢ Periodic sync for status updates                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Worker Implementation

```javascript
// service-worker.js
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import {
  CacheFirst,
  NetworkFirst,
  StaleWhileRevalidate
} from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';
import { BackgroundSyncPlugin } from 'workbox-background-sync';

// Precache app shell
precacheAndRoute(self.__WB_MANIFEST);

// API calls: Network first, fall back to cache
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/'),
  new NetworkFirst({
    cacheName: 'api-cache-v1',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 100,
        maxAgeSeconds: 24 * 60 * 60 // 1 day
      })
    ],
    networkTimeoutSeconds: 5
  })
);

// Media: Cache first with stale-while-revalidate
registerRoute(
  ({ url }) => url.hostname === 'media.chat.app',
  new CacheFirst({
    cacheName: 'media-cache-v1',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 500,
        maxAgeSeconds: 30 * 24 * 60 * 60 // 30 days
      })
    ]
  })
);

// Background sync for failed message sends
const messageQueue = new BackgroundSyncPlugin('message-queue', {
  maxRetentionTime: 24 * 60 // 24 hours
});

registerRoute(
  ({ url }) => url.pathname === '/api/messages',
  new NetworkOnly({
    plugins: [messageQueue]
  }),
  'POST'
);

// Handle push notifications
self.addEventListener('push', (event) => {
  const data = event.data?.json() || {};

  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: '/icons/icon-192.png',
      badge: '/icons/badge-72.png',
      tag: data.chatId, // Replace previous notification from same chat
      data: { chatId: data.chatId, messageId: data.messageId },
      actions: [
        { action: 'reply', title: 'Reply' },
        { action: 'mark-read', title: 'Mark as Read' }
      ]
    })
  );
});

// Handle notification click
self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  const { chatId } = event.notification.data;

  if (event.action === 'reply') {
    // Open chat with reply focus
    event.waitUntil(
      clients.openWindow(`/chat/${chatId}?focus=reply`)
    );
  } else {
    // Open chat
    event.waitUntil(
      clients.matchAll({ type: 'window' }).then(windowClients => {
        // Focus existing window or open new
        for (const client of windowClients) {
          if (client.url.includes('/chat') && 'focus' in client) {
            client.postMessage({ type: 'NAVIGATE_CHAT', chatId });
            return client.focus();
          }
        }
        return clients.openWindow(`/chat/${chatId}`);
      })
    );
  }
});
```

### IndexedDB Schema for Offline

```javascript
// db/ChatDatabase.js
import Dexie from 'dexie';

class ChatDatabase extends Dexie {
  constructor() {
    super('ChatApp');

    this.version(1).stores({
      // Messages table
      messages: `
        ++id,
        messageId,
        chatId,
        senderId,
        timestamp,
        status,
        [chatId+timestamp]
      `,

      // Pending sends (offline queue)
      pendingMessages: `
        ++id,
        tempId,
        chatId,
        createdAt
      `,

      // Chats/Conversations
      chats: `
        chatId,
        lastActivityAt,
        unreadCount
      `,

      // User profiles (cached)
      users: `
        userId,
        updatedAt
      `,

      // Sync metadata
      syncState: `
        key
      `
    });
  }

  // Store message (encrypted)
  async storeMessage(message, encryptionKey) {
    const encrypted = await encrypt(JSON.stringify(message), encryptionKey);
    await this.messages.put({
      messageId: message.messageId,
      chatId: message.chatId,
      senderId: message.senderId,
      timestamp: message.timestamp,
      status: message.status,
      encryptedContent: encrypted
    });
  }

  // Get messages for chat
  async getMessages(chatId, limit = 50, before = null) {
    let query = this.messages
      .where('[chatId+timestamp]')
      .between([chatId, Dexie.minKey], [chatId, before || Dexie.maxKey]);

    const messages = await query
      .reverse()
      .limit(limit)
      .toArray();

    return messages.reverse();
  }

  // Queue message for sending
  async queueMessage(message) {
    await this.pendingMessages.add({
      tempId: message.tempId,
      chatId: message.chatId,
      content: message.content,
      createdAt: Date.now()
    });
  }

  // Sync with server
  async sync(lastSyncTimestamp) {
    const response = await fetch(
      `/api/sync?since=${lastSyncTimestamp}`
    );
    const { messages, chats, syncTimestamp } = await response.json();

    await this.transaction('rw', [this.messages, this.chats, this.syncState], async () => {
      for (const message of messages) {
        await this.messages.put(message);
      }
      for (const chat of chats) {
        await this.chats.put(chat);
      }
      await this.syncState.put({ key: 'lastSync', value: syncTimestamp });
    });
  }
}

export const db = new ChatDatabase();
```

---

## 17. Media Deep Dive

### Voice Message Recording

```jsx
// components/VoiceRecorder.jsx
import { useState, useRef, useEffect } from 'react';

const VoiceRecorder = ({ onRecordComplete, onCancel }) => {
  const [isRecording, setIsRecording] = useState(false);
  const [duration, setDuration] = useState(0);
  const [waveform, setWaveform] = useState([]);

  const mediaRecorder = useRef(null);
  const audioContext = useRef(null);
  const analyser = useRef(null);
  const chunks = useRef([]);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 48000
        }
      });

      // Setup audio analysis for waveform
      audioContext.current = new AudioContext();
      const source = audioContext.current.createMediaStreamSource(stream);
      analyser.current = audioContext.current.createAnalyser();
      analyser.current.fftSize = 256;
      source.connect(analyser.current);

      // Use Opus codec for small file size
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
        ? 'audio/webm;codecs=opus'
        : 'audio/webm';

      mediaRecorder.current = new MediaRecorder(stream, { mimeType });
      chunks.current = [];

      mediaRecorder.current.ondataavailable = (e) => {
        chunks.current.push(e.data);
      };

      mediaRecorder.current.onstop = async () => {
        const blob = new Blob(chunks.current, { type: mimeType });
        const arrayBuffer = await blob.arrayBuffer();
        const audioBuffer = await audioContext.current.decodeAudioData(arrayBuffer);

        onRecordComplete({
          blob,
          duration: audioBuffer.duration,
          waveform: generateWaveformData(audioBuffer)
        });

        // Cleanup
        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.current.start(100); // Collect data every 100ms
      setIsRecording(true);

      // Update waveform visualization
      updateWaveform();

    } catch (error) {
      console.error('Failed to start recording:', error);
    }
  };

  const updateWaveform = () => {
    if (!analyser.current || !isRecording) return;

    const dataArray = new Uint8Array(analyser.current.frequencyBinCount);
    analyser.current.getByteFrequencyData(dataArray);

    // Get average amplitude
    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
    setWaveform(prev => [...prev.slice(-50), average / 255]);

    requestAnimationFrame(updateWaveform);
  };

  const stopRecording = () => {
    if (mediaRecorder.current?.state === 'recording') {
      mediaRecorder.current.stop();
      setIsRecording(false);
    }
  };

  const cancelRecording = () => {
    if (mediaRecorder.current?.state === 'recording') {
      mediaRecorder.current.stop();
      chunks.current = [];
      setIsRecording(false);
      onCancel();
    }
  };

  // Timer
  useEffect(() => {
    let interval;
    if (isRecording) {
      interval = setInterval(() => {
        setDuration(d => d + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isRecording]);

  return (
    <div className="voice-recorder">
      {isRecording ? (
        <>
          <button
            onClick={cancelRecording}
            className="cancel-btn"
            aria-label="Cancel recording"
          >
            <TrashIcon />
          </button>

          <div className="waveform">
            {waveform.map((amplitude, i) => (
              <div
                key={i}
                className="waveform-bar"
                style={{ height: `${amplitude * 100}%` }}
              />
            ))}
          </div>

          <span className="duration">
            {formatDuration(duration)}
          </span>

          <button
            onClick={stopRecording}
            className="stop-btn"
            aria-label="Stop recording and send"
          >
            <SendIcon />
          </button>
        </>
      ) : (
        <button
          onMouseDown={startRecording}
          onTouchStart={startRecording}
          className="record-btn"
          aria-label="Hold to record voice message"
        >
          <MicrophoneIcon />
        </button>
      )}
    </div>
  );
};
```

### Video Calling (WebRTC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VIDEO CALLING ARCHITECTURE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  WebRTC Flow:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚                                                                              â”‚
â”‚   Caller (Alice)              Signaling Server            Callee (Bob)      â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚  1. Create Offer           â”‚                          â”‚            â”‚
â”‚        â”‚  (SDP with codec info)     â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚â”€â”€â”€â”€â”€ Send Offer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€ Forward Offer â”€â”€â”€â”€â”€>â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚                            â”‚                    2. Create Answer   â”‚
â”‚        â”‚                            â”‚                                       â”‚
â”‚        â”‚<â”€â”€â”€â”€ Forward Answer â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€ Send Answer â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚  3. Exchange ICE Candidates                          â”‚            â”‚
â”‚        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
â”‚        â”‚                            â”‚                          â”‚            â”‚
â”‚        â”‚  4. Peer-to-Peer Connection Established              â”‚            â”‚
â”‚        â”‚<==================================================>â”‚            â”‚
â”‚        â”‚           (Video/Audio streams directly)             â”‚            â”‚
â”‚                                                                              â”‚
â”‚  STUN/TURN Servers:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â€¢ STUN: Discover public IP (for NAT traversal)                            â”‚
â”‚  â€¢ TURN: Relay when direct P2P fails (10-20% of calls)                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```jsx
// hooks/useVideoCall.js
const useVideoCall = (userId, onCallEnd) => {
  const [callState, setCallState] = useState('idle'); // idle, ringing, connected
  const [localStream, setLocalStream] = useState(null);
  const [remoteStream, setRemoteStream] = useState(null);

  const peerConnection = useRef(null);
  const { sendSignal, onSignal } = useWebSocket();

  const configuration = {
    iceServers: [
      { urls: 'stun:stun.chat.app:3478' },
      {
        urls: 'turn:turn.chat.app:3478',
        username: 'user',
        credential: 'pass'
      }
    ]
  };

  const startCall = async (isVideo = true) => {
    try {
      // Get local media
      const stream = await navigator.mediaDevices.getUserMedia({
        video: isVideo ? {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'user'
        } : false,
        audio: {
          echoCancellation: true,
          noiseSuppression: true
        }
      });

      setLocalStream(stream);

      // Create peer connection
      peerConnection.current = new RTCPeerConnection(configuration);

      // Add local tracks
      stream.getTracks().forEach(track => {
        peerConnection.current.addTrack(track, stream);
      });

      // Handle remote tracks
      peerConnection.current.ontrack = (event) => {
        setRemoteStream(event.streams[0]);
      };

      // ICE candidates
      peerConnection.current.onicecandidate = (event) => {
        if (event.candidate) {
          sendSignal({
            type: 'ice-candidate',
            candidate: event.candidate,
            to: userId
          });
        }
      };

      // Create and send offer
      const offer = await peerConnection.current.createOffer();
      await peerConnection.current.setLocalDescription(offer);

      sendSignal({
        type: 'call-offer',
        sdp: offer,
        to: userId,
        isVideo
      });

      setCallState('ringing');

    } catch (error) {
      console.error('Failed to start call:', error);
    }
  };

  const answerCall = async (offer, isVideo) => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: isVideo,
        audio: true
      });

      setLocalStream(stream);

      peerConnection.current = new RTCPeerConnection(configuration);

      stream.getTracks().forEach(track => {
        peerConnection.current.addTrack(track, stream);
      });

      peerConnection.current.ontrack = (event) => {
        setRemoteStream(event.streams[0]);
      };

      peerConnection.current.onicecandidate = (event) => {
        if (event.candidate) {
          sendSignal({
            type: 'ice-candidate',
            candidate: event.candidate,
            to: userId
          });
        }
      };

      await peerConnection.current.setRemoteDescription(offer);
      const answer = await peerConnection.current.createAnswer();
      await peerConnection.current.setLocalDescription(answer);

      sendSignal({
        type: 'call-answer',
        sdp: answer,
        to: userId
      });

      setCallState('connected');

    } catch (error) {
      console.error('Failed to answer call:', error);
    }
  };

  const endCall = () => {
    localStream?.getTracks().forEach(track => track.stop());
    peerConnection.current?.close();
    setLocalStream(null);
    setRemoteStream(null);
    setCallState('idle');
    onCallEnd();
  };

  const toggleMute = () => {
    const audioTrack = localStream?.getAudioTracks()[0];
    if (audioTrack) {
      audioTrack.enabled = !audioTrack.enabled;
    }
  };

  const toggleVideo = () => {
    const videoTrack = localStream?.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.enabled = !videoTrack.enabled;
    }
  };

  // Handle incoming signals
  useEffect(() => {
    const handleSignal = async (signal) => {
      switch (signal.type) {
        case 'call-answer':
          await peerConnection.current.setRemoteDescription(signal.sdp);
          setCallState('connected');
          break;

        case 'ice-candidate':
          await peerConnection.current.addIceCandidate(signal.candidate);
          break;

        case 'call-end':
          endCall();
          break;
      }
    };

    return onSignal(handleSignal);
  }, []);

  return {
    callState,
    localStream,
    remoteStream,
    startCall,
    answerCall,
    endCall,
    toggleMute,
    toggleVideo
  };
};
```

---

## 18. Internationalization (i18n)

### RTL Support

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RTL (RIGHT-TO-LEFT) SUPPORT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Languages Requiring RTL:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  â€¢ Arabic (ar)                                                              â”‚
â”‚  â€¢ Hebrew (he)                                                              â”‚
â”‚  â€¢ Persian/Farsi (fa)                                                       â”‚
â”‚  â€¢ Urdu (ur)                                                                â”‚
â”‚                                                                              â”‚
â”‚  CSS Logical Properties:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  âŒ Old (doesn't flip):           âœ… New (auto-flips):                     â”‚
â”‚     margin-left: 10px;               margin-inline-start: 10px;             â”‚
â”‚     padding-right: 20px;             padding-inline-end: 20px;              â”‚
â”‚     text-align: left;                text-align: start;                     â”‚
â”‚     left: 0;                         inset-inline-start: 0;                 â”‚
â”‚                                                                              â”‚
â”‚  Message Bubble Layout:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚                                                                              â”‚
â”‚  LTR Mode:                         RTL Mode:                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚         [Received msg] â”‚       â”‚ [Received msg]         â”‚               â”‚
â”‚  â”‚ [Sent msg]             â”‚       â”‚             [Sent msg] â”‚               â”‚
â”‚  â”‚         [Received msg] â”‚       â”‚ [Received msg]         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â”‚  Implementation:                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  .message-bubble {                                                          â”‚
â”‚    /* Auto-flip based on dir attribute */                                  â”‚
â”‚    margin-inline-start: auto;                                              â”‚
â”‚    border-start-start-radius: 16px;                                        â”‚
â”‚    border-start-end-radius: 16px;                                          â”‚
â”‚    border-end-start-radius: 4px;                                           â”‚
â”‚    border-end-end-radius: 16px;                                            â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  .message-bubble--own {                                                     â”‚
â”‚    margin-inline-start: auto;                                              â”‚
â”‚    margin-inline-end: 0;                                                   â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â”‚  .message-bubble--other {                                                   â”‚
â”‚    margin-inline-start: 0;                                                 â”‚
â”‚    margin-inline-end: auto;                                                â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### i18n Implementation

```jsx
// i18n/setup.js
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

const resources = {
  en: {
    translation: {
      chat: {
        typing: '{{name}} is typing...',
        typingMultiple: '{{count}} people are typing...',
        online: 'Online',
        offline: 'Offline',
        lastSeen: 'Last seen {{time}}',
        messageStatus: {
          pending: 'Sending',
          sent: 'Sent',
          delivered: 'Delivered',
          read: 'Read'
        },
        input: {
          placeholder: 'Type a message',
          send: 'Send'
        }
      },
      time: {
        justNow: 'Just now',
        minutesAgo: '{{count}} minute ago',
        minutesAgo_plural: '{{count}} minutes ago',
        today: 'Today',
        yesterday: 'Yesterday'
      }
    }
  },
  ar: {
    translation: {
      chat: {
        typing: '{{name}} ÙŠÙƒØªØ¨...',
        typingMultiple: '{{count}} Ø£Ø´Ø®Ø§Øµ ÙŠÙƒØªØ¨ÙˆÙ†...',
        online: 'Ù…ØªØµÙ„',
        offline: 'ØºÙŠØ± Ù…ØªØµÙ„',
        lastSeen: 'Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± {{time}}',
        messageStatus: {
          pending: 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
          sent: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
          delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
          read: 'ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'
        },
        input: {
          placeholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©',
          send: 'Ø¥Ø±Ø³Ø§Ù„'
        }
      }
    }
  }
};

i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    resources,
    fallbackLng: 'en',
    interpolation: {
      escapeValue: false
    }
  });

// Set document direction based on language
i18n.on('languageChanged', (lng) => {
  const rtlLanguages = ['ar', 'he', 'fa', 'ur'];
  document.documentElement.dir = rtlLanguages.includes(lng) ? 'rtl' : 'ltr';
  document.documentElement.lang = lng;
});

export default i18n;
```

### Date/Time Localization

```jsx
// utils/dateFormatter.js
const formatMessageTime = (timestamp, locale) => {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  // Relative time for recent messages
  const rtf = new Intl.RelativeTimeFormat(locale, { numeric: 'auto' });

  if (diffMins < 1) {
    return i18n.t('time.justNow');
  }
  if (diffMins < 60) {
    return rtf.format(-diffMins, 'minute');
  }
  if (diffHours < 24 && date.getDate() === now.getDate()) {
    return new Intl.DateTimeFormat(locale, {
      hour: 'numeric',
      minute: 'numeric'
    }).format(date);
  }
  if (diffDays === 1) {
    return i18n.t('time.yesterday');
  }
  if (diffDays < 7) {
    return new Intl.DateTimeFormat(locale, {
      weekday: 'long'
    }).format(date);
  }

  return new Intl.DateTimeFormat(locale, {
    day: 'numeric',
    month: 'short',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
  }).format(date);
};

// Date separator in message list
const formatDateSeparator = (timestamp, locale) => {
  const date = new Date(timestamp);
  const now = new Date();

  if (isSameDay(date, now)) {
    return i18n.t('time.today');
  }
  if (isSameDay(date, new Date(now - 86400000))) {
    return i18n.t('time.yesterday');
  }

  return new Intl.DateTimeFormat(locale, {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
  }).format(date);
};
```

---

## 19. Analytics & Observability

### Frontend Metrics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND OBSERVABILITY                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Key Metrics to Track:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                              â”‚
â”‚  Performance Metrics:                                                       â”‚
â”‚  â€¢ Message send latency (user click â†’ server ack)                          â”‚
â”‚  â€¢ Message receive latency (server send â†’ UI render)                       â”‚
â”‚  â€¢ WebSocket connection time                                                â”‚
â”‚  â€¢ Time to first message displayed                                         â”‚
â”‚  â€¢ Image/media load time                                                    â”‚
â”‚  â€¢ Scroll performance (FPS during scroll)                                  â”‚
â”‚                                                                              â”‚
â”‚  Reliability Metrics:                                                       â”‚
â”‚  â€¢ WebSocket disconnect frequency                                          â”‚
â”‚  â€¢ Reconnection success rate                                               â”‚
â”‚  â€¢ Message delivery failure rate                                           â”‚
â”‚  â€¢ Offline queue size                                                       â”‚
â”‚                                                                              â”‚
â”‚  User Experience Metrics:                                                   â”‚
â”‚  â€¢ Time spent typing before send                                           â”‚
â”‚  â€¢ Messages per session                                                     â”‚
â”‚  â€¢ Chat switch frequency                                                    â”‚
â”‚  â€¢ Feature usage (voice, video, media)                                     â”‚
â”‚                                                                              â”‚
â”‚  Error Metrics:                                                             â”‚
â”‚  â€¢ JavaScript errors by type                                               â”‚
â”‚  â€¢ Encryption failures                                                      â”‚
â”‚  â€¢ Media upload failures                                                    â”‚
â”‚  â€¢ API error rates                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Analytics Implementation

```jsx
// analytics/ChatAnalytics.js
class ChatAnalytics {
  constructor() {
    this.sessionId = generateUUID();
    this.messageTimings = new Map();
  }

  // Track message send latency
  startMessageSend(tempId) {
    this.messageTimings.set(tempId, {
      startTime: performance.now(),
      status: 'pending'
    });
  }

  messageAcked(tempId, serverId) {
    const timing = this.messageTimings.get(tempId);
    if (timing) {
      const latency = performance.now() - timing.startTime;
      this.track('message_sent', {
        latency,
        messageId: serverId
      });
      this.messageTimings.delete(tempId);
    }
  }

  messageFailed(tempId, error) {
    const timing = this.messageTimings.get(tempId);
    if (timing) {
      this.track('message_failed', {
        latency: performance.now() - timing.startTime,
        error: error.message
      });
    }
  }

  // Track WebSocket health
  trackWebSocketEvent(event, data = {}) {
    this.track(`ws_${event}`, {
      ...data,
      timestamp: Date.now()
    });
  }

  // Track user interactions
  trackChatOpened(chatId) {
    this.track('chat_opened', { chatId });
  }

  trackMediaShared(type, size) {
    this.track('media_shared', { type, size });
  }

  trackVoiceMessageRecorded(duration) {
    this.track('voice_message_recorded', { duration });
  }

  // Core tracking method
  track(event, properties = {}) {
    const payload = {
      event,
      properties: {
        ...properties,
        sessionId: this.sessionId,
        timestamp: Date.now(),
        platform: 'web',
        userAgent: navigator.userAgent
      }
    };

    // Send to analytics service
    if (navigator.sendBeacon) {
      navigator.sendBeacon('/api/analytics', JSON.stringify(payload));
    } else {
      fetch('/api/analytics', {
        method: 'POST',
        body: JSON.stringify(payload),
        keepalive: true
      });
    }
  }
}

export const analytics = new ChatAnalytics();
```

### Error Tracking

```jsx
// monitoring/ErrorBoundary.jsx
import * as Sentry from '@sentry/react';

class ChatErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    Sentry.captureException(error, {
      extra: {
        componentStack: errorInfo.componentStack,
        chatId: this.props.chatId
      }
    });
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="error-fallback">
          <h2>Something went wrong</h2>
          <p>We're having trouble loading this chat.</p>
          <button onClick={() => window.location.reload()}>
            Refresh
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

// Global error handler
window.addEventListener('error', (event) => {
  Sentry.captureException(event.error, {
    extra: {
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno
    }
  });
});

// Unhandled promise rejections
window.addEventListener('unhandledrejection', (event) => {
  Sentry.captureException(event.reason, {
    tags: { type: 'unhandled_promise' }
  });
});
```

---

## 20. Notification System

### Web Push Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEB PUSH NOTIFICATION FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Browser              App Server           Push Service         Browser    â”‚
â”‚   (Tab open)                                (FCM/VAPID)          (Tab closed)â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚ 1. Request         â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚    permission      â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚ 2. Subscribe to    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚    push service    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚ 3. Get subscriptionâ”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚    (endpoint + key)â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚ 4. Send subscription                    â”‚                    â”‚     â”‚
â”‚       â”‚    to app server   â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚ 5. Store subscription                   â”‚     â”‚
â”‚       â”‚                    â”‚    (user â†’ endpoint)                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚   â”€â”€â”€ Later: New message for user â”€â”€â”€   â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚ 6. Push message     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚ 7. Deliver to      â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    Service Worker  â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚                    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    8. Show         â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    notification    â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    â”‚ New msg   â”‚   â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    â”‚ from John â”‚   â”‚     â”‚
â”‚       â”‚                    â”‚                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Push Subscription Management

```jsx
// notifications/PushManager.js
class PushNotificationManager {
  constructor() {
    this.vapidPublicKey = 'YOUR_VAPID_PUBLIC_KEY';
  }

  async requestPermission() {
    const permission = await Notification.requestPermission();

    if (permission === 'granted') {
      await this.subscribe();
    }

    return permission;
  }

  async subscribe() {
    try {
      const registration = await navigator.serviceWorker.ready;

      // Check existing subscription
      let subscription = await registration.pushManager.getSubscription();

      if (!subscription) {
        subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true, // Required by Chrome
          applicationServerKey: this.urlBase64ToUint8Array(this.vapidPublicKey)
        });
      }

      // Send subscription to server
      await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          endpoint: subscription.endpoint,
          keys: {
            p256dh: btoa(String.fromCharCode(...new Uint8Array(
              subscription.getKey('p256dh')
            ))),
            auth: btoa(String.fromCharCode(...new Uint8Array(
              subscription.getKey('auth')
            )))
          }
        })
      });

      return subscription;
    } catch (error) {
      console.error('Push subscription failed:', error);
      throw error;
    }
  }

  async unsubscribe() {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();

    if (subscription) {
      await subscription.unsubscribe();
      await fetch('/api/push/unsubscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ endpoint: subscription.endpoint })
      });
    }
  }

  urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
      .replace(/-/g, '+')
      .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }

    return outputArray;
  }
}

export const pushManager = new PushNotificationManager();
```

### Desktop Notification with Actions

```jsx
// notifications/DesktopNotification.js
class DesktopNotificationManager {
  constructor() {
    this.notificationSound = new Audio('/sounds/message.mp3');
    this.enabled = true;
  }

  async showMessageNotification(message) {
    if (!this.enabled || document.hasFocus()) {
      return; // Don't show if app is focused
    }

    // Check permission
    if (Notification.permission !== 'granted') {
      return;
    }

    // Play sound (respecting user preference)
    if (this.soundEnabled) {
      this.notificationSound.play().catch(() => {});
    }

    // Create notification
    const notification = new Notification(message.senderName, {
      body: this.getNotificationBody(message),
      icon: message.senderAvatar || '/icons/default-avatar.png',
      badge: '/icons/badge.png',
      tag: message.chatId, // Replace previous from same chat
      timestamp: new Date(message.timestamp).getTime(),
      requireInteraction: false,
      silent: true // We handle sound ourselves
    });

    notification.onclick = () => {
      window.focus();
      navigateToChat(message.chatId);
      notification.close();
    };

    // Auto-close after 5 seconds
    setTimeout(() => notification.close(), 5000);
  }

  getNotificationBody(message) {
    switch (message.content.type) {
      case 'text':
        return message.content.text.substring(0, 100);
      case 'image':
        return 'ðŸ“· Photo';
      case 'video':
        return 'ðŸŽ¥ Video';
      case 'voice':
        return 'ðŸŽ¤ Voice message';
      case 'document':
        return `ðŸ“„ ${message.content.fileName}`;
      default:
        return 'New message';
    }
  }

  // Do Not Disturb support
  setDoNotDisturb(enabled) {
    this.enabled = !enabled;
    if (enabled) {
      this.soundEnabled = false;
    }
  }

  // Schedule DND
  scheduleDND(startHour, endHour) {
    const checkDND = () => {
      const hour = new Date().getHours();
      const inDNDWindow = startHour <= hour && hour < endHour;
      this.setDoNotDisturb(inDNDWindow);
    };

    checkDND();
    setInterval(checkDND, 60000); // Check every minute
  }
}

export const notificationManager = new DesktopNotificationManager();
```

---

## 21. Advanced Message Features

### Message Reactions

```jsx
// components/MessageReactions.jsx
const REACTION_EMOJIS = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];

const MessageReactions = ({ messageId, reactions, onReact }) => {
  const [showPicker, setShowPicker] = useState(false);
  const currentUserId = useCurrentUser().id;

  // Group reactions by emoji
  const groupedReactions = useMemo(() => {
    const groups = {};
    reactions.forEach(reaction => {
      if (!groups[reaction.emoji]) {
        groups[reaction.emoji] = [];
      }
      groups[reaction.emoji].push(reaction.userId);
    });
    return groups;
  }, [reactions]);

  const handleReact = async (emoji) => {
    const existingReaction = reactions.find(
      r => r.userId === currentUserId && r.emoji === emoji
    );

    if (existingReaction) {
      // Remove reaction
      await onReact(messageId, emoji, 'remove');
    } else {
      // Add reaction
      await onReact(messageId, emoji, 'add');
    }

    setShowPicker(false);
  };

  return (
    <div className="message-reactions">
      {/* Display existing reactions */}
      <div className="reaction-bubbles">
        {Object.entries(groupedReactions).map(([emoji, userIds]) => (
          <button
            key={emoji}
            className={`reaction-bubble ${
              userIds.includes(currentUserId) ? 'reaction-bubble--own' : ''
            }`}
            onClick={() => handleReact(emoji)}
            aria-label={`${emoji} reaction by ${userIds.length} people`}
          >
            <span className="emoji">{emoji}</span>
            <span className="count">{userIds.length}</span>
          </button>
        ))}
      </div>

      {/* Add reaction button */}
      <div className="add-reaction">
        <button
          className="add-reaction-btn"
          onClick={() => setShowPicker(!showPicker)}
          aria-label="Add reaction"
          aria-expanded={showPicker}
        >
          <SmileIcon />
        </button>

        {showPicker && (
          <div
            className="reaction-picker"
            role="menu"
            aria-label="Choose reaction"
          >
            {REACTION_EMOJIS.map(emoji => (
              <button
                key={emoji}
                className="reaction-option"
                onClick={() => handleReact(emoji)}
                role="menuitem"
              >
                {emoji}
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};
```

### Reply Threading

```jsx
// components/ReplyPreview.jsx
const ReplyPreview = ({ replyToMessage, onClearReply }) => {
  return (
    <div className="reply-preview" role="status">
      <div className="reply-preview__indicator" />

      <div className="reply-preview__content">
        <span className="reply-preview__sender">
          {replyToMessage.senderName}
        </span>
        <span className="reply-preview__text">
          {getMessagePreview(replyToMessage)}
        </span>
      </div>

      <button
        className="reply-preview__close"
        onClick={onClearReply}
        aria-label="Cancel reply"
      >
        <CloseIcon />
      </button>
    </div>
  );
};

// In MessageBubble - show quoted message
const QuotedMessage = ({ quotedMessage, onClick }) => {
  return (
    <button
      className="quoted-message"
      onClick={() => onClick(quotedMessage.id)}
      aria-label={`Quoted message from ${quotedMessage.senderName}`}
    >
      <div className="quoted-message__indicator" />
      <div className="quoted-message__content">
        <span className="quoted-message__sender">
          {quotedMessage.senderName}
        </span>
        <span className="quoted-message__text">
          {getMessagePreview(quotedMessage)}
        </span>
      </div>
    </button>
  );
};

// Scroll to quoted message
const useScrollToMessage = (messageListRef) => {
  const scrollToMessage = useCallback((messageId) => {
    const messageElement = messageListRef.current?.querySelector(
      `[data-message-id="${messageId}"]`
    );

    if (messageElement) {
      messageElement.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });

      // Highlight briefly
      messageElement.classList.add('message--highlighted');
      setTimeout(() => {
        messageElement.classList.remove('message--highlighted');
      }, 2000);
    }
  }, [messageListRef]);

  return scrollToMessage;
};
```

### Message Starring/Bookmarking

```jsx
// hooks/useStarredMessages.js
const useStarredMessages = () => {
  const queryClient = useQueryClient();

  const { data: starredMessages } = useQuery({
    queryKey: ['starredMessages'],
    queryFn: () => fetch('/api/messages/starred').then(r => r.json())
  });

  const starMutation = useMutation({
    mutationFn: ({ messageId, starred }) =>
      fetch(`/api/messages/${messageId}/star`, {
        method: starred ? 'POST' : 'DELETE'
      }),
    onMutate: async ({ messageId, starred }) => {
      // Optimistic update
      await queryClient.cancelQueries(['starredMessages']);

      const previous = queryClient.getQueryData(['starredMessages']);

      queryClient.setQueryData(['starredMessages'], old => {
        if (starred) {
          return [...(old || []), { messageId, starredAt: Date.now() }];
        } else {
          return (old || []).filter(m => m.messageId !== messageId);
        }
      });

      return { previous };
    },
    onError: (err, variables, context) => {
      queryClient.setQueryData(['starredMessages'], context.previous);
    }
  });

  const isStarred = useCallback((messageId) => {
    return starredMessages?.some(m => m.messageId === messageId);
  }, [starredMessages]);

  const toggleStar = useCallback((messageId) => {
    starMutation.mutate({
      messageId,
      starred: !isStarred(messageId)
    });
  }, [isStarred, starMutation]);

  return { starredMessages, isStarred, toggleStar };
};
```

### Message Forwarding

```jsx
// components/ForwardModal.jsx
const ForwardModal = ({ message, isOpen, onClose }) => {
  const [selectedChats, setSelectedChats] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const { sendMessage } = useWebSocket();

  const { data: chats } = useQuery({
    queryKey: ['chats'],
    enabled: isOpen
  });

  const filteredChats = useMemo(() => {
    if (!searchQuery) return chats;
    return chats?.filter(chat =>
      chat.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [chats, searchQuery]);

  const handleForward = async () => {
    for (const chatId of selectedChats) {
      await sendMessage({
        chatId,
        content: message.content,
        forwardedFrom: {
          messageId: message.id,
          chatId: message.chatId,
          senderName: message.senderName
        }
      });
    }

    onClose();
  };

  if (!isOpen) return null;

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      aria-labelledby="forward-modal-title"
    >
      <h2 id="forward-modal-title">Forward Message</h2>

      <div className="forward-preview">
        <MessagePreview message={message} />
      </div>

      <input
        type="search"
        placeholder="Search chats..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        aria-label="Search chats to forward to"
      />

      <ul className="chat-select-list" role="listbox" aria-multiselectable="true">
        {filteredChats?.map(chat => (
          <li
            key={chat.id}
            role="option"
            aria-selected={selectedChats.includes(chat.id)}
            onClick={() => {
              setSelectedChats(prev =>
                prev.includes(chat.id)
                  ? prev.filter(id => id !== chat.id)
                  : [...prev, chat.id]
              );
            }}
            className={selectedChats.includes(chat.id) ? 'selected' : ''}
          >
            <Avatar src={chat.avatar} name={chat.name} />
            <span>{chat.name}</span>
            {selectedChats.includes(chat.id) && <CheckIcon />}
          </li>
        ))}
      </ul>

      <div className="modal-actions">
        <button onClick={onClose}>Cancel</button>
        <button
          onClick={handleForward}
          disabled={selectedChats.length === 0}
        >
          Forward to {selectedChats.length} chat{selectedChats.length !== 1 ? 's' : ''}
        </button>
      </div>
    </Modal>
  );
};
```

---

## Quick Reference Cheat Sheet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         QUICK REFERENCE                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Protocol Choice:                                                           â”‚
â”‚  â€¢ Real-time messaging â†’ WebSocket (MUST)                                   â”‚
â”‚  â€¢ History fetch â†’ REST                                                     â”‚
â”‚  â€¢ Media upload â†’ REST + Presigned URLs                                    â”‚
â”‚  â€¢ NOT: Long polling (too inefficient)                                      â”‚
â”‚                                                                              â”‚
â”‚  Database Choice:                                                           â”‚
â”‚  â€¢ Messages â†’ Cassandra (write scale)                                       â”‚
â”‚  â€¢ Users, Auth â†’ PostgreSQL (ACID)                                         â”‚
â”‚  â€¢ Cache, Presence, Pub/Sub â†’ Redis                                        â”‚
â”‚  â€¢ Search â†’ Elasticsearch                                                   â”‚
â”‚  â€¢ Media â†’ S3 + CDN                                                         â”‚
â”‚                                                                              â”‚
â”‚  Real-time Features:                                                        â”‚
â”‚  â€¢ Messages â†’ WebSocket                                                     â”‚
â”‚  â€¢ Typing â†’ WebSocket + Debounce                                           â”‚
â”‚  â€¢ Presence â†’ Redis + TTL + Pub/Sub                                        â”‚
â”‚  â€¢ Delivery/Read receipts â†’ WebSocket                                      â”‚
â”‚                                                                              â”‚
â”‚  Offline Support:                                                           â”‚
â”‚  â€¢ IndexedDB for message storage                                           â”‚
â”‚  â€¢ Queue sends locally                                                      â”‚
â”‚  â€¢ Sync on reconnect                                                        â”‚
â”‚                                                                              â”‚
â”‚  State Management:                                                          â”‚
â”‚  â€¢ WebSocket â†’ Custom provider                                              â”‚
â”‚  â€¢ Server state â†’ React Query                                               â”‚
â”‚  â€¢ Real-time state â†’ Zustand                                                â”‚
â”‚  â€¢ Persistence â†’ IndexedDB                                                  â”‚
â”‚                                                                              â”‚
â”‚  Performance:                                                               â”‚
â”‚  â€¢ Virtualize message list                                                  â”‚
â”‚  â€¢ Optimistic updates                                                       â”‚
â”‚  â€¢ Lazy load media                                                          â”‚
â”‚  â€¢ Debounce typing                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
